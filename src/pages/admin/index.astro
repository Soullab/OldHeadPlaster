---
import AdminLayout from '../../layouts/AdminLayout.astro';

const statusColors = {
  active: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
  pending: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
  completed: 'bg-blue-500/20 text-blue-400 border-blue-500/30'
};
---

<AdminLayout title="Dashboard" currentPage="dashboard">
  <!-- Stats Overview -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-charcoal-light border border-charcoal-border rounded-lg p-6">
      <div class="flex items-center justify-between mb-2">
        <span class="text-cream/50 text-sm">Active Projects</span>
        <span class="text-emerald-400">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
          </svg>
        </span>
      </div>
      <div id="active-projects-count" class="text-3xl font-semibold text-cream">0</div>
      <div id="total-sqft" class="text-xs text-cream/40 mt-1">0 sq ft total</div>
    </div>

    <div class="bg-charcoal-light border border-charcoal-border rounded-lg p-6">
      <div class="flex items-center justify-between mb-2">
        <span class="text-cream/50 text-sm">Messages</span>
        <span class="text-brass">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </span>
      </div>
      <div id="unread-messages-count" class="text-3xl font-semibold text-cream">0</div>
      <div class="text-xs text-cream/40 mt-1">Unread this week</div>
    </div>

    <div class="bg-charcoal-light border border-charcoal-border rounded-lg p-6">
      <div class="flex items-center justify-between mb-2">
        <span class="text-cream/50 text-sm">Stakeholders</span>
        <span class="text-blue-400">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </span>
      </div>
      <div id="stakeholders-count" class="text-3xl font-semibold text-cream">0</div>
      <div class="text-xs text-cream/40 mt-1">Across all projects</div>
    </div>

    <div class="bg-charcoal-light border border-charcoal-border rounded-lg p-6">
      <div class="flex items-center justify-between mb-2">
        <span class="text-cream/50 text-sm">This Week</span>
        <span class="text-purple-400">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </span>
      </div>
      <div id="events-count" class="text-3xl font-semibold text-cream">0</div>
      <div class="text-xs text-cream/40 mt-1">Scheduled meetings</div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Projects -->
    <div class="lg:col-span-2 space-y-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-medium text-cream">Active Projects</h2>
        <a href="/admin/projects" class="text-sm text-brass hover:text-brass-light transition-colors">View all</a>
      </div>

      <div id="projects-list" class="space-y-4">
        <!-- Projects rendered by JavaScript -->
      </div>

      <div id="no-projects" class="hidden text-center py-12 bg-charcoal-light border border-charcoal-border rounded-lg">
        <p class="text-cream/50 mb-4">No active projects</p>
        <a href="/admin/projects" class="px-4 py-2 bg-brass text-charcoal text-sm font-medium rounded-lg hover:bg-brass-light transition-colors inline-block">
          Create Project
        </a>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="space-y-8">
      <!-- Recent Messages -->
      <div>
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-medium text-cream">Messages</h2>
          <a href="/admin/messages" class="text-sm text-brass hover:text-brass-light transition-colors">View all</a>
        </div>

        <div id="messages-list" class="bg-charcoal-light border border-charcoal-border rounded-lg divide-y divide-charcoal-border">
          <!-- Messages rendered by JavaScript -->
        </div>

        <div id="no-messages" class="hidden bg-charcoal-light border border-charcoal-border rounded-lg p-6 text-center">
          <p class="text-cream/50 text-sm">No recent messages</p>
        </div>
      </div>

      <!-- Upcoming Events -->
      <div>
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-medium text-cream">Upcoming</h2>
          <a href="/admin/schedule" class="text-sm text-brass hover:text-brass-light transition-colors">Calendar</a>
        </div>

        <div id="events-list" class="bg-charcoal-light border border-charcoal-border rounded-lg divide-y divide-charcoal-border">
          <!-- Events rendered by JavaScript -->
        </div>

        <div id="no-events" class="hidden bg-charcoal-light border border-charcoal-border rounded-lg p-6 text-center">
          <p class="text-cream/50 text-sm">No upcoming events</p>
        </div>
      </div>

      <!-- Quick Actions -->
      <div>
        <h2 class="text-lg font-medium text-cream mb-4">Quick Actions</h2>
        <div class="space-y-2">
          <a href="/admin/projects" class="flex items-center gap-3 p-4 bg-charcoal-light border border-charcoal-border rounded-lg hover:border-brass/30 transition-colors">
            <span class="w-10 h-10 rounded-lg bg-brass/10 flex items-center justify-center">
              <svg class="w-5 h-5 text-brass" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4" />
              </svg>
            </span>
            <div>
              <p class="text-sm text-cream font-medium">New Project</p>
              <p class="text-xs text-cream/40">Start a new bespoke project</p>
            </div>
          </a>

          <a href="/admin/messages" class="flex items-center gap-3 p-4 bg-charcoal-light border border-charcoal-border rounded-lg hover:border-brass/30 transition-colors">
            <span class="w-10 h-10 rounded-lg bg-brass/10 flex items-center justify-center">
              <svg class="w-5 h-5 text-brass" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
              </svg>
            </span>
            <div>
              <p class="text-sm text-cream font-medium">Send Update</p>
              <p class="text-xs text-cream/40">Email or SMS stakeholders</p>
            </div>
          </a>

          <a href="/admin/documents" class="flex items-center gap-3 p-4 bg-charcoal-light border border-charcoal-border rounded-lg hover:border-brass/30 transition-colors">
            <span class="w-10 h-10 rounded-lg bg-brass/10 flex items-center justify-center">
              <svg class="w-5 h-5 text-brass" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
              </svg>
            </span>
            <div>
              <p class="text-sm text-cream font-medium">Upload Document</p>
              <p class="text-xs text-cream/40">Share specs or photos</p>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script define:vars={{ statusColors }}>
  const PROJECTS_KEY = 'oldhead_projects';
  const MESSAGES_KEY = 'oldhead_messages';
  const EVENTS_KEY = 'oldhead_events';

  function getProjects() {
    const stored = localStorage.getItem(PROJECTS_KEY);
    return stored ? JSON.parse(stored) : [];
  }

  function getMessages() {
    const stored = localStorage.getItem(MESSAGES_KEY);
    return stored ? JSON.parse(stored) : [];
  }

  function getEvents() {
    const stored = localStorage.getItem(EVENTS_KEY);
    return stored ? JSON.parse(stored) : [];
  }

  function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function formatEventDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);

    if (date.toDateString() === today.toDateString()) {
      return 'Today';
    } else if (date.toDateString() === tomorrow.toDateString()) {
      return 'Tomorrow';
    } else {
      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }
  }

  function getWeekEvents() {
    const events = getEvents();
    const now = new Date();
    const weekFromNow = new Date(now);
    weekFromNow.setDate(weekFromNow.getDate() + 7);

    return events.filter(e => {
      const eventDate = new Date(e.date);
      return eventDate >= now && eventDate <= weekFromNow;
    }).sort((a, b) => new Date(a.date) - new Date(b.date));
  }

  function getUnreadCount() {
    const messages = getMessages();
    return messages.filter(m => !m.read && m.folder === 'inbox').length;
  }

  function getStakeholdersCount() {
    const projects = getProjects();
    const members = new Set();
    projects.forEach(p => {
      (p.team || []).forEach(m => members.add(m.name));
    });
    return members.size;
  }

  const phaseColors = {
    'Design Phase': 'text-purple-400',
    'Sampling Phase': 'text-amber-400',
    'Preparation Phase': 'text-blue-400',
    'Application Phase': 'text-emerald-400',
    'Completion Phase': 'text-brass',
    'Completed': 'text-cream/50'
  };

  function renderDashboard() {
    const projects = getProjects();
    const messages = getMessages();
    const weekEvents = getWeekEvents();

    // Update stats
    const activeProjects = projects.filter(p => p.status === 'active');
    document.getElementById('active-projects-count').textContent = activeProjects.length;
    const totalSqft = projects.reduce((sum, p) => sum + (p.sqft || 0), 0);
    document.getElementById('total-sqft').textContent = `${totalSqft.toLocaleString()} sq ft total`;
    document.getElementById('unread-messages-count').textContent = getUnreadCount();
    document.getElementById('stakeholders-count').textContent = getStakeholdersCount();
    document.getElementById('events-count').textContent = weekEvents.length;

    // Render projects
    const projectsList = document.getElementById('projects-list');
    const noProjects = document.getElementById('no-projects');
    const displayProjects = projects.filter(p => p.status !== 'completed').slice(0, 3);

    if (displayProjects.length === 0) {
      projectsList.classList.add('hidden');
      noProjects.classList.remove('hidden');
    } else {
      projectsList.classList.remove('hidden');
      noProjects.classList.add('hidden');

      projectsList.innerHTML = displayProjects.map(project => {
        const statusColor = statusColors[project.status] || statusColors.pending;
        const phaseColor = phaseColors[project.phase] || 'text-cream/60';

        return `
          <a href="/admin/projects/${project.id}" class="block bg-charcoal-light border border-charcoal-border rounded-lg p-6 hover:border-brass/30 transition-all group">
            <div class="flex items-start justify-between mb-4">
              <div>
                <div class="flex items-center gap-3 mb-1">
                  <h3 class="text-cream font-medium group-hover:text-brass transition-colors">${project.name}</h3>
                  <span class="text-xs px-2 py-0.5 rounded-full border ${statusColor}">
                    ${project.status}
                  </span>
                </div>
                <p class="text-sm text-cream/50">${project.client}${project.sqft ? ' Â· ' + project.sqft.toLocaleString() + ' sq ft' : ''}</p>
              </div>
              <span class="text-xs text-cream/40">${project.lastUpdate || ''}</span>
            </div>

            <div class="mb-4">
              <div class="flex items-center justify-between text-xs mb-2">
                <span class="${phaseColor}">${project.phase}</span>
                <span class="text-brass">${project.progress || 0}%</span>
              </div>
              <div class="h-2 bg-charcoal rounded-full overflow-hidden">
                <div class="h-full bg-brass rounded-full transition-all" style="width: ${project.progress || 0}%"></div>
              </div>
            </div>

            <div class="flex items-center justify-between">
              <div class="flex gap-2">
                ${(project.finishes || []).slice(0, 2).map(finish =>
                  `<span class="text-xs px-2 py-1 bg-charcoal rounded text-cream/60">${finish}</span>`
                ).join('')}
                ${(project.finishes || []).length > 2 ?
                  `<span class="text-xs px-2 py-1 bg-charcoal rounded text-cream/40">+${project.finishes.length - 2}</span>` : ''}
              </div>
              ${project.estCompletion ? `
                <div class="text-right">
                  <div class="text-xs text-cream/40">Est. Completion</div>
                  <div class="text-xs text-brass">${formatDate(project.estCompletion)}</div>
                </div>
              ` : ''}
            </div>
          </a>
        `;
      }).join('');
    }

    // Render messages
    const messagesList = document.getElementById('messages-list');
    const noMessages = document.getElementById('no-messages');
    const inboxMessages = messages.filter(m => m.folder === 'inbox').slice(0, 3);

    if (inboxMessages.length === 0) {
      messagesList.classList.add('hidden');
      noMessages.classList.remove('hidden');
    } else {
      messagesList.classList.remove('hidden');
      noMessages.classList.add('hidden');

      messagesList.innerHTML = inboxMessages.map(msg => `
        <a href="/admin/messages" class="block p-4 hover:bg-charcoal-border/30 transition-colors">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-brass/20 flex items-center justify-center flex-shrink-0">
              <span class="text-brass text-xs font-medium">${(msg.from || 'U').charAt(0)}</span>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-sm text-cream font-medium truncate">${msg.from || 'Unknown'}</span>
                ${!msg.read ? '<span class="w-2 h-2 rounded-full bg-brass flex-shrink-0"></span>' : ''}
              </div>
              <p class="text-xs text-cream/40 mb-1">${msg.project || ''}</p>
              <p class="text-sm text-cream/60 truncate">${msg.subject || msg.preview || ''}</p>
            </div>
            <span class="text-xs text-cream/40 flex-shrink-0">${msg.time || ''}</span>
          </div>
        </a>
      `).join('');
    }

    // Render events
    const eventsList = document.getElementById('events-list');
    const noEvents = document.getElementById('no-events');
    const upcomingEvents = weekEvents.slice(0, 3);

    if (upcomingEvents.length === 0) {
      eventsList.classList.add('hidden');
      noEvents.classList.remove('hidden');
    } else {
      eventsList.classList.remove('hidden');
      noEvents.classList.add('hidden');

      eventsList.innerHTML = upcomingEvents.map(event => `
        <div class="p-4">
          <div class="flex items-start justify-between">
            <div>
              <p class="text-sm text-cream">${event.title}</p>
              <p class="text-xs text-cream/40 mt-1">${event.project || ''}</p>
            </div>
            <span class="text-xs text-brass">${formatEventDate(event.date)}${event.time ? ', ' + event.time : ''}</span>
          </div>
        </div>
      `).join('');
    }
  }

  // Initialize
  renderDashboard();
</script>
