---
import AdminLayout from '../../layouts/AdminLayout.astro';

const messages = [
  { id: '1', date: 'Jan 17, 2025', time: '2:30 PM', project: 'Greenwich Estate', recipients: ['All Team'], subject: 'Master Suite Progress', channel: 'email', status: 'delivered', preview: 'First coat of Venetian complete in master bedroom. Cure time 24hrs before second application.' },
  { id: '2', date: 'Jan 15, 2025', time: '10:00 AM', project: 'Greenwich Estate', recipients: ['Mark Thompson'], subject: 'Drywall Ready', channel: 'sms', status: 'delivered', preview: 'Drywall in master suite is ready for inspection. Please confirm access for tomorrow AM.' },
  { id: '3', date: 'Jan 12, 2025', time: '4:15 PM', project: 'Greenwich Estate', recipients: ['Lisa Harrison', 'Sarah Chen'], subject: 'Preparation Complete', channel: 'both', status: 'delivered', preview: 'All surfaces prepped and primed. Beginning application phase Monday.' },
  { id: '4', date: 'Jan 10, 2025', time: '9:00 AM', project: 'Westport Modern', recipients: ['David Chen', 'James Wong'], subject: 'Sample Boards Ready', channel: 'email', status: 'delivered', preview: 'Your custom sample boards are ready for review. Please schedule a time to visit the Material Library.' },
  { id: '5', date: 'Jan 8, 2025', time: '11:30 AM', project: 'Greenwich Estate', recipients: ['All Team'], subject: 'Sample Approval Confirmed', channel: 'email', status: 'delivered', preview: 'Thank you for approving the final samples. Formal living: Warm Ivory. Master: Pearl.' },
  { id: '6', date: 'Jan 5, 2025', time: '3:45 PM', project: 'Darien Historic', recipients: ['Patricia Wright', 'Robert Mills'], subject: 'Material Library Invitation', channel: 'both', status: 'delivered', preview: 'Excited to begin your project. Please join us at the Material Library to explore finish options.' }
];

const templates = [
  { id: 'sampling-complete', name: 'Sampling Complete', subject: 'Sample Boards Ready for Review', body: 'Your custom sample boards are ready for review at our Material Library. Please schedule a time to visit and we\'ll walk you through each finish option.\n\nBest regards,\nDaragh' },
  { id: 'ready-for-visit', name: 'Ready for Site Visit', subject: 'Ready for Your Site Visit', body: 'We\'re ready for your scheduled site visit. The [PHASE] is progressing well and we\'d like to walk you through our work.\n\nPlease confirm the time works for you.\n\nBest regards,\nDaragh' },
  { id: 'drywall-spec', name: 'Drywall Spec Reminder', subject: 'Drywall Specification Reminder', body: 'A friendly reminder about drywall specifications for plaster application:\n\n- Level 4 or 5 finish required\n- All joints must be fully set (minimum 48 hours)\n- Prime with bonding primer before our arrival\n\nPlease confirm these specifications with your drywall crew.\n\nBest regards,\nDaragh' },
  { id: 'schedule-update', name: 'Schedule Update', subject: 'Project Schedule Update', body: 'I wanted to provide an update on our project timeline:\n\n[UPDATE DETAILS]\n\nPlease let me know if you have any questions.\n\nBest regards,\nDaragh' },
  { id: 'phase-complete', name: 'Phase Complete', subject: '[PHASE] Complete - Moving to Next Phase', body: 'I\'m pleased to report that the [PHASE] is now complete. We\'re ready to move forward with the next phase of your project.\n\nNext steps:\n[NEXT STEPS]\n\nBest regards,\nDaragh' }
];

const contacts = [
  { id: '1', name: 'Lisa Harrison', role: 'Client', project: 'Greenwich Estate', email: 'lisa@harrison.com', phone: '203-555-0101', channel: 'both' },
  { id: '2', name: 'Sarah Chen', role: 'Architect', project: 'Greenwich Estate', email: 'sarah@chendesign.com', phone: '203-555-0102', channel: 'email' },
  { id: '3', name: 'Mark Thompson', role: 'General Contractor', project: 'Greenwich Estate', email: 'mark@thompsonbuilders.com', phone: '203-555-0103', channel: 'sms' },
  { id: '4', name: 'Emily Ross', role: 'Interior Designer', project: 'Greenwich Estate', email: 'emily@rossinteriors.com', phone: '203-555-0104', channel: 'both' },
  { id: '5', name: 'David Chen', role: 'Client', project: 'Westport Modern', email: 'david@chenfamily.com', phone: '203-555-0201', channel: 'email' },
  { id: '6', name: 'James Wong', role: 'Architect', project: 'Westport Modern', email: 'james@modernct.com', phone: '203-555-0202', channel: 'both' },
  { id: '7', name: 'Patricia Wright', role: 'Client', project: 'Darien Historic', email: 'patricia@wright.com', phone: '203-555-0301', channel: 'both' },
  { id: '8', name: 'Robert Mills', role: 'Preservation Architect', project: 'Darien Historic', email: 'robert@heritagedesign.com', phone: '203-555-0302', channel: 'email' }
];

const channelColors = {
  email: 'bg-blue-500/20 text-blue-400',
  sms: 'bg-purple-500/20 text-purple-400',
  both: 'bg-emerald-500/20 text-emerald-400'
};
---

<AdminLayout title="Messages" currentPage="messages">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Message List -->
    <div class="lg:col-span-2">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
          <h2 class="text-lg font-medium text-cream">Sent Messages</h2>
          <select class="bg-charcoal-light border border-charcoal-border rounded-lg px-3 py-1.5 text-sm text-cream/70 focus:outline-none focus:border-brass/50">
            <option>All Projects</option>
            <option>Greenwich Estate</option>
            <option>Westport Modern</option>
            <option>Darien Historic</option>
          </select>
        </div>
        <button
          id="compose-btn"
          class="flex items-center gap-2 px-4 py-2 bg-brass text-charcoal text-sm font-medium rounded-lg hover:bg-brass-light transition-colors"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Compose
        </button>
      </div>

      <div class="space-y-3">
        {messages.map((msg) => (
          <div class="bg-charcoal-light border border-charcoal-border rounded-lg p-5 hover:border-brass/30 transition-colors cursor-pointer">
            <div class="flex items-start justify-between mb-3">
              <div>
                <h3 class="text-cream font-medium mb-1">{msg.subject}</h3>
                <p class="text-sm text-cream/50">To: {msg.recipients.join(', ')}</p>
              </div>
              <div class="text-right flex-shrink-0">
                <div class="text-xs text-cream/40">{msg.date}</div>
                <div class="text-xs text-cream/30">{msg.time}</div>
              </div>
            </div>

            <p class="text-sm text-cream/70 mb-3 line-clamp-2">{msg.preview}</p>

            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-xs px-2 py-0.5 bg-charcoal rounded text-cream/50">{msg.project}</span>
                <span class={`text-xs px-2 py-0.5 rounded ${channelColors[msg.channel]}`}>
                  {msg.channel === 'both' ? 'Email + SMS' : msg.channel.toUpperCase()}
                </span>
              </div>
              <span class="text-xs text-emerald-400 flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                {msg.status}
              </span>
            </div>
          </div>
        ))}
      </div>
    </div>

    <!-- Compose Panel -->
    <div id="compose-panel" class="lg:col-span-1">
      <div class="bg-charcoal-light border border-charcoal-border rounded-lg sticky top-24">
        <div class="p-4 border-b border-charcoal-border">
          <h2 class="text-lg font-medium text-cream">Compose Message</h2>
        </div>

        <form id="compose-form" class="p-4 space-y-4">
          <!-- Project Selection -->
          <div>
            <label class="block text-sm text-cream/60 mb-2">Project</label>
            <select id="project-select" class="w-full bg-charcoal border border-charcoal-border rounded-lg px-4 py-2 text-cream focus:outline-none focus:border-brass/50">
              <option value="">Select project...</option>
              <option value="greenwich-estate">Greenwich Estate</option>
              <option value="westport-modern">Westport Modern</option>
              <option value="darien-historic">Darien Historic</option>
            </select>
          </div>

          <!-- Recipients -->
          <div>
            <label class="block text-sm text-cream/60 mb-2">Recipients</label>
            <div id="recipients-list" class="space-y-2 max-h-48 overflow-y-auto">
              <p class="text-sm text-cream/40 italic">Select a project to see contacts</p>
            </div>
          </div>

          <!-- Channel Selection -->
          <div>
            <label class="block text-sm text-cream/60 mb-2">Send via</label>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2 p-3 bg-charcoal rounded-lg cursor-pointer hover:bg-charcoal-border/50 transition-colors has-[:checked]:border-brass/50 border border-transparent">
                <input type="radio" name="channel" value="preferred" checked class="accent-brass" />
                <span class="text-sm text-cream">Preferred</span>
              </label>
              <label class="flex items-center gap-2 p-3 bg-charcoal rounded-lg cursor-pointer hover:bg-charcoal-border/50 transition-colors has-[:checked]:border-brass/50 border border-transparent">
                <input type="radio" name="channel" value="email" class="accent-brass" />
                <span class="text-sm text-cream">Email</span>
              </label>
              <label class="flex items-center gap-2 p-3 bg-charcoal rounded-lg cursor-pointer hover:bg-charcoal-border/50 transition-colors has-[:checked]:border-brass/50 border border-transparent">
                <input type="radio" name="channel" value="sms" class="accent-brass" />
                <span class="text-sm text-cream">SMS</span>
              </label>
              <label class="flex items-center gap-2 p-3 bg-charcoal rounded-lg cursor-pointer hover:bg-charcoal-border/50 transition-colors has-[:checked]:border-brass/50 border border-transparent">
                <input type="radio" name="channel" value="both" class="accent-brass" />
                <span class="text-sm text-cream">Both</span>
              </label>
            </div>
          </div>

          <!-- Template -->
          <div>
            <label class="block text-sm text-cream/60 mb-2">Template</label>
            <select id="template-select" class="w-full bg-charcoal border border-charcoal-border rounded-lg px-4 py-2 text-cream focus:outline-none focus:border-brass/50">
              <option value="">No template</option>
              {templates.map((t) => (
                <option value={t.id} data-subject={t.subject} data-body={t.body}>{t.name}</option>
              ))}
            </select>
          </div>

          <!-- Subject -->
          <div>
            <label class="block text-sm text-cream/60 mb-2">Subject</label>
            <input
              type="text"
              id="subject-input"
              placeholder="Enter subject..."
              class="w-full bg-charcoal border border-charcoal-border rounded-lg px-4 py-2 text-cream placeholder:text-cream/40 focus:outline-none focus:border-brass/50"
            />
          </div>

          <!-- Message -->
          <div>
            <label class="block text-sm text-cream/60 mb-2">Message</label>
            <textarea
              id="message-input"
              rows="6"
              placeholder="Type your message..."
              class="w-full bg-charcoal border border-charcoal-border rounded-lg px-4 py-3 text-cream placeholder:text-cream/40 focus:outline-none focus:border-brass/50 resize-none"
            ></textarea>
          </div>

          <!-- Attachments -->
          <div>
            <label class="block text-sm text-cream/60 mb-2">Attachments</label>
            <div class="border border-dashed border-charcoal-border rounded-lg p-4 text-center hover:border-brass/30 transition-colors cursor-pointer">
              <svg class="w-6 h-6 text-cream/30 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
              </svg>
              <p class="text-xs text-cream/40">Drop files or click</p>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex items-center gap-3 pt-2">
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-brass text-charcoal text-sm font-medium rounded-lg hover:bg-brass-light transition-colors"
            >
              Send Message
            </button>
            <button
              type="button"
              class="px-4 py-2 border border-charcoal-border text-cream/70 text-sm rounded-lg hover:border-brass/50 hover:text-cream transition-colors"
            >
              Save Draft
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</AdminLayout>

<script define:vars={{ contacts, templates }}>
  const projectSelect = document.getElementById('project-select');
  const recipientsList = document.getElementById('recipients-list');
  const templateSelect = document.getElementById('template-select');
  const subjectInput = document.getElementById('subject-input');
  const messageInput = document.getElementById('message-input');

  // Project to contacts mapping
  const projectContacts = {
    'greenwich-estate': contacts.filter(c => c.project === 'Greenwich Estate'),
    'westport-modern': contacts.filter(c => c.project === 'Westport Modern'),
    'darien-historic': contacts.filter(c => c.project === 'Darien Historic')
  };

  // Update recipients when project changes
  projectSelect?.addEventListener('change', () => {
    const project = projectSelect.value;
    if (!project) {
      recipientsList.innerHTML = '<p class="text-sm text-cream/40 italic">Select a project to see contacts</p>';
      return;
    }

    const projectTeam = projectContacts[project] || [];

    if (projectTeam.length === 0) {
      recipientsList.innerHTML = '<p class="text-sm text-cream/40 italic">No contacts for this project</p>';
      return;
    }

    recipientsList.innerHTML = `
      <label class="flex items-center gap-2 p-2 bg-charcoal rounded-lg cursor-pointer hover:bg-charcoal-border/50">
        <input type="checkbox" value="all" class="accent-brass" />
        <span class="text-sm text-cream font-medium">All Team Members</span>
      </label>
      ${projectTeam.map(contact => `
        <label class="flex items-center gap-2 p-2 bg-charcoal rounded-lg cursor-pointer hover:bg-charcoal-border/50">
          <input type="checkbox" value="${contact.id}" class="accent-brass recipient-checkbox" />
          <div class="flex-1">
            <span class="text-sm text-cream">${contact.name}</span>
            <span class="text-xs text-cream/40 ml-2">(${contact.role})</span>
          </div>
          <span class="text-xs px-1.5 py-0.5 rounded ${
            contact.channel === 'both' ? 'bg-emerald-500/10 text-emerald-400' :
            contact.channel === 'email' ? 'bg-blue-500/10 text-blue-400' :
            'bg-purple-500/10 text-purple-400'
          }">
            ${contact.channel === 'both' ? 'E+S' : contact.channel === 'email' ? 'E' : 'S'}
          </span>
        </label>
      `).join('')}
    `;

    // Handle "All" checkbox
    const allCheckbox = recipientsList.querySelector('input[value="all"]');
    const recipientCheckboxes = recipientsList.querySelectorAll('.recipient-checkbox');

    allCheckbox?.addEventListener('change', () => {
      recipientCheckboxes.forEach(cb => cb.checked = allCheckbox.checked);
    });
  });

  // Template selection
  templateSelect?.addEventListener('change', () => {
    const option = templateSelect.selectedOptions[0];
    if (option && option.value) {
      subjectInput.value = option.dataset.subject || '';
      messageInput.value = option.dataset.body || '';
    }
  });

  // Form submission
  const form = document.getElementById('compose-form');
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const project = projectSelect.value;
    const channel = document.querySelector('input[name="channel"]:checked')?.value;
    const subject = subjectInput.value;
    const message = messageInput.value;
    const selectedRecipients = Array.from(recipientsList.querySelectorAll('input:checked'))
      .map(cb => cb.value)
      .filter(v => v !== 'all');

    if (!project || selectedRecipients.length === 0 || !subject || !message) {
      alert('Please fill in all required fields');
      return;
    }

    // In production, this would call the API
    console.log('Sending message:', { project, channel, subject, message, recipients: selectedRecipients });
    alert('Message sent! (Demo - would send via API in production)');

    // Reset form
    form.reset();
    recipientsList.innerHTML = '<p class="text-sm text-cream/40 italic">Select a project to see contacts</p>';
  });
</script>
