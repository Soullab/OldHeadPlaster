---
import AdminLayout from '../../layouts/AdminLayout.astro';

// Current date info
const now = new Date();
const currentMonth = now.toLocaleString('default', { month: 'long' });
const currentYear = now.getFullYear();
const currentDay = now.getDate();

// Get first day of month and total days
const firstDayOfMonth = new Date(currentYear, now.getMonth(), 1).getDay();
const daysInMonth = new Date(currentYear, now.getMonth() + 1, 0).getDate();

// Adjust for Monday start (0 = Monday, 6 = Sunday)
const startOffset = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;

// Sample schedule data
const today = new Date();
const events = [
  { id: '1', title: 'Substrate Inspection', project: 'Greenwich Estate', type: 'site-visit', date: 'Jan 17', time: '2:00 PM', duration: '1h', location: '247 Round Hill Rd', attendees: ['Daragh', 'Mark Thompson'] },
  { id: '2', title: 'Sample Presentation', project: 'Westport Modern', type: 'client-meeting', date: 'Jan 18', time: '10:00 AM', duration: '2h', location: 'Material Library', attendees: ['Daragh', 'David Chen', 'James Wong'] },
  { id: '3', title: 'Material Library Tour', project: 'Darien Historic', type: 'client-meeting', date: 'Jan 22', time: '11:00 AM', duration: '2h', location: 'Material Library', attendees: ['Daragh', 'Patricia Wright', 'Robert Mills'] },
  { id: '4', title: 'Master Suite - Second Coat', project: 'Greenwich Estate', type: 'work', date: 'Jan 18-20', time: 'All Day', duration: '3 days', location: '247 Round Hill Rd', attendees: ['Daragh', 'Crew'] },
  { id: '5', title: 'Drywall Review', project: 'Westport Modern', type: 'site-visit', date: 'Jan 25', time: '9:00 AM', duration: '1h', location: '89 Compo Rd', attendees: ['Daragh', 'James Wong', 'GC'] },
  { id: '6', title: 'Progress Photos', project: 'Greenwich Estate', type: 'task', date: 'Jan 17', time: '4:00 PM', duration: '30m', location: 'On-site', attendees: ['Daragh'] }
];

const typeColors = {
  'site-visit': { bg: 'bg-blue-500/20', text: 'text-blue-400', border: 'border-blue-500/30', label: 'Site Visit' },
  'client-meeting': { bg: 'bg-emerald-500/20', text: 'text-emerald-400', border: 'border-emerald-500/30', label: 'Client Meeting' },
  'work': { bg: 'bg-brass/20', text: 'text-brass', border: 'border-brass/30', label: 'Work Session' },
  'task': { bg: 'bg-purple-500/20', text: 'text-purple-400', border: 'border-purple-500/30', label: 'Task' }
};

// Group events by date
const eventsByDate = events.reduce((acc, event) => {
  if (!acc[event.date]) acc[event.date] = [];
  acc[event.date].push(event);
  return acc;
}, {} as Record<string, typeof events>);
---

<AdminLayout title="Schedule" currentPage="schedule">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <div class="flex items-center gap-4">
      <button class="p-2 text-cream/50 hover:text-cream hover:bg-charcoal-light rounded-lg transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <h2 class="text-xl font-medium text-cream">{currentMonth} {currentYear}</h2>
      <button class="p-2 text-cream/50 hover:text-cream hover:bg-charcoal-light rounded-lg transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7" />
        </svg>
      </button>
      <button class="ml-4 px-3 py-1.5 text-sm text-cream/70 hover:text-cream border border-charcoal-border rounded-lg hover:border-brass/50 transition-colors">
        Today
      </button>
    </div>

    <div class="flex items-center gap-3">
      <div class="flex bg-charcoal-light rounded-lg p-1">
        <button id="view-week" class="view-btn px-3 py-1.5 text-sm text-cream/50 hover:text-cream rounded transition-colors">Week</button>
        <button id="view-month" class="view-btn px-3 py-1.5 text-sm text-cream bg-charcoal rounded">Month</button>
        <button id="view-list" class="view-btn px-3 py-1.5 text-sm text-cream/50 hover:text-cream rounded transition-colors">List</button>
      </div>
      <button class="flex items-center gap-2 px-4 py-2 bg-brass text-charcoal text-sm font-medium rounded-lg hover:bg-brass-light transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Add Event
      </button>
    </div>
  </div>

  <!-- Legend -->
  <div class="flex items-center gap-4 mb-6">
    {Object.entries(typeColors).map(([type, colors]) => (
      <div class="flex items-center gap-2">
        <span class={`w-3 h-3 rounded-full ${colors.bg}`}></span>
        <span class="text-sm text-cream/50">{colors.label}</span>
      </div>
    ))}
  </div>

  <!-- Month View -->
  <div id="month-view" class="calendar-view">
    <!-- Day Headers -->
    <div class="grid grid-cols-7 gap-1 mb-2">
      {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day) => (
        <div class="text-center py-2 text-xs text-cream/50 uppercase">{day}</div>
      ))}
    </div>
    <!-- Calendar Grid -->
    <div class="grid grid-cols-7 gap-1">
      {/* Empty cells for offset */}
      {Array.from({ length: startOffset }).map(() => (
        <div class="min-h-[100px] bg-charcoal-light/30 rounded-lg p-2"></div>
      ))}
      {/* Days of month */}
      {Array.from({ length: daysInMonth }).map((_, i) => {
        const day = i + 1;
        const isToday = day === currentDay;
        const dateStr = `Jan ${day}`;
        const dayEvents = events.filter(e => e.date === dateStr || e.date.includes(`${day}-`) || e.date.includes(`-${day}`));

        return (
          <div class={`min-h-[100px] rounded-lg p-2 border transition-colors hover:border-brass/30 ${isToday ? 'bg-brass/10 border-brass/50' : 'bg-charcoal-light border-charcoal-border'}`}>
            <div class={`text-sm font-medium mb-1 ${isToday ? 'text-brass' : 'text-cream/70'}`}>{day}</div>
            <div class="space-y-1">
              {dayEvents.slice(0, 2).map((event) => {
                const colors = typeColors[event.type] || typeColors.task;
                return (
                  <div class={`text-xs p-1 rounded truncate ${colors.bg} ${colors.text}`} title={event.title}>
                    {event.title}
                  </div>
                );
              })}
              {dayEvents.length > 2 && (
                <div class="text-xs text-cream/40">+{dayEvents.length - 2} more</div>
              )}
            </div>
          </div>
        );
      })}
    </div>
  </div>

  <!-- Week View -->
  <div id="week-view" class="calendar-view hidden grid grid-cols-7 gap-4">
    {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, i) => {
      const date = 13 + i; // Jan 13-19
      const dateStr = `Jan ${date}`;
      const isToday = date === 17;
      const dayEvents = events.filter(e => e.date === dateStr || e.date.includes(`${date}`));

      return (
        <div class="min-h-[400px]">
          <!-- Day Header -->
          <div class={`text-center py-3 rounded-t-lg ${isToday ? 'bg-brass/20' : 'bg-charcoal-light'}`}>
            <div class="text-xs text-cream/50 uppercase">{day}</div>
            <div class={`text-lg font-medium ${isToday ? 'text-brass' : 'text-cream'}`}>{date}</div>
          </div>

          <!-- Day Events -->
          <div class={`border-x border-b border-charcoal-border rounded-b-lg p-2 space-y-2 min-h-[350px] ${isToday ? 'bg-brass/5' : ''}`}>
            {dayEvents.map((event) => {
              const colors = typeColors[event.type] || typeColors.task;
              return (
                <div class={`p-2 rounded-lg border cursor-pointer hover:brightness-110 transition-all ${colors.bg} ${colors.border}`}>
                  <div class={`text-xs font-medium ${colors.text}`}>{event.time}</div>
                  <div class="text-sm text-cream mt-1">{event.title}</div>
                  <div class="text-xs text-cream/40 mt-1">{event.project}</div>
                </div>
              );
            })}
          </div>
        </div>
      );
    })}
  </div>

  <!-- Upcoming Events List -->
  <div class="mt-8">
    <h3 class="text-lg font-medium text-cream mb-4">Upcoming Events</h3>
    <div class="bg-charcoal-light border border-charcoal-border rounded-lg divide-y divide-charcoal-border">
      {events.map((event) => {
        const colors = typeColors[event.type] || typeColors.task;
        return (
          <div class="p-4 flex items-start gap-4 hover:bg-charcoal-border/30 transition-colors cursor-pointer">
            <div class={`w-1 h-12 rounded-full ${colors.bg}`}></div>
            <div class="flex-1">
              <div class="flex items-start justify-between">
                <div>
                  <h4 class="text-cream font-medium">{event.title}</h4>
                  <p class="text-sm text-cream/50">{event.project}</p>
                </div>
                <div class="text-right">
                  <div class="text-sm text-cream">{event.date}</div>
                  <div class="text-sm text-cream/50">{event.time} Â· {event.duration}</div>
                </div>
              </div>
              <div class="mt-2 flex items-center gap-4 text-sm text-cream/40">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  {event.location}
                </span>
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                  </svg>
                  {event.attendees.join(', ')}
                </span>
              </div>
            </div>
            <span class={`text-xs px-2 py-0.5 rounded-full ${colors.bg} ${colors.text}`}>
              {colors.label}
            </span>
          </div>
        );
      })}
    </div>
  </div>
</AdminLayout>
