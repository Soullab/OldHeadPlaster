---
import Layout from '../layouts/Layout.astro';

const tiers = [
  {
    key: 'foundation',
    name: 'Foundation',
    range: '$35–55',
    min: 35,
    max: 55,
    description: 'Single rooms, good substrate, standard heights'
  },
  {
    key: 'signature',
    name: 'Signature',
    range: '$55–85',
    min: 55,
    max: 85,
    description: 'Multi-room, polished finishes, custom colors'
  },
  {
    key: 'bespoke',
    name: 'Bespoke',
    range: '$85–150+',
    min: 85,
    max: 150,
    description: 'Large-scale, specialty finishes, complex conditions'
  }
];

const factors = [
  {
    key: 'substrateCondition',
    label: 'Substrate Condition',
    options: [
      { value: 'good', label: 'Good (new drywall)', lowMult: 0, highMult: 0 },
      { value: 'moderate', label: 'Moderate (some repair needed)', lowMult: 0.05, highMult: 0.1 },
      { value: 'poor', label: 'Poor (extensive prep required)', lowMult: 0.15, highMult: 0.25 }
    ]
  },
  {
    key: 'ceilingAccess',
    label: 'Ceiling Height / Access',
    options: [
      { value: 'standard', label: 'Standard (8-10 ft)', lowMult: 0, highMult: 0 },
      { value: 'high', label: 'High (10-14 ft)', lowMult: 0.1, highMult: 0.15 },
      { value: 'difficult', label: 'Difficult (scaffolding required)', lowMult: 0.2, highMult: 0.3 }
    ]
  },
  {
    key: 'finishComplexity',
    label: 'Finish Complexity',
    options: [
      { value: 'simple', label: 'Simple (limewash, matte)', lowMult: 0, highMult: 0 },
      { value: 'moderate', label: 'Moderate (satin Venetian)', lowMult: 0.05, highMult: 0.1 },
      { value: 'complex', label: 'Complex (polished, Tadelakt)', lowMult: 0.15, highMult: 0.2 }
    ]
  },
  {
    key: 'colorCustomization',
    label: 'Color Selection',
    options: [
      { value: 'standard', label: 'Standard palette', lowMult: 0, highMult: 0 },
      { value: 'custom', label: 'Custom color match', lowMult: 0.05, highMult: 0.1 },
      { value: 'specialty', label: 'Specialty pigments', lowMult: 0.1, highMult: 0.2 }
    ]
  }
];

const finishTypes = [
  'Venetian Plaster',
  'Lime Wash',
  'Microcement',
  'Tadelakt',
  'Marmorino',
  'Historic Restoration',
  'Ornamental'
];
---

<Layout title="Project Studio | Old Head Plaster" description="Internal business tools for project estimation, room scanning, and business metrics." hideChat={true}>

  <!-- LOGIN SCREEN -->
  <div id="login-screen" class="min-h-screen bg-charcoal flex items-center justify-center">
    <div class="max-w-sm w-full mx-4">
      <div class="text-center mb-8">
        <div class="w-16 h-16 bg-bronze/20 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
        </div>
        <h1 class="text-cream text-2xl font-heading mb-2">Project Studio</h1>
        <p class="text-cream/50 text-sm">Enter your passcode to continue</p>
      </div>

      <div class="bg-charcoal/50 border border-cream/10 p-6">
        <div class="mb-4">
          <label class="block text-cream/60 text-xs uppercase tracking-wide mb-2">Passcode</label>
          <input
            type="password"
            id="passcode-input"
            placeholder="••••••••••••"
            class="w-full px-4 py-3 bg-charcoal border border-cream/20 text-cream text-center text-xl tracking-[0.3em] focus:border-bronze focus:outline-none placeholder:tracking-normal placeholder:text-cream/30"
            maxlength="12"
            autocomplete="off"
          />
        </div>
        <p id="login-error" class="text-red-400 text-sm text-center mb-4 hidden">Incorrect passcode</p>
        <button
          id="login-btn"
          class="w-full py-3 bg-bronze text-charcoal font-medium tracking-wide uppercase hover:bg-bronze/90 transition-colors"
        >
          Access Studio
        </button>
      </div>

      <p class="text-cream/30 text-xs text-center mt-6">
        Old Head Plaster internal tools
      </p>
    </div>
  </div>

  <!-- MAIN APP (hidden until authenticated) -->
  <div id="main-app" class="hidden">

  <!-- Header Bar -->
  <section class="bg-charcoal border-b border-cream/10">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-10 h-10 bg-bronze/20 rounded-full flex items-center justify-center">
            <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
          </div>
          <div>
            <h1 class="text-cream text-xl font-heading">Project Studio</h1>
            <p class="text-cream/50 text-xs tracking-wide">Internal Business Tools</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <div class="flex items-center gap-3">
            <span class="text-cream/40 text-xs">Last sync: Just now</span>
            <button id="sync-scanner-btn" class="px-4 py-2 bg-bronze/20 text-bronze text-sm rounded hover:bg-bronze/30 transition-colors flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Sync Scanner
            </button>
            <button id="logout-btn" class="px-3 py-2 text-cream/50 hover:text-cream text-sm transition-colors flex items-center gap-1">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
              Logout
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Tab Navigation -->
  <section class="bg-charcoal sticky top-[73px] z-40 border-b border-cream/10">
    <div class="max-w-7xl mx-auto px-6">
      <div class="flex gap-1 overflow-x-auto" id="tab-nav">
        <button class="tab-btn active px-6 py-4 text-sm tracking-wide transition-colors whitespace-nowrap" data-tab="dashboard">
          Dashboard
        </button>
        <button class="tab-btn px-6 py-4 text-sm tracking-wide transition-colors whitespace-nowrap" data-tab="estimator">
          Estimator
        </button>
        <button class="tab-btn px-6 py-4 text-sm tracking-wide transition-colors whitespace-nowrap" data-tab="leads">
          Leads & CRM
        </button>
        <button class="tab-btn px-6 py-4 text-sm tracking-wide transition-colors whitespace-nowrap" data-tab="projects">
          Projects
        </button>
        <button class="tab-btn px-6 py-4 text-sm tracking-wide transition-colors whitespace-nowrap" data-tab="invoices">
          Invoicing
        </button>
        <button class="tab-btn px-6 py-4 text-sm tracking-wide transition-colors whitespace-nowrap" data-tab="accounting">
          Accounting
        </button>
        <button class="tab-btn px-6 py-4 text-sm tracking-wide transition-colors whitespace-nowrap" data-tab="materials">
          Materials
        </button>
        <button class="tab-btn px-6 py-4 text-sm tracking-wide transition-colors whitespace-nowrap" data-tab="images">
          Images
        </button>
      </div>
    </div>
  </section>

  <!-- Tab Content -->
  <div class="bg-stone min-h-screen">

    <!-- DASHBOARD TAB -->
    <div id="tab-dashboard" class="tab-content">
      <div class="max-w-7xl mx-auto px-6 py-8">

        <!-- Welcome Header -->
        <div class="flex justify-between items-start mb-8">
          <div>
            <h1 class="text-2xl font-heading text-charcoal">Good <span id="dash-greeting">morning</span>, Daragh</h1>
            <p class="text-charcoal/60 mt-1" id="dash-date"></p>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="sendDailySummaryToOwner()" class="flex items-center gap-2 px-4 py-2 bg-charcoal text-cream text-sm hover:bg-charcoal/80 transition-colors" title="Send daily summary to your phone">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              Text Me Summary
            </button>
            <button onclick="openRemindersPanel()" class="flex items-center gap-2 px-4 py-2 border border-charcoal/30 text-charcoal text-sm hover:bg-charcoal/5 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
              </svg>
              Reminders
            </button>
          </div>
        </div>

        <!-- Quick Action Buttons -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
          <button onclick="switchTab('estimator')" class="flex flex-col items-center gap-2 p-4 bg-cream shadow-sm hover:shadow-md transition-shadow">
            <div class="w-12 h-12 bg-bronze/20 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
            </div>
            <span class="text-sm text-charcoal font-medium">New Estimate</span>
          </button>
          <button onclick="switchTab('leads'); openNewLeadModal()" class="flex flex-col items-center gap-2 p-4 bg-cream shadow-sm hover:shadow-md transition-shadow">
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
              </svg>
            </div>
            <span class="text-sm text-charcoal font-medium">Add Lead</span>
          </button>
          <button onclick="switchTab('invoices'); openNewInvoiceModal()" class="flex flex-col items-center gap-2 p-4 bg-cream shadow-sm hover:shadow-md transition-shadow">
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
            <span class="text-sm text-charcoal font-medium">Create Invoice</span>
          </button>
          <button onclick="openQuickExpenseModal()" class="flex flex-col items-center gap-2 p-4 bg-cream shadow-sm hover:shadow-md transition-shadow">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
            </div>
            <span class="text-sm text-charcoal font-medium">Log Expense</span>
          </button>
        </div>

        <!-- Key Metrics Row -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Revenue YTD</p>
            <p class="text-2xl font-heading text-charcoal">$<span id="dash-revenue">0</span></p>
            <p class="text-xs text-green-600 mt-1" id="dash-revenue-trend">--</p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Pipeline Value</p>
            <p class="text-2xl font-heading text-bronze">$<span id="dash-pipeline">0</span></p>
            <p class="text-xs text-charcoal/50 mt-1"><span id="dash-pipeline-count">0</span> potential jobs</p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Outstanding</p>
            <p class="text-2xl font-heading text-red-600">$<span id="dash-outstanding">0</span></p>
            <p class="text-xs text-charcoal/50 mt-1"><span id="dash-overdue-count">0</span> overdue</p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Active Jobs</p>
            <p class="text-2xl font-heading text-charcoal"><span id="dash-active-jobs">0</span></p>
            <p class="text-xs text-charcoal/50 mt-1">in progress</p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Close Rate</p>
            <p class="text-2xl font-heading text-charcoal"><span id="dash-close-rate">0</span>%</p>
            <p class="text-xs text-charcoal/50 mt-1">last 90 days</p>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-6">

          <!-- Today's Focus -->
          <div class="md:col-span-2 space-y-6">

            <!-- Priority Actions -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30 bg-red-50">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                  Needs Attention
                </h3>
              </div>
              <div class="p-4" id="dash-priority-actions">
                <p class="text-charcoal/50 text-sm">Loading...</p>
              </div>
            </div>

            <!-- Today's Tasks -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30 flex justify-between items-center">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                  </svg>
                  Today's Tasks
                </h3>
                <button onclick="openAddTaskModal()" class="text-xs text-bronze hover:text-bronze/80">+ Add Task</button>
              </div>
              <div class="p-4" id="dash-tasks">
                <p class="text-charcoal/50 text-sm">No tasks for today</p>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30">
                <h3 class="font-heading text-charcoal">Recent Activity</h3>
              </div>
              <div class="p-4" id="dash-activity">
                <p class="text-charcoal/50 text-sm">No recent activity</p>
              </div>
            </div>

          </div>

          <!-- Right Sidebar -->
          <div class="space-y-6">

            <!-- Upcoming Deadlines -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30 bg-bronze/10">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  Upcoming Deadlines
                </h3>
              </div>
              <div class="p-4 space-y-3" id="dash-deadlines">
                <p class="text-charcoal/50 text-sm">No upcoming deadlines</p>
              </div>
            </div>

            <!-- Follow-ups Needed -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-charcoal/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                  </svg>
                  Follow-ups Needed
                </h3>
              </div>
              <div class="p-4 space-y-3" id="dash-followups">
                <p class="text-charcoal/50 text-sm">No follow-ups pending</p>
              </div>
            </div>

            <!-- Cash Flow Snapshot -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30">
                <h3 class="font-heading text-charcoal">Cash Flow (30 Days)</h3>
              </div>
              <div class="p-4 space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-charcoal/70">Expected In</span>
                  <span class="text-sm text-green-600 font-medium">+$<span id="dash-cash-in">0</span></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-charcoal/70">Expected Out</span>
                  <span class="text-sm text-red-600 font-medium">-$<span id="dash-cash-out">0</span></span>
                </div>
                <div class="border-t border-stone/30 pt-3 flex justify-between items-center">
                  <span class="text-sm text-charcoal font-medium">Net Position</span>
                  <span class="text-sm font-heading" id="dash-cash-net">$0</span>
                </div>
              </div>
            </div>

            <!-- Growth Indicator -->
            <div class="bg-gradient-to-br from-bronze/20 to-bronze/5 p-4 shadow-sm">
              <h3 class="font-heading text-charcoal mb-3">Scaling Readiness</h3>
              <div class="mb-2">
                <div class="flex justify-between text-xs mb-1">
                  <span class="text-charcoal/70">Capacity</span>
                  <span class="text-charcoal" id="dash-capacity-pct">0%</span>
                </div>
                <div class="h-2 bg-stone/50 rounded-full overflow-hidden">
                  <div class="h-full bg-bronze transition-all" id="dash-capacity-bar" style="width: 0%"></div>
                </div>
              </div>
              <p class="text-xs text-charcoal/70" id="dash-scaling-hint">Add more data to see scaling recommendations</p>
              <button onclick="openHiringCalculator()" class="mt-3 text-xs text-bronze hover:text-bronze/80 font-medium flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                Hiring Calculator →
              </button>
            </div>

            <!-- Subcontractors Quick View -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30 flex justify-between items-center">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-charcoal/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  Subcontractors
                </h3>
                <button onclick="openSubcontractorModal()" class="text-xs text-bronze hover:text-bronze/80">+ Add</button>
              </div>
              <div class="p-4 space-y-2" id="dash-subcontractors">
                <p class="text-charcoal/50 text-sm">No subcontractors tracked yet</p>
              </div>
              <div class="px-4 pb-4">
                <p class="text-xs text-charcoal/50">Track 1099 payments for year-end filing</p>
              </div>
            </div>

          </div>
        </div>

        <!-- Cash Flow Forecast Section (Full Width) -->
        <div class="mt-8 bg-cream shadow-sm">
          <div class="p-4 border-b border-stone/30 flex justify-between items-center">
            <h3 class="font-heading text-charcoal flex items-center gap-2">
              <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              90-Day Cash Flow Forecast
            </h3>
            <span class="text-xs text-charcoal/50">Based on invoices & recurring expenses</span>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-3 gap-6 mb-6">
              <div class="text-center p-4 bg-green-50 rounded">
                <p class="text-xs text-charcoal/50 mb-1">Expected Income</p>
                <p class="text-2xl font-heading text-green-600">$<span id="forecast-income">0</span></p>
                <p class="text-xs text-charcoal/50 mt-1">from outstanding invoices</p>
              </div>
              <div class="text-center p-4 bg-red-50 rounded">
                <p class="text-xs text-charcoal/50 mb-1">Projected Expenses</p>
                <p class="text-2xl font-heading text-red-600">$<span id="forecast-expenses">0</span></p>
                <p class="text-xs text-charcoal/50 mt-1">estimated outflow</p>
              </div>
              <div class="text-center p-4 bg-bronze/10 rounded">
                <p class="text-xs text-charcoal/50 mb-1">Projected Net</p>
                <p class="text-2xl font-heading" id="forecast-net">$0</p>
                <p class="text-xs text-charcoal/50 mt-1">after 90 days</p>
              </div>
            </div>
            <!-- Simple visual bar chart -->
            <div class="space-y-3" id="forecast-timeline">
              <div class="flex items-center gap-3">
                <span class="text-xs text-charcoal/50 w-20">Month 1</span>
                <div class="flex-1 h-6 bg-stone/20 rounded-full overflow-hidden flex">
                  <div class="h-full bg-green-400" id="forecast-m1-in" style="width: 0%"></div>
                  <div class="h-full bg-red-400" id="forecast-m1-out" style="width: 0%"></div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-xs text-charcoal/50 w-20">Month 2</span>
                <div class="flex-1 h-6 bg-stone/20 rounded-full overflow-hidden flex">
                  <div class="h-full bg-green-400" id="forecast-m2-in" style="width: 0%"></div>
                  <div class="h-full bg-red-400" id="forecast-m2-out" style="width: 0%"></div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-xs text-charcoal/50 w-20">Month 3</span>
                <div class="flex-1 h-6 bg-stone/20 rounded-full overflow-hidden flex">
                  <div class="h-full bg-green-400" id="forecast-m3-in" style="width: 0%"></div>
                  <div class="h-full bg-red-400" id="forecast-m3-out" style="width: 0%"></div>
                </div>
              </div>
            </div>
            <div class="flex justify-center gap-6 mt-4 text-xs">
              <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-400 rounded"></span> Income</span>
              <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-400 rounded"></span> Expenses</span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ESTIMATOR TAB -->
    <div id="tab-estimator" class="tab-content hidden">
      <!-- App Data Banner (hidden by default) -->
      <div id="app-data-banner" class="hidden bg-bronze/20 border-b border-bronze/40 py-3">
        <div class="max-w-5xl mx-auto px-6 flex items-center justify-between">
          <p class="text-charcoal text-sm flex items-center gap-2">
            <svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <strong>Room data imported from scanner.</strong> Review and adjust as needed.
          </p>
          <button id="clear-import" class="text-charcoal/60 text-sm hover:text-charcoal">Clear</button>
        </div>
      </div>

      <div class="py-8">
        <div class="max-w-5xl mx-auto px-6 space-y-6">

          <!-- Client Quick Entry -->
          <div class="bg-cream p-6 shadow-sm">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="md:col-span-2">
                <label class="block text-xs tracking-[0.15em] uppercase text-charcoal/60 mb-2">Client / Project Name</label>
                <input type="text" id="client-name" placeholder="e.g., Chen Residence - Master Bath"
                  class="w-full px-4 py-3 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal" />
              </div>
              <div>
                <label class="block text-xs tracking-[0.15em] uppercase text-charcoal/60 mb-2">Location</label>
                <input type="text" id="project-location" placeholder="Greenwich, CT"
                  class="w-full px-4 py-3 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal" />
              </div>
              <div>
                <label class="block text-xs tracking-[0.15em] uppercase text-charcoal/60 mb-2">Finish Type</label>
                <select id="finish-type" class="w-full px-4 py-3 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal">
                  {finishTypes.map(type => <option value={type}>{type}</option>)}
                </select>
              </div>
            </div>
          </div>

          <!-- Tier Selection (Compact) -->
          <div class="bg-cream p-6 shadow-sm">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-heading text-charcoal">Pricing Tier</h2>
            </div>
            <div class="grid grid-cols-3 gap-3" id="tier-selector">
              {tiers.map((tier, index) => (
                <label class="relative cursor-pointer">
                  <input type="radio" name="tier" value={tier.key} checked={index === 1} class="peer sr-only"
                    data-min={tier.min} data-max={tier.max} />
                  <div class="p-4 border-2 border-stone/40 peer-checked:border-bronze peer-checked:bg-bronze/5 transition-all text-center">
                    <h3 class="font-heading text-charcoal">{tier.name}</h3>
                    <span class="text-bronze font-medium">{tier.range}</span>
                    <span class="text-charcoal/50 text-xs">/sq ft</span>
                  </div>
                </label>
              ))}
            </div>
          </div>

          <!-- Room List -->
          <div class="bg-cream p-6 shadow-sm">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-heading text-charcoal">Rooms</h2>
              <button id="add-room-btn" class="px-4 py-2 bg-charcoal text-cream text-sm hover:bg-charcoal/80 transition-colors">
                + Add Room
              </button>
            </div>
            <div id="rooms-container" class="space-y-4">
              <!-- Rooms rendered by JS -->
            </div>
          </div>

          <!-- Cost Breakdown (Internal) -->
          <details class="bg-cream shadow-sm" open>
            <summary class="p-6 cursor-pointer flex items-center justify-between bg-charcoal/5">
              <h2 class="text-lg font-heading text-charcoal flex items-center gap-2">
                <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                Cost Breakdown
                <span class="text-xs text-charcoal/50 font-normal ml-2">(Internal Only)</span>
              </h2>
              <svg class="w-5 h-5 text-charcoal/50 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="px-6 pb-6">
              <!-- Materials -->
              <div class="mb-6">
                <h3 class="text-sm font-medium text-charcoal mb-3 flex items-center gap-2">
                  <span class="w-6 h-6 bg-bronze/20 rounded flex items-center justify-center text-bronze text-xs">1</span>
                  Material Costs (Firenzecolor)
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Base Coat</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="cost-base-coat" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Finish Plaster</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="cost-finish-plaster" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Primer/Sealer</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="cost-primer-sealer" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Pigments/Additives</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="cost-pigments" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                    </div>
                  </div>
                </div>
                <div class="mt-2 flex justify-between text-sm">
                  <span class="text-charcoal/60">Materials Subtotal</span>
                  <span class="text-charcoal font-medium">$<span id="cost-materials-total">0.00</span></span>
                </div>
              </div>

              <!-- Travel & Expenses -->
              <div class="mb-6">
                <h3 class="text-sm font-medium text-charcoal mb-3 flex items-center gap-2">
                  <span class="w-6 h-6 bg-bronze/20 rounded flex items-center justify-center text-bronze text-xs">2</span>
                  Travel & Expenses
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Miles (round trip)</label>
                    <input type="number" id="cost-miles" value="0" step="1"
                      class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Rate/mile</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="cost-mile-rate" value="0.67" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1"># of Trips</label>
                    <input type="number" id="cost-trips" value="1" step="1"
                      class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Mileage Cost</label>
                    <div class="px-2 py-2 bg-stone/30 text-charcoal font-medium text-sm">
                      $<span id="cost-mileage-total">0.00</span>
                    </div>
                  </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3">
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Lodging</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="cost-lodging" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Meals</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="cost-meals" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Equipment Rental</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="cost-equipment" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Other Expenses</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="cost-other" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                    </div>
                  </div>
                </div>
                <div class="mt-2 flex justify-between text-sm">
                  <span class="text-charcoal/60">Travel & Expenses Subtotal</span>
                  <span class="text-charcoal font-medium">$<span id="cost-travel-total">0.00</span></span>
                </div>
              </div>

              <!-- Labor -->
              <div class="mb-6">
                <h3 class="text-sm font-medium text-charcoal mb-3 flex items-center gap-2">
                  <span class="w-6 h-6 bg-bronze/20 rounded flex items-center justify-center text-bronze text-xs">3</span>
                  Labor Estimate
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Est. Days</label>
                    <input type="number" id="cost-days" value="0" step="0.5"
                      class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Daily Rate</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="cost-day-rate" value="800" step="50"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Helper Days</label>
                    <input type="number" id="cost-helper-days" value="0" step="0.5"
                      class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Helper Rate</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="cost-helper-rate" value="300" step="25"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm" />
                    </div>
                  </div>
                </div>
                <div class="mt-2 flex justify-between text-sm">
                  <span class="text-charcoal/60">Labor Subtotal</span>
                  <span class="text-charcoal font-medium">$<span id="cost-labor-total">0.00</span></span>
                </div>
              </div>

              <!-- Summary -->
              <div class="p-4 bg-charcoal rounded-lg">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                  <div>
                    <p class="text-cream/50 text-xs uppercase mb-1">Total Costs</p>
                    <p class="text-cream text-lg font-heading">$<span id="cost-total-costs">0.00</span></p>
                  </div>
                  <div>
                    <p class="text-cream/50 text-xs uppercase mb-1">Est. Revenue (Mid)</p>
                    <p class="text-cream text-lg font-heading">$<span id="cost-revenue-mid">0.00</span></p>
                  </div>
                  <div>
                    <p class="text-cream/50 text-xs uppercase mb-1">Gross Profit</p>
                    <p class="text-bronze text-lg font-heading">$<span id="cost-profit">0.00</span></p>
                  </div>
                  <div>
                    <p class="text-cream/50 text-xs uppercase mb-1">Margin</p>
                    <p class="text-bronze text-lg font-heading"><span id="cost-margin">0</span>%</p>
                  </div>
                </div>
              </div>
            </div>
          </details>

          <!-- Cost Factors (Collapsible) -->
          <details class="bg-cream shadow-sm">
            <summary class="p-6 cursor-pointer flex items-center justify-between">
              <h2 class="text-lg font-heading text-charcoal">Project Factors</h2>
              <svg class="w-5 h-5 text-charcoal/50 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="px-6 pb-6">
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="factors-form">
                {factors.map((factor) => (
                  <div>
                    <label class="block text-xs tracking-[0.1em] uppercase text-charcoal/60 mb-2">{factor.label}</label>
                    <select data-factor={factor.key}
                      class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm">
                      {factor.options.map((opt, i) => (
                        <option value={opt.value} selected={i === 0} data-low-mult={opt.lowMult} data-high-mult={opt.highMult}>
                          {opt.label}
                        </option>
                      ))}
                    </select>
                  </div>
                ))}
              </div>
              <label class="flex items-center gap-2 mt-4 cursor-pointer">
                <input type="checkbox" id="rush-timeline" class="w-4 h-4 accent-bronze" />
                <span class="text-charcoal/70 text-sm">Rush timeline (+10-20%)</span>
              </label>
            </div>
          </details>

          <!-- Live Estimate Summary -->
          <div class="bg-charcoal p-6 sticky bottom-0">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-8">
                <div>
                  <p class="text-cream/50 text-xs uppercase tracking-wide">Total Area</p>
                  <p class="text-2xl font-heading text-cream"><span id="total-sqft">0</span> <span class="text-sm text-cream/50">sq ft</span></p>
                </div>
                <div>
                  <p class="text-cream/50 text-xs uppercase tracking-wide">Estimate Range</p>
                  <p class="text-2xl font-heading text-bronze">$<span id="low-estimate">0</span> – $<span id="high-estimate">0</span></p>
                </div>
              </div>
              <div class="flex gap-3">
                <button id="save-estimate-btn" class="px-6 py-3 border border-cream/30 text-cream text-sm hover:bg-cream/10 transition-colors">
                  Save Draft
                </button>
                <button id="generate-quote-btn" class="px-6 py-3 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90 transition-colors">
                  Generate Quote
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- LEADS & CRM TAB -->
    <div id="tab-leads" class="tab-content hidden">
      <div class="max-w-7xl mx-auto px-6 py-8">

        <!-- Header with Add Lead button -->
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-xl font-heading text-charcoal">Leads & Pipeline</h2>
            <p class="text-charcoal/60 text-sm">Track prospects from first contact to closed deal</p>
          </div>
          <button onclick="openNewLeadModal()" class="px-4 py-2 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90 transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Lead
          </button>
        </div>

        <!-- Pipeline Stats -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">New Leads</p>
            <p class="text-2xl font-heading text-charcoal"><span id="lead-count-new">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Contacted</p>
            <p class="text-2xl font-heading text-blue-600"><span id="lead-count-contacted">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Site Visit</p>
            <p class="text-2xl font-heading text-purple-600"><span id="lead-count-visit">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Quote Sent</p>
            <p class="text-2xl font-heading text-bronze"><span id="lead-count-quoted">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Won</p>
            <p class="text-2xl font-heading text-green-600"><span id="lead-count-won">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Lost</p>
            <p class="text-2xl font-heading text-red-600"><span id="lead-count-lost">0</span></p>
          </div>
        </div>

        <!-- Pipeline Value -->
        <div class="bg-bronze/10 p-4 mb-6 flex items-center justify-between">
          <div>
            <p class="text-sm text-charcoal/70">Total Pipeline Value</p>
            <p class="text-2xl font-heading text-charcoal">$<span id="lead-pipeline-value">0</span></p>
          </div>
          <div class="text-right">
            <p class="text-sm text-charcoal/70">Weighted Value (probability adjusted)</p>
            <p class="text-2xl font-heading text-bronze">$<span id="lead-weighted-value">0</span></p>
          </div>
        </div>

        <!-- Kanban-style Pipeline View -->
        <div class="grid md:grid-cols-4 gap-4 mb-8">
          <!-- New -->
          <div class="bg-stone/50 p-3">
            <h3 class="text-sm font-medium text-charcoal mb-3 flex items-center gap-2">
              <span class="w-2 h-2 bg-charcoal rounded-full"></span>
              New Inquiry
            </h3>
            <div class="space-y-2" id="pipeline-new"></div>
          </div>
          <!-- Contacted -->
          <div class="bg-blue-50 p-3">
            <h3 class="text-sm font-medium text-charcoal mb-3 flex items-center gap-2">
              <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
              Contacted
            </h3>
            <div class="space-y-2" id="pipeline-contacted"></div>
          </div>
          <!-- Site Visit -->
          <div class="bg-purple-50 p-3">
            <h3 class="text-sm font-medium text-charcoal mb-3 flex items-center gap-2">
              <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
              Site Visit Scheduled
            </h3>
            <div class="space-y-2" id="pipeline-visit"></div>
          </div>
          <!-- Quote Sent -->
          <div class="bg-bronze/10 p-3">
            <h3 class="text-sm font-medium text-charcoal mb-3 flex items-center gap-2">
              <span class="w-2 h-2 bg-bronze rounded-full"></span>
              Quote Sent
            </h3>
            <div class="space-y-2" id="pipeline-quoted"></div>
          </div>
        </div>

        <!-- Follow-up Queue -->
        <div class="bg-cream shadow-sm mb-6">
          <div class="p-4 border-b border-stone/30 bg-red-50 flex justify-between items-center">
            <h3 class="font-heading text-charcoal flex items-center gap-2">
              <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Needs Follow-up
            </h3>
            <span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full" id="followup-count">0 overdue</span>
          </div>
          <div class="p-4" id="lead-followups">
            <p class="text-charcoal/50 text-sm">No follow-ups needed</p>
          </div>
        </div>

        <!-- Lead Source Analytics -->
        <div class="bg-cream shadow-sm">
          <div class="p-4 border-b border-stone/30">
            <h3 class="font-heading text-charcoal">Lead Sources</h3>
          </div>
          <div class="p-4 grid md:grid-cols-2 gap-6">
            <div>
              <h4 class="text-sm text-charcoal/70 mb-3">Where leads come from</h4>
              <div class="space-y-2" id="lead-sources">
                <p class="text-charcoal/50 text-sm">No data yet</p>
              </div>
            </div>
            <div>
              <h4 class="text-sm text-charcoal/70 mb-3">Best converting sources</h4>
              <div class="space-y-2" id="lead-conversions">
                <p class="text-charcoal/50 text-sm">No data yet</p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- PROJECTS TAB -->
    <div id="tab-projects" class="tab-content hidden">
      <div class="py-8">
        <div class="max-w-6xl mx-auto px-6">

          <!-- Project Stats Bar -->
          <div class="grid grid-cols-4 gap-4 mb-8">
            <div class="bg-cream p-5 shadow-sm">
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-1">Active</p>
              <p class="text-3xl font-heading text-charcoal" id="active-count">4</p>
            </div>
            <div class="bg-cream p-5 shadow-sm">
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-1">Pending Quote</p>
              <p class="text-3xl font-heading text-bronze" id="pending-count">2</p>
            </div>
            <div class="bg-cream p-5 shadow-sm">
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-1">This Month</p>
              <p class="text-3xl font-heading text-charcoal" id="month-count">3</p>
            </div>
            <div class="bg-cream p-5 shadow-sm">
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-1">YTD Completed</p>
              <p class="text-3xl font-heading text-charcoal" id="ytd-count">12</p>
            </div>
          </div>

          <!-- Project List -->
          <div class="bg-cream shadow-sm">
            <div class="p-6 border-b border-stone/30 flex items-center justify-between">
              <h2 class="text-lg font-heading text-charcoal">Projects</h2>
              <div class="flex gap-2">
                <select class="px-3 py-2 border border-stone/50 text-sm text-charcoal">
                  <option>All Status</option>
                  <option>Active</option>
                  <option>Pending</option>
                  <option>Completed</option>
                </select>
              </div>
            </div>

            <div id="projects-list" class="divide-y divide-stone/30">
              <!-- Projects rendered by JS -->
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- INVOICING TAB -->
    <div id="tab-invoices" class="tab-content hidden">
      <div class="max-w-7xl mx-auto px-6 py-8">

        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-xl font-heading text-charcoal">Invoicing & Payments</h2>
            <p class="text-charcoal/60 text-sm">Create invoices, track payments, manage cash flow</p>
          </div>
          <button onclick="openNewInvoiceModal()" class="px-4 py-2 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90 transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Create Invoice
          </button>
        </div>

        <!-- AR Summary -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Total Invoiced YTD</p>
            <p class="text-2xl font-heading text-charcoal">$<span id="inv-total-ytd">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Paid</p>
            <p class="text-2xl font-heading text-green-600">$<span id="inv-total-paid">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm border-l-4 border-bronze">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Outstanding</p>
            <p class="text-2xl font-heading text-bronze">$<span id="inv-outstanding">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm border-l-4 border-red-500">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Overdue</p>
            <p class="text-2xl font-heading text-red-600">$<span id="inv-overdue">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs uppercase tracking-wide text-charcoal/50 mb-1">Avg Days to Pay</p>
            <p class="text-2xl font-heading text-charcoal"><span id="inv-avg-days">0</span></p>
          </div>
        </div>

        <!-- Aging Report -->
        <div class="bg-cream shadow-sm mb-6">
          <div class="p-4 border-b border-stone/30 bg-red-50">
            <h3 class="font-heading text-charcoal flex items-center gap-2">
              <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Accounts Receivable Aging
            </h3>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-5 gap-4 text-center mb-4">
              <div class="p-3 bg-green-50">
                <p class="text-xs text-charcoal/50 mb-1">Current</p>
                <p class="text-lg font-heading text-green-600">$<span id="ar-current">0</span></p>
              </div>
              <div class="p-3 bg-yellow-50">
                <p class="text-xs text-charcoal/50 mb-1">1-30 Days</p>
                <p class="text-lg font-heading text-yellow-600">$<span id="ar-30">0</span></p>
              </div>
              <div class="p-3 bg-orange-50">
                <p class="text-xs text-charcoal/50 mb-1">31-60 Days</p>
                <p class="text-lg font-heading text-orange-600">$<span id="ar-60">0</span></p>
              </div>
              <div class="p-3 bg-red-50">
                <p class="text-xs text-charcoal/50 mb-1">61-90 Days</p>
                <p class="text-lg font-heading text-red-600">$<span id="ar-90">0</span></p>
              </div>
              <div class="p-3 bg-red-100">
                <p class="text-xs text-charcoal/50 mb-1">90+ Days</p>
                <p class="text-lg font-heading text-red-700">$<span id="ar-90plus">0</span></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Invoice List -->
        <div class="bg-cream shadow-sm">
          <div class="p-4 border-b border-stone/30 flex justify-between items-center">
            <h3 class="font-heading text-charcoal">Recent Invoices</h3>
            <div class="flex gap-2">
              <select id="inv-filter" class="text-xs px-2 py-1 border border-stone/50 focus:border-bronze focus:outline-none">
                <option value="all">All</option>
                <option value="draft">Draft</option>
                <option value="sent">Sent</option>
                <option value="paid">Paid</option>
                <option value="overdue">Overdue</option>
              </select>
            </div>
          </div>
          <div class="divide-y divide-stone/30" id="invoice-list">
            <div class="p-4 text-charcoal/50 text-sm">No invoices yet. Create your first invoice to get started.</div>
          </div>
        </div>

        <!-- Quick Actions for Overdue -->
        <div class="mt-6 bg-gradient-to-r from-red-50 to-orange-50 p-4 shadow-sm" id="overdue-actions" style="display: none;">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-heading text-charcoal">Overdue Invoice Actions</h3>
              <p class="text-sm text-charcoal/70">Send reminders to collect outstanding payments</p>
            </div>
            <div class="flex gap-2">
              <button onclick="sendBulkReminders()" class="px-4 py-2 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90">
                Send All Reminders
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- METRICS TAB (Legacy - kept for data) -->
    <div id="tab-metrics" class="tab-content hidden">
      <div class="py-8">
        <div class="max-w-6xl mx-auto px-6">

          <!-- Year Overview -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-cream p-6 shadow-sm">
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-2">YTD Revenue</p>
              <p class="text-4xl font-heading text-charcoal">$<span id="ytd-revenue">247,500</span></p>
              <p class="text-sm text-green-600 mt-2">+18% vs last year</p>
            </div>
            <div class="bg-cream p-6 shadow-sm">
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-2">Square Feet Applied</p>
              <p class="text-4xl font-heading text-charcoal"><span id="ytd-sqft">18,420</span></p>
              <p class="text-sm text-charcoal/50 mt-2">Across 12 projects</p>
            </div>
            <div class="bg-cream p-6 shadow-sm">
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-2">Avg Project Value</p>
              <p class="text-4xl font-heading text-bronze">$<span id="avg-project">20,625</span></p>
              <p class="text-sm text-charcoal/50 mt-2">Up from $18,200</p>
            </div>
          </div>

          <!-- Charts Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-cream p-6 shadow-sm">
              <h3 class="text-lg font-heading text-charcoal mb-4">Revenue by Month</h3>
              <div id="revenue-chart" class="h-48 flex items-end justify-between gap-2">
                <!-- Simple bar chart -->
                {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map((month, i) => {
                  const heights = [30, 45, 60, 40, 75, 55, 80, 90, 70, 85, 0, 0];
                  return (
                    <div class="flex-1 flex flex-col items-center gap-2">
                      <div class={`w-full bg-bronze/70 rounded-t transition-all ${heights[i] === 0 ? 'bg-stone/30' : ''}`}
                        style={`height: ${heights[i]}%`}></div>
                      <span class="text-xs text-charcoal/50">{month}</span>
                    </div>
                  );
                })}
              </div>
            </div>

            <div class="bg-cream p-6 shadow-sm">
              <h3 class="text-lg font-heading text-charcoal mb-4">Projects by Finish Type</h3>
              <div class="space-y-3">
                {[
                  { type: 'Venetian Plaster', count: 5, pct: 42 },
                  { type: 'Microcement', count: 3, pct: 25 },
                  { type: 'Lime Wash', count: 2, pct: 17 },
                  { type: 'Historic Restoration', count: 2, pct: 16 }
                ].map(item => (
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span class="text-charcoal">{item.type}</span>
                      <span class="text-charcoal/50">{item.count} projects</span>
                    </div>
                    <div class="h-2 bg-stone/50 rounded-full overflow-hidden">
                      <div class="h-full bg-bronze rounded-full" style={`width: ${item.pct}%`}></div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="bg-cream p-6 shadow-sm">
            <h3 class="text-lg font-heading text-charcoal mb-4">Recent Activity</h3>
            <div class="space-y-4" id="activity-feed">
              {[
                { action: 'Quote sent', project: 'Madison Beach House', time: '2 hours ago' },
                { action: 'Project completed', project: 'Westport Modern Kitchen', time: '1 day ago' },
                { action: 'New scan imported', project: 'Greenwich Colonial', time: '2 days ago' },
                { action: 'Deposit received', project: 'Guilford Estate', time: '3 days ago' }
              ].map(item => (
                <div class="flex items-center gap-4 py-2 border-b border-stone/20 last:border-0">
                  <div class="w-2 h-2 bg-bronze rounded-full"></div>
                  <div class="flex-1">
                    <span class="text-charcoal font-medium">{item.action}</span>
                    <span class="text-charcoal/50"> — {item.project}</span>
                  </div>
                  <span class="text-charcoal/40 text-sm">{item.time}</span>
                </div>
              ))}
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- MATERIALS TAB -->
    <div id="tab-materials" class="tab-content hidden">
      <div class="py-8">
        <div class="max-w-5xl mx-auto px-6">

          <div class="bg-cream p-6 shadow-sm mb-6">
            <h2 class="text-lg font-heading text-charcoal mb-4">Material Calculator</h2>
            <p class="text-charcoal/60 text-sm mb-6">Estimate materials needed based on square footage and finish type.</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div>
                <label class="block text-xs tracking-[0.1em] uppercase text-charcoal/60 mb-2">Square Footage</label>
                <input type="number" id="mat-sqft" value="500" class="w-full px-4 py-3 border border-stone/50 focus:border-bronze focus:outline-none bg-white text-charcoal" />
              </div>
              <div>
                <label class="block text-xs tracking-[0.1em] uppercase text-charcoal/60 mb-2">Finish Type</label>
                <select id="mat-finish" class="w-full px-4 py-3 border border-stone/50 focus:border-bronze focus:outline-none bg-white text-charcoal">
                  <option value="venetian">Venetian Plaster</option>
                  <option value="limewash">Lime Wash</option>
                  <option value="microcement">Microcement</option>
                  <option value="tadelakt">Tadelakt</option>
                </select>
              </div>
              <div>
                <label class="block text-xs tracking-[0.1em] uppercase text-charcoal/60 mb-2">Number of Coats</label>
                <select id="mat-coats" class="w-full px-4 py-3 border border-stone/50 focus:border-bronze focus:outline-none bg-white text-charcoal">
                  <option value="2">2 coats</option>
                  <option value="3" selected>3 coats</option>
                  <option value="4">4 coats</option>
                </select>
              </div>
            </div>

            <button id="calc-materials-btn" class="px-6 py-3 bg-charcoal text-cream text-sm hover:bg-charcoal/80 transition-colors">
              Calculate Materials
            </button>
          </div>

          <!-- Material Results -->
          <div id="material-results" class="bg-cream p-6 shadow-sm">
            <h3 class="text-lg font-heading text-charcoal mb-4">Estimated Materials for 500 sq ft</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="p-4 bg-stone/30 rounded">
                <p class="text-charcoal/50 text-xs uppercase mb-1">Base Coat</p>
                <p class="text-2xl font-heading text-charcoal">3 <span class="text-sm">bags</span></p>
              </div>
              <div class="p-4 bg-stone/30 rounded">
                <p class="text-charcoal/50 text-xs uppercase mb-1">Finish Coat</p>
                <p class="text-2xl font-heading text-charcoal">2.5 <span class="text-sm">buckets</span></p>
              </div>
              <div class="p-4 bg-stone/30 rounded">
                <p class="text-charcoal/50 text-xs uppercase mb-1">Primer</p>
                <p class="text-2xl font-heading text-charcoal">2 <span class="text-sm">gallons</span></p>
              </div>
              <div class="p-4 bg-stone/30 rounded">
                <p class="text-charcoal/50 text-xs uppercase mb-1">Sealer</p>
                <p class="text-2xl font-heading text-charcoal">1.5 <span class="text-sm">gallons</span></p>
              </div>
            </div>
            <p class="text-charcoal/50 text-sm mt-4">* Estimates include 10% waste factor</p>
          </div>

          <!-- Inventory Quick Check -->
          <div class="bg-cream p-6 shadow-sm mt-6">
            <h3 class="text-lg font-heading text-charcoal mb-4">Current Inventory</h3>
            <p class="text-charcoal/60 text-sm mb-4">Track your material stock levels.</p>
            <div class="space-y-3">
              {[
                { item: 'Grassello di Calce', stock: 8, unit: 'buckets', low: false },
                { item: 'Marmorino Fine', stock: 3, unit: 'buckets', low: true },
                { item: 'Microcement Base', stock: 12, unit: 'bags', low: false },
                { item: 'Tadelakt Powder', stock: 2, unit: 'bags', low: true },
                { item: 'Protective Sealer', stock: 6, unit: 'gallons', low: false }
              ].map(item => (
                <div class="flex items-center justify-between py-2 border-b border-stone/20">
                  <span class="text-charcoal">{item.item}</span>
                  <div class="flex items-center gap-3">
                    <span class={`text-sm ${item.low ? 'text-red-500 font-medium' : 'text-charcoal/60'}`}>
                      {item.stock} {item.unit}
                    </span>
                    {item.low && <span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded">Low Stock</span>}
                  </div>
                </div>
              ))}
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- WEBSITE IMAGES TAB -->
    <div id="tab-images" class="tab-content hidden">
      <div class="py-8">
        <div class="max-w-6xl mx-auto px-6">

          <!-- Page Selector -->
          <div class="bg-cream p-4 shadow-sm mb-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-lg font-heading text-charcoal">Website Image Manager</h2>
              <div class="flex gap-2">
                <button id="export-images-btn" class="px-4 py-2 bg-bronze text-charcoal text-sm hover:bg-bronze/90 transition-colors">
                  Export Mapping
                </button>
                <button id="clear-images-btn" class="px-4 py-2 border border-charcoal/30 text-charcoal text-sm hover:bg-charcoal/10 transition-colors">
                  Clear All
                </button>
              </div>
            </div>
            <div class="flex flex-wrap gap-2" id="image-page-tabs">
              <button class="img-page-tab active px-3 py-1.5 text-sm bg-bronze text-charcoal" data-imgpage="homepage">Homepage</button>
              <button class="img-page-tab px-3 py-1.5 text-sm bg-stone text-charcoal/70 hover:bg-stone/80" data-imgpage="preparation">Preparation</button>
              <button class="img-page-tab px-3 py-1.5 text-sm bg-stone text-charcoal/70 hover:bg-stone/80" data-imgpage="finishes">Finishes</button>
              <button class="img-page-tab px-3 py-1.5 text-sm bg-stone text-charcoal/70 hover:bg-stone/80" data-imgpage="work">Portfolio</button>
              <button class="img-page-tab px-3 py-1.5 text-sm bg-stone text-charcoal/70 hover:bg-stone/80" data-imgpage="showroom">Material Library</button>
              <button class="img-page-tab px-3 py-1.5 text-sm bg-stone text-charcoal/70 hover:bg-stone/80" data-imgpage="about">About</button>
              <button class="img-page-tab px-3 py-1.5 text-sm bg-stone text-charcoal/70 hover:bg-stone/80" data-imgpage="professionals">Professionals</button>
              <button class="img-page-tab px-3 py-1.5 text-sm bg-stone text-charcoal/70 hover:bg-stone/80" data-imgpage="contact">Contact</button>
              <button class="img-page-tab px-3 py-1.5 text-sm bg-stone text-charcoal/70 hover:bg-stone/80" data-imgpage="care">Care</button>
            </div>
          </div>

          <!-- Progress -->
          <div class="bg-cream p-4 shadow-sm mb-6">
            <div class="flex items-center justify-between mb-2">
              <span class="text-charcoal/60 text-sm">Progress</span>
              <span class="text-charcoal text-sm font-medium" id="img-progress-text">0 / 0 images</span>
            </div>
            <div class="h-2 bg-stone rounded-full overflow-hidden">
              <div id="img-progress-bar" class="h-full bg-bronze transition-all" style="width: 0%"></div>
            </div>
          </div>

          <!-- Image Grid -->
          <div id="image-slots-container" class="bg-cream p-6 shadow-sm">
            <!-- Rendered by JS -->
          </div>

        </div>
      </div>

      <!-- Image Assignment Modal -->
      <div id="img-modal" class="fixed inset-0 bg-charcoal/80 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-cream max-w-md w-full mx-4 p-6 shadow-2xl">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-heading text-charcoal" id="img-modal-title">Add Image</h3>
            <button id="close-img-modal" class="text-charcoal/50 hover:text-charcoal">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <p class="text-charcoal/60 text-sm mb-4" id="img-modal-desc"></p>

          <!-- Drag Drop Zone -->
          <div id="drop-zone" class="border-2 border-dashed border-charcoal/30 p-8 text-center mb-4 hover:border-bronze hover:bg-bronze/5 transition-all cursor-pointer">
            <svg class="w-10 h-10 text-charcoal/30 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <p class="text-charcoal/60 text-sm">Drag & drop image here</p>
            <p class="text-charcoal/40 text-xs mt-1">or click to browse</p>
            <input type="file" id="img-file-input" accept="image/*" class="hidden" />
          </div>

          <div class="flex items-center gap-3 mb-4">
            <div class="flex-1 h-px bg-charcoal/20"></div>
            <span class="text-charcoal/40 text-xs">OR</span>
            <div class="flex-1 h-px bg-charcoal/20"></div>
          </div>

          <!-- Path Input -->
          <div>
            <label class="block text-xs text-charcoal/60 mb-1">Image path from public/images/</label>
            <div class="flex gap-2">
              <input type="text" id="img-path-input" placeholder="Website/20241024_135059.jpg"
                class="flex-1 px-3 py-2 border border-charcoal/20 text-sm focus:border-bronze focus:outline-none" />
              <button id="img-path-submit" class="px-4 py-2 bg-charcoal text-cream text-sm hover:bg-charcoal/90">Use</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACCOUNTING TAB -->
    <div id="tab-accounting" class="tab-content hidden">
      <div class="max-w-7xl mx-auto px-6 py-8 space-y-6">

        <!-- Header with Tax Year -->
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-heading text-charcoal">Business Accounting</h2>
            <p class="text-charcoal/60 text-sm">Real-time tax insights for artisan contractors</p>
          </div>
          <div class="flex items-center gap-3">
            <label class="text-sm text-charcoal/60">Tax Year</label>
            <select id="acct-tax-year" class="px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm">
              <option value="2026" selected>2026</option>
              <option value="2025">2025</option>
              <option value="2024">2024</option>
            </select>
          </div>
        </div>

        <!-- Quick Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs text-charcoal/50 uppercase tracking-wide">Gross Revenue</p>
            <p class="text-2xl font-heading text-charcoal">$<span id="acct-gross-revenue">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs text-charcoal/50 uppercase tracking-wide">Total Expenses</p>
            <p class="text-2xl font-heading text-charcoal">$<span id="acct-total-expenses">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs text-charcoal/50 uppercase tracking-wide">Net Profit</p>
            <p class="text-2xl font-heading text-bronze">$<span id="acct-net-profit">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs text-charcoal/50 uppercase tracking-wide">Tax Liability (Est.)</p>
            <p class="text-2xl font-heading text-red-600">$<span id="acct-tax-liability">0</span></p>
          </div>
          <div class="bg-cream p-4 shadow-sm">
            <p class="text-xs text-charcoal/50 uppercase tracking-wide">Effective Rate</p>
            <p class="text-2xl font-heading text-charcoal"><span id="acct-effective-rate">0</span>%</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

          <!-- LEFT COLUMN: Income & Expenses -->
          <div class="lg:col-span-2 space-y-6">

            <!-- Income Tracking -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30 flex items-center justify-between">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Income
                </h3>
                <button id="add-income-btn" class="text-sm text-bronze hover:text-bronze/80">+ Add Income</button>
              </div>
              <div class="p-4">
                <div id="income-list" class="space-y-2 mb-4">
                  <!-- Income entries rendered by JS -->
                </div>
                <div class="flex justify-between text-sm pt-3 border-t border-stone/30">
                  <span class="text-charcoal/60">YTD Total</span>
                  <span class="text-charcoal font-heading text-lg">$<span id="acct-income-total">0</span></span>
                </div>
              </div>
            </div>

            <!-- Deductible Expenses -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30 flex items-center justify-between">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2zM10 8.5a.5.5 0 11-1 0 .5.5 0 011 0zm5 5a.5.5 0 11-1 0 .5.5 0 011 0z" />
                  </svg>
                  Deductible Expenses
                </h3>
                <button id="add-expense-btn" class="text-sm text-bronze hover:text-bronze/80">+ Add Expense</button>
              </div>
              <div class="p-4">
                <!-- Expense Categories -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Materials & Supplies</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-exp-materials" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">100% deductible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Tools & Equipment</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-exp-tools" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">Section 179 eligible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Vehicle/Mileage</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-exp-vehicle" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">$0.67/mile (2024 rate)</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Insurance</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-exp-insurance" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">100% deductible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Professional Services</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-exp-professional" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-charcoal/40 mt-1">Legal, accounting, etc.</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Marketing & Website</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-exp-marketing" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">100% deductible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Travel & Lodging</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-exp-travel" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">100% if business</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Meals (Business)</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-exp-meals" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-amber-600 mt-1">50% deductible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Phone & Internet</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-exp-phone" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-charcoal/40 mt-1">Business % only</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Other Expenses</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-exp-other" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                  </div>
                </div>
                <div class="flex justify-between text-sm pt-3 border-t border-stone/30">
                  <span class="text-charcoal/60">Total Deductions</span>
                  <span class="text-charcoal font-heading text-lg">$<span id="acct-deductions-total">0</span></span>
                </div>
              </div>
            </div>

            <!-- Mileage Log -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30 flex items-center justify-between">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                  </svg>
                  Mileage Log
                </h3>
                <span class="text-xs text-charcoal/50">IRS Rate: $0.67/mile</span>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-3 gap-4 mb-4">
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Total Business Miles</label>
                    <input type="number" id="acct-mileage-total" value="0" step="1"
                      class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">IRS Rate</label>
                    <div class="px-2 py-2 bg-stone/30 text-charcoal text-sm">$0.67</div>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Mileage Deduction</label>
                    <div class="px-2 py-2 bg-green-50 text-green-700 font-medium text-sm">$<span id="acct-mileage-deduction">0</span></div>
                  </div>
                </div>
                <p class="text-xs text-charcoal/50">
                  💡 Keep a mileage log! Record date, destination, business purpose, and miles for each trip.
                </p>
              </div>
            </div>

            <!-- Home Office Deduction -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                  </svg>
                  Home Office Deduction
                </h3>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Office Sq Ft</label>
                    <input type="number" id="acct-office-sqft" value="0" step="1"
                      class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Home Sq Ft</label>
                    <input type="number" id="acct-home-sqft" value="0" step="1"
                      class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Annual Home Costs</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-home-costs" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-charcoal/40 mt-1">Rent/mortgage, utilities, etc.</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Home Office Deduction</label>
                    <div class="px-2 py-2 bg-green-50 text-green-700 font-medium text-sm">$<span id="acct-home-office-deduction">0</span></div>
                  </div>
                </div>
                <div class="p-3 bg-amber-50 border border-amber-200 rounded text-xs text-amber-800">
                  <strong>Simplified Method:</strong> You can also use $5/sq ft (max 300 sq ft = $1,500).
                  Your simplified deduction: <strong>$<span id="acct-simplified-home">0</span></strong>
                </div>
              </div>
            </div>

            <!-- Studio Overhead -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30 bg-bronze/10">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                  </svg>
                  Studio / Shop Overhead
                  <span class="text-xs text-charcoal/50 font-normal ml-2">(Madison, CT)</span>
                </h3>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-2 gap-4 mb-4">
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Monthly Rent/Lease</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-studio-rent" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">100% deductible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Electricity</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-studio-electric" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">100% deductible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Gas/Heating</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-studio-gas" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">100% deductible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Water/Sewer</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-studio-water" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">100% deductible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Maintenance & Repairs</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-studio-maintenance" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">100% deductible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Property Insurance</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-studio-propins" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">100% deductible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Security System</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-studio-security" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">100% deductible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Improvements/Build-out</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-studio-improvements" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-amber-600 mt-1">May depreciate over time</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Cleaning Services</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-studio-cleaning" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                    <p class="text-[10px] text-green-600 mt-1">100% deductible</p>
                  </div>
                  <div>
                    <label class="block text-xs text-charcoal/50 mb-1">Other Studio Costs</label>
                    <div class="flex">
                      <span class="px-2 py-2 bg-stone/50 text-charcoal/60 text-sm border border-r-0 border-stone/50">$</span>
                      <input type="number" id="acct-studio-other" value="0" step="0.01"
                        class="w-full px-2 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-charcoal text-sm acct-input" />
                    </div>
                  </div>
                </div>

                <!-- Customer Visits Tracking -->
                <div class="mt-4 pt-4 border-t border-stone/30">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="text-sm font-medium text-charcoal">Customer Visit Log</h4>
                    <button id="add-visit-btn" class="text-sm text-bronze hover:text-bronze/80">+ Log Visit</button>
                  </div>
                  <div class="grid grid-cols-3 gap-4 mb-3">
                    <div>
                      <label class="block text-xs text-charcoal/50 mb-1">YTD Visits</label>
                      <div class="px-2 py-2 bg-stone/30 text-charcoal font-medium text-sm">
                        <span id="acct-visit-count">0</span> visits
                      </div>
                    </div>
                    <div>
                      <label class="block text-xs text-charcoal/50 mb-1">Consultations</label>
                      <div class="px-2 py-2 bg-stone/30 text-charcoal font-medium text-sm">
                        <span id="acct-consult-count">0</span>
                      </div>
                    </div>
                    <div>
                      <label class="block text-xs text-charcoal/50 mb-1">Conversion Rate</label>
                      <div class="px-2 py-2 bg-green-50 text-green-700 font-medium text-sm">
                        <span id="acct-conversion-rate">0</span>%
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex justify-between text-sm pt-3 border-t border-stone/30">
                  <span class="text-charcoal/60">Studio Overhead (Annual)</span>
                  <span class="text-charcoal font-heading text-lg">$<span id="acct-studio-total">0</span></span>
                </div>
                <p class="text-xs text-charcoal/50 mt-2">
                  💡 Enter monthly amounts - they'll be annualized for tax calculations.
                </p>
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN: Tax Insights & Strategies -->
          <div class="space-y-6">

            <!-- Quarterly Estimated Taxes -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30 bg-red-50">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Quarterly Taxes Due
                </h3>
              </div>
              <div class="p-4">
                <div class="space-y-3 mb-4">
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-charcoal/60">Q1 (Apr 15)</span>
                    <span class="text-charcoal font-medium">$<span id="acct-q1-tax">0</span></span>
                  </div>
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-charcoal/60">Q2 (Jun 15)</span>
                    <span class="text-charcoal font-medium">$<span id="acct-q2-tax">0</span></span>
                  </div>
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-charcoal/60">Q3 (Sep 15)</span>
                    <span class="text-charcoal font-medium">$<span id="acct-q3-tax">0</span></span>
                  </div>
                  <div class="flex justify-between items-center text-sm">
                    <span class="text-charcoal/60">Q4 (Jan 15)</span>
                    <span class="text-charcoal font-medium">$<span id="acct-q4-tax">0</span></span>
                  </div>
                </div>
                <div class="pt-3 border-t border-stone/30">
                  <div class="flex justify-between items-center">
                    <span class="text-charcoal font-medium">Set Aside Monthly</span>
                    <span class="text-red-600 font-heading text-xl">$<span id="acct-monthly-setaside">0</span></span>
                  </div>
                  <p class="text-xs text-charcoal/50 mt-1">Based on current year projections</p>
                </div>
              </div>
            </div>

            <!-- Self-Employment Tax -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  Self-Employment Tax
                </h3>
              </div>
              <div class="p-4">
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-charcoal/60">Net Earnings</span>
                    <span class="text-charcoal">$<span id="acct-se-earnings">0</span></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-charcoal/60">× 92.35%</span>
                    <span class="text-charcoal">$<span id="acct-se-base">0</span></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-charcoal/60">Social Security (12.4%)</span>
                    <span class="text-charcoal">$<span id="acct-se-ss">0</span></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-charcoal/60">Medicare (2.9%)</span>
                    <span class="text-charcoal">$<span id="acct-se-medicare">0</span></span>
                  </div>
                  <div class="flex justify-between pt-2 border-t border-stone/30">
                    <span class="text-charcoal font-medium">Total SE Tax</span>
                    <span class="text-red-600 font-medium">$<span id="acct-se-total">0</span></span>
                  </div>
                  <p class="text-xs text-green-600 mt-2">
                    ✓ Deduct 50% ($<span id="acct-se-deduction">0</span>) from income tax
                  </p>
                </div>
              </div>
            </div>

            <!-- Retirement Savings -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30 bg-green-50">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  Retirement Tax Savings
                </h3>
              </div>
              <div class="p-4">
                <div class="space-y-4">
                  <div>
                    <div class="flex justify-between items-center mb-1">
                      <span class="text-sm text-charcoal">SEP-IRA Max</span>
                      <span class="text-green-600 font-medium">$<span id="acct-sep-max">0</span></span>
                    </div>
                    <p class="text-xs text-charcoal/50">25% of net self-employment income (max $69,000)</p>
                  </div>
                  <div>
                    <div class="flex justify-between items-center mb-1">
                      <span class="text-sm text-charcoal">Solo 401(k) Max</span>
                      <span class="text-green-600 font-medium">$<span id="acct-solo401k-max">0</span></span>
                    </div>
                    <p class="text-xs text-charcoal/50">$23,000 employee + 25% employer (max $69,000)</p>
                  </div>
                  <div class="p-3 bg-green-100 rounded">
                    <p class="text-sm text-green-800">
                      <strong>Tax Savings:</strong> Contributing $<span id="acct-retirement-contrib">0</span> saves approximately
                      <strong>$<span id="acct-retirement-savings">0</span></strong> in taxes.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Virtual Accountant Chat -->
            <div class="bg-charcoal text-cream shadow-sm">
              <div class="p-4 border-b border-cream/20 bg-gradient-to-r from-charcoal to-charcoal/90">
                <h3 class="font-heading flex items-center gap-2">
                  <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                  </svg>
                  Ask Your Accountant
                  <span class="text-xs text-cream/50 font-normal ml-auto">AI-Powered</span>
                </h3>
              </div>

              <!-- Chat Messages -->
              <div id="accountant-chat-messages" class="h-64 overflow-y-auto p-4 space-y-3">
                <div class="flex gap-3">
                  <div class="w-8 h-8 bg-bronze/20 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                  </div>
                  <div class="flex-1">
                    <p class="text-cream/90 text-sm">
                      Hello! I'm your virtual accountant, specializing in contractor and artisan business finances. Ask me about:
                    </p>
                    <ul class="text-cream/60 text-xs mt-2 space-y-1">
                      <li>• LLC vs S-Corp election</li>
                      <li>• Maximizing deductions</li>
                      <li>• Quarterly tax strategies</li>
                      <li>• Retirement planning (SEP-IRA, Solo 401k)</li>
                      <li>• CT-specific tax considerations</li>
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Quick Questions -->
              <div class="px-4 pb-3 flex flex-wrap gap-2">
                <button class="accountant-quick-q text-xs px-2 py-1 bg-cream/10 hover:bg-cream/20 text-cream/70 rounded transition-colors" data-q="Based on my current financials, give me a complete year-end tax strategy. What should I do before December 31st to minimize taxes?">
                  Year-End Strategy
                </button>
                <button class="accountant-quick-q text-xs px-2 py-1 bg-cream/10 hover:bg-cream/20 text-cream/70 rounded transition-colors" data-q="Looking at my income and expenses, should I elect S-Corp status? Run the numbers and show me the potential savings.">
                  S-Corp Analysis
                </button>
                <button class="accountant-quick-q text-xs px-2 py-1 bg-cream/10 hover:bg-cream/20 text-cream/70 rounded transition-colors" data-q="Based on my net profit, how much should I contribute to retirement accounts before year-end? Compare SEP-IRA vs Solo 401(k) for my situation.">
                  Retirement Max-Out
                </button>
                <button class="accountant-quick-q text-xs px-2 py-1 bg-cream/10 hover:bg-cream/20 text-cream/70 rounded transition-colors" data-q="Review my deductions and expenses. What am I missing? What purchases should I make before year-end to reduce taxes?">
                  Find Deductions
                </button>
                <button class="accountant-quick-q text-xs px-2 py-1 bg-cream/10 hover:bg-cream/20 text-cream/70 rounded transition-colors" data-q="Analyze my quarterly estimated taxes. Am I on track to avoid penalties? Should I adjust my Q4 payment?">
                  Q4 Estimated Tax
                </button>
                <button class="accountant-quick-q text-xs px-2 py-1 bg-cream/10 hover:bg-cream/20 text-cream/70 rounded transition-colors" data-q="What's my business growth strategy? Based on my revenue and profit margins, what should I invest in to scale?">
                  Growth Planning
                </button>
              </div>

              <!-- Chat Input -->
              <div class="p-4 border-t border-cream/20">
                <div class="flex gap-2">
                  <input type="text" id="accountant-chat-input"
                    placeholder="Ask about taxes, business structure, deductions..."
                    class="flex-1 px-3 py-2 bg-cream/10 border border-cream/20 text-cream text-sm placeholder-cream/40 focus:border-bronze focus:outline-none rounded" />
                  <button id="accountant-chat-send" class="px-4 py-2 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90 transition-colors rounded">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                  </button>
                </div>
                <p class="text-cream/30 text-[10px] mt-2">
                  AI advice is for informational purposes. Consult a licensed CPA for specific tax decisions.
                </p>
              </div>
            </div>

            <!-- Tax Tips -->
            <div class="bg-cream shadow-sm">
              <div class="p-4 border-b border-stone/30">
                <h3 class="font-heading text-charcoal flex items-center gap-2">
                  <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                  </svg>
                  Quick Tax Tips
                </h3>
              </div>
              <div class="p-4">
                <ul class="space-y-2 text-sm text-charcoal/70">
                  <li class="flex gap-2">
                    <span class="text-bronze">→</span>
                    <span>Track ALL receipts - even $5 purchases add up</span>
                  </li>
                  <li class="flex gap-2">
                    <span class="text-bronze">→</span>
                    <span>Use a mileage app for every job site visit</span>
                  </li>
                  <li class="flex gap-2">
                    <span class="text-bronze">→</span>
                    <span>Photo receipts - paper fades</span>
                  </li>
                  <li class="flex gap-2">
                    <span class="text-bronze">→</span>
                    <span>Pay quarterly estimates to avoid penalties</span>
                  </li>
                </ul>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>

  </div>

  <!-- NEW LEAD MODAL -->
  <div id="lead-modal" class="fixed inset-0 bg-charcoal/90 backdrop-blur-sm z-50 hidden overflow-y-auto">
    <div class="min-h-screen py-8 px-4 flex items-center justify-center">
      <div class="bg-cream w-full max-w-lg shadow-xl">
        <div class="p-4 border-b border-stone/30 flex justify-between items-center">
          <h3 class="font-heading text-charcoal text-lg">Add New Lead</h3>
          <button onclick="closeLeadModal()" class="text-charcoal/50 hover:text-charcoal">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-6 space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">First Name *</label>
              <input type="text" id="lead-firstname" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" />
            </div>
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Last Name *</label>
              <input type="text" id="lead-lastname" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" />
            </div>
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Email</label>
            <input type="email" id="lead-email" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" />
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Phone *</label>
            <input type="tel" id="lead-phone" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" />
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Address / Location</label>
            <input type="text" id="lead-address" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="City, State" />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Project Type</label>
              <select id="lead-project-type" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm">
                <option value="">Select...</option>
                <option value="venetian">Venetian Plaster</option>
                <option value="limewash">Lime Wash</option>
                <option value="tadelakt">Tadelakt</option>
                <option value="microcement">Microcement</option>
                <option value="marmorino">Marmorino</option>
                <option value="multiple">Multiple Finishes</option>
                <option value="unsure">Not Sure Yet</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Estimated Value</label>
              <input type="number" id="lead-value" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="$" />
            </div>
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Lead Source</label>
            <select id="lead-source" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm">
              <option value="website">Website</option>
              <option value="referral">Referral</option>
              <option value="instagram">Instagram</option>
              <option value="houzz">Houzz</option>
              <option value="google">Google Search</option>
              <option value="architect">Architect</option>
              <option value="designer">Interior Designer</option>
              <option value="contractor">General Contractor</option>
              <option value="repeat">Repeat Client</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Notes</label>
            <textarea id="lead-notes" rows="3" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="Project details, how they found us, timeline..."></textarea>
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Follow-up Date</label>
            <input type="date" id="lead-followup" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" />
          </div>
        </div>
        <div class="p-4 border-t border-stone/30 flex justify-end gap-3">
          <button onclick="closeLeadModal()" class="px-4 py-2 text-charcoal/70 text-sm hover:text-charcoal">Cancel</button>
          <button onclick="saveLead()" class="px-4 py-2 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90">Save Lead</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW INVOICE MODAL -->
  <div id="invoice-modal" class="fixed inset-0 bg-charcoal/90 backdrop-blur-sm z-50 hidden overflow-y-auto">
    <div class="min-h-screen py-8 px-4 flex items-center justify-center">
      <div class="bg-cream w-full max-w-2xl shadow-xl">
        <div class="p-4 border-b border-stone/30 flex justify-between items-center">
          <h3 class="font-heading text-charcoal text-lg">Create Invoice</h3>
          <button onclick="closeInvoiceModal()" class="text-charcoal/50 hover:text-charcoal">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Invoice Number</label>
              <input type="text" id="inv-number" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" />
            </div>
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Invoice Date</label>
              <input type="date" id="inv-date" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" />
            </div>
          </div>

          <!-- Client Information Section -->
          <div class="bg-stone/20 p-4 -mx-6 px-6">
            <h4 class="text-xs font-medium text-charcoal/70 uppercase tracking-wide mb-3">Client Information</h4>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-xs text-charcoal/70 block mb-1">Client Name *</label>
                <input type="text" id="inv-client" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-cream" placeholder="Select or enter name" list="client-list" />
                <datalist id="client-list"></datalist>
              </div>
              <div>
                <label class="text-xs text-charcoal/70 block mb-1">Phone</label>
                <input type="tel" id="inv-client-phone" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-cream" placeholder="(203) 555-0123" />
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-3">
              <div>
                <label class="text-xs text-charcoal/70 block mb-1">Email</label>
                <input type="email" id="inv-client-email" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-cream" placeholder="client@email.com" />
              </div>
              <div>
                <label class="text-xs text-charcoal/70 block mb-1">Address</label>
                <input type="text" id="inv-client-address" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-cream" placeholder="123 Main St, Hartford, CT" />
              </div>
            </div>
          </div>

          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Project / Job Description</label>
            <input type="text" id="inv-project" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="e.g., Living Room Venetian Plaster" />
          </div>

          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Job Site Address (if different)</label>
            <input type="text" id="inv-job-address" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="Leave blank if same as client address" />
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Line Items</label>
            <div id="inv-line-items" class="space-y-2">
              <div class="grid grid-cols-12 gap-2 items-center">
                <input type="text" class="col-span-6 px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="Description" />
                <input type="number" class="col-span-2 px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="Qty" value="1" />
                <input type="number" class="col-span-3 px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="Amount" />
                <button onclick="removeLineItem(this)" class="col-span-1 text-red-500 hover:text-red-700">×</button>
              </div>
            </div>
            <button onclick="addLineItem()" class="mt-2 text-xs text-bronze hover:text-bronze/80">+ Add Line Item</button>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Subtotal</label>
              <input type="number" id="inv-subtotal" class="w-full px-3 py-2 border border-stone/50 bg-stone/20 text-sm" readonly />
            </div>
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Tax (%)</label>
              <input type="number" id="inv-tax-rate" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" value="0" />
            </div>
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Total</label>
              <input type="number" id="inv-total" class="w-full px-3 py-2 border border-stone/50 bg-bronze/20 text-sm font-medium" readonly />
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Due Date</label>
              <input type="date" id="inv-due-date" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" />
            </div>
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Payment Terms</label>
              <select id="inv-terms" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm">
                <option value="due-on-receipt">Due on Receipt</option>
                <option value="net-15">Net 15</option>
                <option value="net-30" selected>Net 30</option>
                <option value="50-50">50% Deposit / 50% Completion</option>
                <option value="custom">Custom</option>
              </select>
            </div>
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Notes / Payment Instructions</label>
            <textarea id="inv-notes" rows="2" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="Make checks payable to Old Head Plaster LLC..."></textarea>
          </div>
        </div>
        <div class="p-4 border-t border-stone/30 flex justify-between">
          <button onclick="saveInvoiceDraft()" class="px-4 py-2 text-charcoal/70 text-sm hover:text-charcoal border border-stone/50">Save as Draft</button>
          <div class="flex gap-3">
            <button onclick="closeInvoiceModal()" class="px-4 py-2 text-charcoal/70 text-sm hover:text-charcoal">Cancel</button>
            <button onclick="saveAndSendInvoice()" class="px-4 py-2 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90">Save & Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QUICK EXPENSE MODAL -->
  <div id="expense-modal" class="fixed inset-0 bg-charcoal/90 backdrop-blur-sm z-50 hidden overflow-y-auto">
    <div class="min-h-screen py-8 px-4 flex items-center justify-center">
      <div class="bg-cream w-full max-w-md shadow-xl">
        <div class="p-4 border-b border-stone/30 flex justify-between items-center">
          <h3 class="font-heading text-charcoal text-lg">Log Expense</h3>
          <button onclick="closeExpenseModal()" class="text-charcoal/50 hover:text-charcoal">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Category</label>
            <select id="exp-category" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm">
              <option value="materials">Materials & Supplies</option>
              <option value="tools">Tools & Equipment</option>
              <option value="vehicle">Vehicle / Gas</option>
              <option value="mileage">Mileage</option>
              <option value="insurance">Insurance</option>
              <option value="professional">Professional Services</option>
              <option value="marketing">Marketing</option>
              <option value="travel">Travel</option>
              <option value="meals">Business Meals</option>
              <option value="phone">Phone & Internet</option>
              <option value="studio">Studio Overhead</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div id="exp-mileage-fields" style="display: none;">
            <label class="text-xs text-charcoal/70 block mb-1">Miles Driven</label>
            <input type="number" id="exp-miles" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="e.g., 45" />
            <p class="text-xs text-charcoal/50 mt-1">@ $0.67/mile = $<span id="exp-mileage-calc">0</span></p>
          </div>
          <div id="exp-amount-field">
            <label class="text-xs text-charcoal/70 block mb-1">Amount</label>
            <input type="number" id="exp-amount" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="$" step="0.01" />
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Date</label>
            <input type="date" id="exp-date" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" />
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Description / Vendor</label>
            <input type="text" id="exp-description" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="e.g., Home Depot - plaster supplies" />
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Project (optional)</label>
            <select id="exp-project" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm">
              <option value="">General / Overhead</option>
            </select>
          </div>
        </div>
        <div class="p-4 border-t border-stone/30 flex justify-end gap-3">
          <button onclick="closeExpenseModal()" class="px-4 py-2 text-charcoal/70 text-sm hover:text-charcoal">Cancel</button>
          <button onclick="saveExpense()" class="px-4 py-2 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90">Save Expense</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADD TASK MODAL -->
  <div id="task-modal" class="fixed inset-0 bg-charcoal/90 backdrop-blur-sm z-50 hidden overflow-y-auto">
    <div class="min-h-screen py-8 px-4 flex items-center justify-center">
      <div class="bg-cream w-full max-w-md shadow-xl">
        <div class="p-4 border-b border-stone/30 flex justify-between items-center">
          <h3 class="font-heading text-charcoal text-lg">Add Task</h3>
          <button onclick="closeTaskModal()" class="text-charcoal/50 hover:text-charcoal">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Task</label>
            <input type="text" id="task-title" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="What needs to be done?" />
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Due Date</label>
            <input type="date" id="task-due" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" />
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Priority</label>
            <select id="task-priority" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Related To</label>
            <select id="task-related" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm">
              <option value="">General</option>
              <option value="lead">Lead / Client</option>
              <option value="project">Project</option>
              <option value="invoice">Invoice</option>
              <option value="tax">Tax / Accounting</option>
            </select>
          </div>
        </div>
        <div class="p-4 border-t border-stone/30 flex justify-end gap-3">
          <button onclick="closeTaskModal()" class="px-4 py-2 text-charcoal/70 text-sm hover:text-charcoal">Cancel</button>
          <button onclick="saveTask()" class="px-4 py-2 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90">Add Task</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SMART REMINDERS PANEL (slides from right) -->
  <div id="reminders-panel" class="fixed inset-y-0 right-0 w-full max-w-md bg-cream shadow-xl z-50 transform translate-x-full transition-transform duration-300">
    <div class="h-full flex flex-col">
      <div class="p-4 border-b border-stone/30 flex justify-between items-center bg-bronze/10">
        <h3 class="font-heading text-charcoal text-lg flex items-center gap-2">
          <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
          Reminders & Alerts
        </h3>
        <button onclick="closeRemindersPanel()" class="text-charcoal/50 hover:text-charcoal">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-4 space-y-4" id="reminders-list">
        <p class="text-charcoal/50 text-sm">Loading reminders...</p>
      </div>
    </div>
  </div>

  <!-- HIRING CALCULATOR MODAL -->
  <div id="hiring-modal" class="fixed inset-0 bg-charcoal/90 backdrop-blur-sm z-50 hidden overflow-y-auto">
    <div class="min-h-screen py-8 px-4 flex items-center justify-center">
      <div class="bg-cream w-full max-w-2xl shadow-xl">
        <div class="p-4 border-b border-stone/30 flex justify-between items-center bg-bronze/10">
          <h3 class="font-heading text-charcoal text-lg flex items-center gap-2">
            <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            Hiring Calculator
          </h3>
          <button onclick="closeHiringCalculator()" class="text-charcoal/50 hover:text-charcoal">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-6 space-y-6">
          <div class="bg-stone/20 p-4 rounded">
            <p class="text-sm text-charcoal/70">Based on your current revenue and workload, here's when you should consider hiring.</p>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Current Monthly Revenue</label>
              <input type="number" id="hire-revenue" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-white text-charcoal" placeholder="15000" />
            </div>
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Hours Worked/Week</label>
              <input type="number" id="hire-hours" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-white text-charcoal" value="50" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Jobs Turned Away/Month</label>
              <input type="number" id="hire-declined" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-white text-charcoal" placeholder="2" />
            </div>
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Lead Wait Time (days)</label>
              <input type="number" id="hire-wait" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-white text-charcoal" placeholder="14" />
            </div>
          </div>

          <button onclick="calculateHiring()" class="w-full px-4 py-3 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90">
            Analyze Hiring Readiness
          </button>

          <div id="hiring-results" class="hidden space-y-4">
            <h4 class="font-heading text-charcoal">Analysis Results</h4>

            <div class="p-4 rounded" id="hiring-verdict">
              <!-- Will be filled by JS -->
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div class="p-3 bg-stone/20 rounded">
                <p class="text-xs text-charcoal/50 mb-1">Revenue/Hour</p>
                <p class="text-lg font-heading text-charcoal" id="hire-per-hour">$0</p>
              </div>
              <div class="p-3 bg-stone/20 rounded">
                <p class="text-xs text-charcoal/50 mb-1">Opportunity Cost</p>
                <p class="text-lg font-heading text-red-600" id="hire-opportunity">$0/mo</p>
              </div>
            </div>

            <div class="p-4 bg-bronze/10 rounded">
              <h5 class="text-sm font-medium text-charcoal mb-2">Recommended First Hire:</h5>
              <p class="text-charcoal" id="hire-recommendation">--</p>
              <p class="text-xs text-charcoal/70 mt-2" id="hire-reasoning">--</p>
            </div>

            <div class="p-4 border border-stone/30 rounded">
              <h5 class="text-sm font-medium text-charcoal mb-2">When to Hire:</h5>
              <ul class="text-sm text-charcoal/70 space-y-1" id="hire-triggers">
                <li>• Consistently working 50+ hours/week</li>
                <li>• Turning away 2+ jobs/month</li>
                <li>• Lead wait time exceeds 3 weeks</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SUBCONTRACTOR MODAL -->
  <div id="subcontractor-modal" class="fixed inset-0 bg-charcoal/90 backdrop-blur-sm z-50 hidden overflow-y-auto">
    <div class="min-h-screen py-8 px-4 flex items-center justify-center">
      <div class="bg-cream w-full max-w-lg shadow-xl">
        <div class="p-4 border-b border-stone/30 flex justify-between items-center">
          <h3 class="font-heading text-charcoal text-lg">Add Subcontractor</h3>
          <button onclick="closeSubcontractorModal()" class="text-charcoal/50 hover:text-charcoal">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Name *</label>
            <input type="text" id="sub-name" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-white text-charcoal" placeholder="John Smith" />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Phone</label>
              <input type="tel" id="sub-phone" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-white text-charcoal" placeholder="(203) 555-0123" />
            </div>
            <div>
              <label class="text-xs text-charcoal/70 block mb-1">Email</label>
              <input type="email" id="sub-email" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-white text-charcoal" placeholder="john@email.com" />
            </div>
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Trade / Specialty</label>
            <select id="sub-trade" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-white text-charcoal">
              <option value="plaster">Plaster Assistant</option>
              <option value="prep">Prep Work / Taping</option>
              <option value="paint">Painting</option>
              <option value="carpentry">Carpentry</option>
              <option value="electrical">Electrical</option>
              <option value="plumbing">Plumbing</option>
              <option value="general">General Labor</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Hourly Rate / Day Rate</label>
            <input type="text" id="sub-rate" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-white text-charcoal" placeholder="$35/hr or $280/day" />
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Tax ID (EIN or SSN) - for 1099</label>
            <input type="text" id="sub-taxid" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-white text-charcoal" placeholder="XX-XXXXXXX" />
          </div>
          <div>
            <label class="text-xs text-charcoal/70 block mb-1">Notes</label>
            <textarea id="sub-notes" rows="2" class="w-full px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm bg-white text-charcoal" placeholder="Reliability, strengths, availability..."></textarea>
          </div>

          <div class="bg-stone/20 p-3 rounded">
            <p class="text-xs text-charcoal/70">
              <strong>1099 Reminder:</strong> If you pay this subcontractor $600+ in a calendar year, you must file a 1099-NEC by January 31st.
            </p>
          </div>
        </div>
        <div class="p-4 border-t border-stone/30 flex justify-end gap-3">
          <button onclick="closeSubcontractorModal()" class="px-4 py-2 text-charcoal/70 text-sm hover:text-charcoal">Cancel</button>
          <button onclick="saveSubcontractor()" class="px-4 py-2 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90">Save Subcontractor</button>
        </div>
      </div>
    </div>
  </div>

  <!-- QUOTE PREVIEW MODAL -->
  <div id="quote-modal" class="fixed inset-0 bg-charcoal/90 backdrop-blur-sm z-50 hidden overflow-y-auto">
    <div class="min-h-screen py-8 px-4">
      <!-- Action Bar -->
      <div class="max-w-4xl mx-auto mb-4 flex items-center justify-between">
        <button id="close-quote-modal" class="flex items-center gap-2 text-cream/70 hover:text-cream transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to Estimator
        </button>
        <div class="flex items-center gap-3">
          <button id="quote-email-btn" class="flex items-center gap-2 px-4 py-2 border border-cream/30 text-cream text-sm hover:bg-cream/10 transition-colors rounded">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            Email
          </button>
          <button id="quote-sms-btn" class="flex items-center gap-2 px-4 py-2 border border-cream/30 text-cream text-sm hover:bg-cream/10 transition-colors rounded">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            SMS
          </button>
          <button id="quote-download-btn" class="flex items-center gap-2 px-4 py-2 border border-cream/30 text-cream text-sm hover:bg-cream/10 transition-colors rounded">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Download PDF
          </button>
          <button id="quote-contract-btn" class="flex items-center gap-2 px-4 py-2 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90 transition-colors rounded">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Send Contract
          </button>
        </div>
      </div>

      <!-- Quote Document -->
      <div id="quote-document" class="max-w-4xl mx-auto bg-cream shadow-2xl">
        <!-- Header -->
        <div class="bg-charcoal px-12 py-10">
          <div class="flex items-start justify-between">
            <div>
              <h1 class="text-3xl font-heading text-cream tracking-wide">OLD HEAD PLASTER</h1>
              <p class="text-bronze text-sm tracking-[0.2em] mt-1">ARTISAN DECORATIVE FINISHES</p>
            </div>
            <div class="text-right">
              <p class="text-cream/60 text-sm">Project Estimate</p>
              <p class="text-cream text-lg font-heading" id="quote-date"></p>
              <p class="text-cream/40 text-xs mt-2" id="quote-number"></p>
            </div>
          </div>
        </div>

        <!-- Client Info -->
        <div class="px-12 py-8 border-b border-stone/30">
          <div class="grid grid-cols-2 gap-8">
            <div>
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-2">Prepared For</p>
              <p class="text-charcoal text-xl font-heading" id="quote-client">Client Name</p>
              <p class="text-charcoal/70" id="quote-location">Location</p>
            </div>
            <div>
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-2">Finish Type</p>
              <p class="text-charcoal text-xl font-heading" id="quote-finish">Venetian Plaster</p>
              <p class="text-charcoal/70" id="quote-tier">Signature Tier</p>
            </div>
          </div>
        </div>

        <!-- The Process -->
        <div class="px-12 py-10 bg-stone/20">
          <h2 class="text-lg font-heading text-charcoal mb-6 flex items-center gap-3">
            <span class="w-8 h-px bg-bronze"></span>
            Our Process
          </h2>
          <div class="grid grid-cols-6 gap-4">
            <div class="text-center">
              <div class="w-12 h-12 bg-charcoal rounded-full flex items-center justify-center mx-auto mb-3">
                <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
              </div>
              <p class="text-xs font-medium text-charcoal">Consultation</p>
              <p class="text-[10px] text-charcoal/50 mt-1">Site visit & vision</p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 bg-charcoal rounded-full flex items-center justify-center mx-auto mb-3">
                <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                </svg>
              </div>
              <p class="text-xs font-medium text-charcoal">Sampling</p>
              <p class="text-[10px] text-charcoal/50 mt-1">Custom samples</p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 bg-charcoal rounded-full flex items-center justify-center mx-auto mb-3">
                <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <p class="text-xs font-medium text-charcoal">Design Lock</p>
              <p class="text-[10px] text-charcoal/50 mt-1">Final approval</p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 bg-charcoal rounded-full flex items-center justify-center mx-auto mb-3">
                <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
              </div>
              <p class="text-xs font-medium text-charcoal">Preparation</p>
              <p class="text-[10px] text-charcoal/50 mt-1">Surface prep</p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 bg-charcoal rounded-full flex items-center justify-center mx-auto mb-3">
                <svg class="w-5 h-5 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
              </div>
              <p class="text-xs font-medium text-charcoal">Application</p>
              <p class="text-[10px] text-charcoal/50 mt-1">Artisan craft</p>
            </div>
            <div class="text-center">
              <div class="w-12 h-12 bg-bronze rounded-full flex items-center justify-center mx-auto mb-3">
                <svg class="w-5 h-5 text-charcoal" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
              </div>
              <p class="text-xs font-medium text-charcoal">Reveal</p>
              <p class="text-[10px] text-charcoal/50 mt-1">Final walkthrough</p>
            </div>
          </div>
        </div>

        <!-- Scope of Work -->
        <div class="px-12 py-10 border-b border-stone/30">
          <h2 class="text-lg font-heading text-charcoal mb-6 flex items-center gap-3">
            <span class="w-8 h-px bg-bronze"></span>
            Scope of Work
          </h2>
          <div id="quote-rooms" class="space-y-3">
            <!-- Rooms rendered by JS -->
          </div>
          <div class="mt-6 pt-4 border-t border-stone/30 flex justify-between items-center">
            <span class="text-charcoal/70">Total Coverage Area</span>
            <span class="text-xl font-heading text-charcoal"><span id="quote-total-sqft">0</span> sq ft</span>
          </div>
        </div>

        <!-- Project Factors -->
        <div class="px-12 py-8 border-b border-stone/30 bg-stone/10">
          <h2 class="text-lg font-heading text-charcoal mb-4 flex items-center gap-3">
            <span class="w-8 h-px bg-bronze"></span>
            Project Considerations
          </h2>
          <div id="quote-factors" class="grid grid-cols-2 gap-x-8 gap-y-2 text-sm">
            <!-- Factors rendered by JS -->
          </div>
        </div>

        <!-- Estimate -->
        <div class="px-12 py-10 bg-charcoal">
          <div class="flex items-end justify-between">
            <div>
              <p class="text-cream/50 text-xs uppercase tracking-wide mb-2">Project Estimate Range</p>
              <p class="text-4xl font-heading text-bronze">
                $<span id="quote-low">0</span> – $<span id="quote-high">0</span>
              </p>
              <p class="text-cream/40 text-sm mt-2">Final pricing determined after site assessment</p>
            </div>
            <div class="text-right">
              <p class="text-cream/50 text-xs uppercase tracking-wide mb-2">Rate</p>
              <p class="text-cream text-lg" id="quote-rate">$55–85 /sq ft</p>
            </div>
          </div>
        </div>

        <!-- Terms & Contact -->
        <div class="px-12 py-8 grid grid-cols-2 gap-8">
          <div>
            <h3 class="text-sm font-medium text-charcoal mb-3">What's Included</h3>
            <ul class="text-sm text-charcoal/70 space-y-1">
              <li>• On-site consultation & measurements</li>
              <li>• Custom sample creation (up to 3)</li>
              <li>• All materials & specialized tools</li>
              <li>• Surface preparation & priming</li>
              <li>• Multi-coat plaster application</li>
              <li>• Protective sealer application</li>
              <li>• Final walkthrough & care guide</li>
            </ul>
          </div>
          <div>
            <h3 class="text-sm font-medium text-charcoal mb-3">Terms</h3>
            <ul class="text-sm text-charcoal/70 space-y-1">
              <li>• 50% deposit to secure scheduling</li>
              <li>• Balance due upon completion</li>
              <li>• Estimate valid for 30 days</li>
              <li>• 1-year craftsmanship warranty</li>
            </ul>
            <div class="mt-6 pt-4 border-t border-stone/30">
              <p class="text-sm text-charcoal font-medium">Questions?</p>
              <p class="text-sm text-charcoal/70">daragh@oldheadplaster.com</p>
              <p class="text-sm text-charcoal/70">(203) 555-0147</p>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="px-12 py-6 bg-stone/30 text-center">
          <p class="text-charcoal/50 text-xs">
            Old Head Plaster · Artisan Decorative Finishes · Connecticut & Tri-State Area
          </p>
          <p class="text-charcoal/40 text-xs mt-1">
            oldheadplaster.com
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTRACT MODAL -->
  <div id="contract-modal" class="fixed inset-0 bg-charcoal/95 backdrop-blur-sm z-[60] hidden overflow-y-auto">
    <div class="min-h-screen py-8 px-4">
      <!-- Action Bar -->
      <div class="max-w-4xl mx-auto mb-4 flex items-center justify-between">
        <button id="close-contract-modal" class="flex items-center gap-2 text-cream/70 hover:text-cream transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Back to Quote
        </button>
        <div class="flex items-center gap-3">
          <button id="contract-download-btn" class="flex items-center gap-2 px-4 py-2 border border-cream/30 text-cream text-sm hover:bg-cream/10 transition-colors rounded">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Download Contract
          </button>
          <button id="contract-send-btn" class="flex items-center gap-2 px-4 py-2 bg-bronze text-charcoal text-sm font-medium hover:bg-bronze/90 transition-colors rounded">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
            Send to Client
          </button>
        </div>
      </div>

      <!-- Contract Document -->
      <div id="contract-document" class="max-w-4xl mx-auto bg-cream shadow-2xl">
        <!-- Header -->
        <div class="bg-charcoal px-12 py-10">
          <div class="flex items-start justify-between">
            <div>
              <h1 class="text-3xl font-heading text-cream tracking-wide">OLD HEAD PLASTER</h1>
              <p class="text-bronze text-sm tracking-[0.2em] mt-1">ARTISAN DECORATIVE FINISHES</p>
            </div>
            <div class="text-right">
              <p class="text-cream text-xl font-heading">Service Agreement</p>
              <p class="text-cream/40 text-xs mt-2" id="contract-number"></p>
            </div>
          </div>
        </div>

        <!-- CT Home Improvement Act Required Notice -->
        <div class="px-12 py-4 bg-amber-50 border-b-2 border-amber-400">
          <p class="text-amber-800 text-xs font-medium">
            This is a Home Improvement Contract subject to the Connecticut Home Improvement Act (CGS § 20-418 et seq.)
          </p>
        </div>

        <!-- Parties -->
        <div class="px-12 py-8 border-b border-stone/30">
          <p class="text-charcoal/70 text-sm leading-relaxed mb-6">
            This Home Improvement Contract ("Agreement") is entered into as of <strong id="contract-date-inline" class="text-charcoal"></strong> by and between:
          </p>
          <div class="grid grid-cols-2 gap-8">
            <div class="p-4 bg-stone/20 rounded">
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-2">Contractor</p>
              <p class="text-charcoal font-heading">Old Head Plaster LLC</p>
              <p class="text-charcoal/70 text-sm">Madison, CT 06443</p>
              <p class="text-charcoal/70 text-sm">daragh@oldheadplaster.com</p>
              <p class="text-charcoal/70 text-sm">(203) 555-0147</p>
              <p class="text-bronze text-sm font-medium mt-2">CT HIC Reg. #<span id="contract-hic-number">0000000</span></p>
            </div>
            <div class="p-4 bg-stone/20 rounded">
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-2">Property Owner</p>
              <p class="text-charcoal font-heading" id="contract-client">Client Name</p>
              <p class="text-charcoal/70 text-sm" id="contract-location">Location</p>
              <div class="mt-2">
                <label class="block text-charcoal/50 text-xs mb-1">Email</label>
                <input type="email" id="contract-client-email" placeholder="client@email.com"
                  class="w-full px-3 py-2 border border-stone/40 text-sm focus:border-bronze focus:outline-none text-charcoal" />
              </div>
              <div class="mt-2">
                <label class="block text-charcoal/50 text-xs mb-1">Phone</label>
                <input type="tel" id="contract-client-phone" placeholder="(203) 555-0000"
                  class="w-full px-3 py-2 border border-stone/40 text-sm focus:border-bronze focus:outline-none text-charcoal" />
              </div>
            </div>
          </div>
        </div>

        <!-- Project Timeline (CT Required) -->
        <div class="px-12 py-6 border-b border-stone/30 bg-stone/10">
          <h2 class="text-lg font-heading text-charcoal mb-4">Project Timeline</h2>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="block text-charcoal/50 text-xs uppercase mb-1">Contract Date</label>
              <input type="date" id="contract-sign-date"
                class="w-full px-3 py-2 border border-stone/40 text-sm focus:border-bronze focus:outline-none text-charcoal" />
            </div>
            <div>
              <label class="block text-charcoal/50 text-xs uppercase mb-1">Estimated Start Date</label>
              <input type="date" id="contract-start-date"
                class="w-full px-3 py-2 border border-stone/40 text-sm focus:border-bronze focus:outline-none text-charcoal" />
            </div>
            <div>
              <label class="block text-charcoal/50 text-xs uppercase mb-1">Estimated Completion</label>
              <input type="date" id="contract-end-date"
                class="w-full px-3 py-2 border border-stone/40 text-sm focus:border-bronze focus:outline-none text-charcoal" />
            </div>
          </div>
          <p class="text-charcoal/50 text-xs mt-3">
            * Completion date is an estimate. Weather, material availability, and scope changes may affect timeline.
          </p>
        </div>

        <!-- Scope of Work -->
        <div class="px-12 py-8 border-b border-stone/30">
          <h2 class="text-lg font-heading text-charcoal mb-4">1. Scope of Work</h2>
          <p class="text-charcoal/70 text-sm mb-4">
            Contractor agrees to provide decorative plaster finishing services for the following areas:
          </p>
          <div id="contract-rooms" class="space-y-2 mb-4">
            <!-- Rooms rendered by JS -->
          </div>
          <div class="grid grid-cols-3 gap-4 p-4 bg-stone/20 rounded">
            <div>
              <p class="text-charcoal/50 text-xs uppercase">Total Area</p>
              <p class="text-charcoal font-heading" id="contract-sqft">0 sq ft</p>
            </div>
            <div>
              <p class="text-charcoal/50 text-xs uppercase">Finish Type</p>
              <p class="text-charcoal font-heading" id="contract-finish">Venetian Plaster</p>
            </div>
            <div>
              <p class="text-charcoal/50 text-xs uppercase">Pricing Tier</p>
              <p class="text-charcoal font-heading" id="contract-tier">Signature</p>
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="px-12 py-8 border-b border-stone/30 bg-charcoal">
          <h2 class="text-lg font-heading text-cream mb-4">2. Project Investment</h2>
          <div class="grid grid-cols-2 gap-8">
            <div>
              <p class="text-cream/50 text-xs uppercase mb-2">Estimated Range</p>
              <p class="text-3xl font-heading text-bronze">
                $<span id="contract-low">0</span> – $<span id="contract-high">0</span>
              </p>
              <p class="text-cream/40 text-sm mt-2">Final price to be confirmed after site assessment</p>
            </div>
            <div>
              <p class="text-cream/50 text-xs uppercase mb-2">Agreed Price (if applicable)</p>
              <div class="flex items-center gap-2">
                <span class="text-cream text-xl">$</span>
                <input type="text" id="contract-agreed-price" placeholder="Enter agreed price"
                  class="flex-1 px-3 py-2 bg-cream/10 border border-cream/20 text-cream text-xl font-heading focus:border-bronze focus:outline-none" />
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Terms (CT Compliant) -->
        <div class="px-12 py-8 border-b border-stone/30">
          <h2 class="text-lg font-heading text-charcoal mb-4">3. Payment Schedule</h2>
          <p class="text-charcoal/60 text-xs mb-4 italic">
            Per Connecticut Home Improvement Act, initial deposit may not exceed one-third (1/3) of total contract price.
          </p>
          <div class="space-y-3 text-sm text-charcoal/70">
            <div class="flex items-start gap-3">
              <span class="w-6 h-6 bg-bronze/20 rounded-full flex items-center justify-center text-bronze text-xs flex-shrink-0">1</span>
              <div>
                <p class="text-charcoal font-medium">Deposit: 33% upon signing</p>
                <p>Due upon execution of this agreement to secure project scheduling and order materials.</p>
                <p class="text-bronze font-medium mt-1" id="contract-deposit-amt">$0</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <span class="w-6 h-6 bg-bronze/20 rounded-full flex items-center justify-center text-bronze text-xs flex-shrink-0">2</span>
              <div>
                <p class="text-charcoal font-medium">Progress: 33% at project midpoint</p>
                <p>Due when approximately half of work is complete and materials are on site.</p>
                <p class="text-bronze font-medium mt-1" id="contract-progress-amt">$0</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <span class="w-6 h-6 bg-bronze/20 rounded-full flex items-center justify-center text-bronze text-xs flex-shrink-0">3</span>
              <div>
                <p class="text-charcoal font-medium">Final: 34% upon completion</p>
                <p>Due upon satisfactory completion and final walkthrough approval.</p>
                <p class="text-bronze font-medium mt-1" id="contract-final-amt">$0</p>
              </div>
            </div>
          </div>
          <p class="text-charcoal/50 text-xs mt-4">
            Payment accepted via check or bank transfer. Credit cards accepted with 3% processing fee.
          </p>
        </div>

        <!-- Work Includes -->
        <div class="px-12 py-8 border-b border-stone/30">
          <h2 class="text-lg font-heading text-charcoal mb-4">4. Services Included</h2>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <ul class="space-y-2 text-charcoal/70">
              <li class="flex items-center gap-2">
                <svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                On-site consultation & measurement
              </li>
              <li class="flex items-center gap-2">
                <svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                Custom sample creation (up to 3)
              </li>
              <li class="flex items-center gap-2">
                <svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                All materials & specialized tools
              </li>
              <li class="flex items-center gap-2">
                <svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                Surface preparation & priming
              </li>
            </ul>
            <ul class="space-y-2 text-charcoal/70">
              <li class="flex items-center gap-2">
                <svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                Multi-coat plaster application
              </li>
              <li class="flex items-center gap-2">
                <svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                Protective sealer application
              </li>
              <li class="flex items-center gap-2">
                <svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                Daily cleanup & final site cleaning
              </li>
              <li class="flex items-center gap-2">
                <svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                Care guide & walkthrough
              </li>
            </ul>
          </div>
        </div>

        <!-- Warranty -->
        <div class="px-12 py-8 border-b border-stone/30">
          <h2 class="text-lg font-heading text-charcoal mb-4">5. Warranty</h2>
          <p class="text-charcoal/70 text-sm">
            Contractor warrants all workmanship for a period of <strong class="text-charcoal">one (1) year</strong> from the date of completion.
            This warranty covers defects in application technique and material failure under normal use conditions.
            The warranty does not cover damage caused by improper cleaning, physical impact, or structural movement.
          </p>
        </div>

        <!-- Terms -->
        <div class="px-12 py-8 border-b border-stone/30 bg-stone/10">
          <h2 class="text-lg font-heading text-charcoal mb-4">6. Additional Terms</h2>
          <div class="text-xs text-charcoal/60 space-y-2">
            <p><strong>Access:</strong> Owner agrees to provide clear access to all work areas during scheduled work hours (typically 8am-5pm).</p>
            <p><strong>Protection:</strong> Contractor will protect surrounding surfaces with drop cloths and masking. Owner should remove or secure valuable items.</p>
            <p><strong>Scheduling:</strong> Specific start dates will be confirmed at least 2 weeks prior to commencement, subject to material availability.</p>
            <p><strong>Changes:</strong> Any changes to scope of work must be agreed upon in writing and may affect pricing and timeline. No verbal agreements.</p>
            <p><strong>Permits:</strong> Owner is responsible for obtaining any necessary building permits unless otherwise agreed in writing.</p>
            <p><strong>Disputes:</strong> Any dispute arising from this contract shall be resolved in accordance with Connecticut law. Venue shall be in the county where the work is performed.</p>
          </div>
        </div>

        <!-- CT REQUIRED: 3-Day Right to Cancel Notice -->
        <div class="px-12 py-8 border-b-4 border-amber-500 bg-amber-50">
          <h2 class="text-lg font-heading text-amber-900 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            NOTICE OF CUSTOMER'S RIGHT TO CANCEL
          </h2>
          <div class="text-sm text-amber-900 space-y-3 p-4 bg-white/50 border border-amber-300 rounded">
            <p class="font-medium">
              YOU, THE BUYER, MAY CANCEL THIS TRANSACTION AT ANY TIME PRIOR TO MIDNIGHT OF THE THIRD BUSINESS DAY AFTER THE DATE OF THIS TRANSACTION.
            </p>
            <p>
              <strong>Cancellation Deadline:</strong> <span id="contract-cancel-deadline" class="text-amber-700 font-bold">_______________</span>
            </p>
            <p class="text-xs">
              Saturday is considered a business day under Connecticut law. If you cancel, any payments made will be refunded within ten (10) days.
              No work shall begin until after the three-day cancellation period has expired.
            </p>
            <p class="text-xs">
              To cancel, mail or deliver a signed and dated copy of this cancellation notice, or any other written notice to:
            </p>
            <div class="text-xs bg-white p-3 rounded border border-amber-200 mt-2">
              <p class="font-medium">Old Head Plaster LLC</p>
              <p>Madison, CT 06443</p>
              <p>daragh@oldheadplaster.com</p>
            </div>
          </div>

          <!-- Duplicate Cancellation Form (CT Required) -->
          <div class="mt-6 p-4 border-2 border-dashed border-amber-400 bg-white">
            <p class="text-xs text-amber-700 uppercase tracking-wide mb-2 font-medium">Cancellation Form (Detach and keep)</p>
            <div class="text-sm text-charcoal/70">
              <p>I hereby cancel this transaction.</p>
              <div class="grid grid-cols-2 gap-4 mt-3">
                <div>
                  <p class="text-xs text-charcoal/50">Owner's Signature</p>
                  <div class="border-b border-charcoal/30 h-8 mt-1"></div>
                </div>
                <div>
                  <p class="text-xs text-charcoal/50">Date</p>
                  <div class="border-b border-charcoal/30 h-8 mt-1"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Signatures -->
        <div class="px-12 py-10">
          <h2 class="text-lg font-heading text-charcoal mb-6">7. Agreement</h2>
          <p class="text-charcoal/70 text-sm mb-8">
            By signing below, both parties agree to the terms and conditions outlined in this Service Agreement.
          </p>
          <div class="grid grid-cols-2 gap-12">
            <div>
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-4">Contractor</p>
              <div class="border-b-2 border-charcoal/30 pb-2 mb-2">
                <p class="font-heading text-charcoal italic">Daragh McLoughlin</p>
              </div>
              <p class="text-charcoal text-sm">Daragh McLoughlin, Owner</p>
              <p class="text-charcoal/50 text-xs" id="contract-date-contractor"></p>
            </div>
            <div>
              <p class="text-charcoal/50 text-xs uppercase tracking-wide mb-4">Client</p>
              <div class="border-b-2 border-charcoal/30 h-10 mb-2">
                <!-- Signature line -->
              </div>
              <p class="text-charcoal text-sm" id="contract-client-sig">Client Name</p>
              <p class="text-charcoal/50 text-xs">Date: _______________</p>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="px-12 py-6 bg-charcoal text-center">
          <p class="text-cream/50 text-xs">
            Old Head Plaster LLC · Madison, CT 06443 · CT HIC Registered · oldheadplaster.com
          </p>
          <p class="text-cream/30 text-[10px] mt-2">
            This contract complies with the Connecticut Home Improvement Act (CGS § 20-418 et seq.)
          </p>
        </div>
      </div>
    </div>
  </div>

  </div><!-- end main-app -->
</Layout>

<!-- html2pdf.js for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  .tab-btn {
    color: rgba(250, 250, 248, 0.5);
    border-bottom: 2px solid transparent;
  }
  .tab-btn:hover {
    color: rgba(250, 250, 248, 0.8);
  }
  .tab-btn.active {
    color: #C98821;
    border-bottom-color: #C98821;
  }

  details[open] summary svg {
    transform: rotate(180deg);
  }
</style>

<script>
  // ===== AUTHENTICATION =====
  const PASSCODE = 'AshleyFalls7';

  function initAuth() {
    const stored = sessionStorage.getItem('ohp-authenticated');
    if (stored === 'true') {
      showMainApp();
      return;
    }

    document.getElementById('login-btn')?.addEventListener('click', checkPasscode);
    document.getElementById('passcode-input')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') checkPasscode();
    });
    document.getElementById('logout-btn')?.addEventListener('click', logout);
  }

  function checkPasscode() {
    const input = document.getElementById('passcode-input');
    const error = document.getElementById('login-error');

    if (input?.value === PASSCODE) {
      sessionStorage.setItem('ohp-authenticated', 'true');
      showMainApp();
    } else {
      if (error) error.classList.remove('hidden');
      if (input) {
        input.value = '';
        input.classList.add('border-red-400');
        setTimeout(() => input.classList.remove('border-red-400'), 1000);
      }
    }
  }

  function showMainApp() {
    document.getElementById('login-screen')?.classList.add('hidden');
    document.getElementById('main-app')?.classList.remove('hidden');
  }

  function logout() {
    sessionStorage.removeItem('ohp-authenticated');
    location.reload();
  }

  // ===== STATE =====
  const state = {
    tier: 'signature',
    tierMin: 55,
    tierMax: 85,
    rooms: [
      { id: crypto.randomUUID(), name: 'Room 1', length: 12, width: 10, height: 9, includeWalls: true, includeCeiling: false }
    ],
    factors: {
      substrateCondition: { low: 0, high: 0 },
      ceilingAccess: { low: 0, high: 0 },
      finishComplexity: { low: 0, high: 0 },
      colorCustomization: { low: 0, high: 0 }
    },
    rushTimeline: false,
    projects: [
      { id: 1, name: 'Greenwich Colonial', client: 'Chen', status: 'active', sqft: 2400, value: 48000, finish: 'Venetian Plaster' },
      { id: 2, name: 'Madison Beach House', client: 'Roberts', status: 'active', sqft: 1800, value: 32000, finish: 'Lime Wash' },
      { id: 3, name: 'Westport Modern Kitchen', client: 'Anderson', status: 'pending', sqft: 650, value: 18500, finish: 'Microcement' },
      { id: 4, name: 'New Haven Restoration', client: 'Historical Society', status: 'active', sqft: 4200, value: 85000, finish: 'Historic Restoration' },
      { id: 5, name: 'Guilford Estate', client: 'Morrison', status: 'pending', sqft: 5600, value: 112000, finish: 'Venetian Plaster' },
      { id: 6, name: 'Branford Townhouse', client: 'Kim', status: 'active', sqft: 1200, value: 24000, finish: 'Lime Wash' }
    ]
  };

  // ===== TAB NAVIGATION =====
  function initTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;

        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        tabContents.forEach(content => {
          content.classList.toggle('hidden', content.id !== `tab-${tabId}`);
        });
      });
    });
  }

  // ===== ESTIMATOR FUNCTIONS =====
  function calculateRoomArea(room) {
    const wallArea = room.includeWalls ? 2 * (room.length + room.width) * room.height : 0;
    const ceilingArea = room.includeCeiling ? room.length * room.width : 0;
    return wallArea + ceilingArea;
  }

  function calculateEstimate() {
    const totalSqFt = state.rooms.reduce((sum, room) => sum + calculateRoomArea(room), 0);
    let lowMult = 1.0, highMult = 1.0;

    Object.values(state.factors).forEach(factor => {
      lowMult += factor.low;
      highMult += factor.high;
    });

    if (state.rushTimeline) { lowMult += 0.1; highMult += 0.2; }

    const scaleDiscount = totalSqFt > 2000 ? 0.95 : totalSqFt > 1000 ? 0.97 : 1.0;
    const lowEstimate = Math.round(totalSqFt * state.tierMin * lowMult * scaleDiscount);
    const highEstimate = Math.round(totalSqFt * state.tierMax * highMult * scaleDiscount);

    return { totalSqFt: Math.round(totalSqFt), lowEstimate, highEstimate };
  }

  function renderRooms() {
    const container = document.getElementById('rooms-container');
    if (!container) return;

    container.innerHTML = state.rooms.map((room) => `
      <div class="border border-stone/40 p-4 bg-stone/10" data-room-id="${room.id}">
        <div class="flex items-center justify-between mb-4">
          <input type="text" value="${room.name}" data-field="name"
            class="font-heading text-charcoal bg-transparent border-0 border-b border-transparent hover:border-stone/50 focus:border-bronze focus:outline-none px-0 py-1" />
          ${state.rooms.length > 1 ? `
            <button class="text-charcoal/30 hover:text-red-500 transition-colors remove-room">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          ` : ''}
        </div>
        <div class="grid grid-cols-6 gap-3 items-end">
          <div>
            <label class="block text-xs text-charcoal/50 mb-1">L (ft)</label>
            <input type="number" value="${room.length}" min="1" step="0.5" data-field="length"
              class="w-full px-2 py-2 border border-stone/40 focus:border-bronze focus:outline-none text-charcoal text-center" />
          </div>
          <div>
            <label class="block text-xs text-charcoal/50 mb-1">W (ft)</label>
            <input type="number" value="${room.width}" min="1" step="0.5" data-field="width"
              class="w-full px-2 py-2 border border-stone/40 focus:border-bronze focus:outline-none text-charcoal text-center" />
          </div>
          <div>
            <label class="block text-xs text-charcoal/50 mb-1">H (ft)</label>
            <input type="number" value="${room.height}" min="1" step="0.5" data-field="height"
              class="w-full px-2 py-2 border border-stone/40 focus:border-bronze focus:outline-none text-charcoal text-center" />
          </div>
          <label class="flex items-center gap-1 cursor-pointer">
            <input type="checkbox" ${room.includeWalls ? 'checked' : ''} data-field="includeWalls" class="w-4 h-4 accent-bronze" />
            <span class="text-xs text-charcoal/60">Walls</span>
          </label>
          <label class="flex items-center gap-1 cursor-pointer">
            <input type="checkbox" ${room.includeCeiling ? 'checked' : ''} data-field="includeCeiling" class="w-4 h-4 accent-bronze" />
            <span class="text-xs text-charcoal/60">Ceiling</span>
          </label>
          <div class="text-right">
            <span class="text-charcoal font-medium">${calculateRoomArea(room).toLocaleString()}</span>
            <span class="text-charcoal/50 text-xs"> sf</span>
          </div>
        </div>
      </div>
    `).join('');

    // Event listeners
    container.querySelectorAll('[data-room-id]').forEach(roomEl => {
      const roomId = roomEl.dataset.roomId;
      const room = state.rooms.find(r => r.id === roomId);
      if (!room) return;

      roomEl.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', (e) => {
          const field = e.target.dataset.field;
          if (field === 'includeWalls' || field === 'includeCeiling') {
            room[field] = e.target.checked;
          } else if (['length', 'width', 'height'].includes(field)) {
            room[field] = parseFloat(e.target.value) || 0;
          } else if (field === 'name') {
            room[field] = e.target.value;
          }
          updateSummary();
          const areaDisplay = roomEl.querySelector('.font-medium');
          if (areaDisplay) areaDisplay.textContent = calculateRoomArea(room).toLocaleString();
        });
      });

      const removeBtn = roomEl.querySelector('.remove-room');
      if (removeBtn) {
        removeBtn.addEventListener('click', () => {
          state.rooms = state.rooms.filter(r => r.id !== roomId);
          renderRooms();
          updateSummary();
        });
      }
    });
  }

  function updateSummary() {
    const estimate = calculateEstimate();
    const el = (id) => document.getElementById(id);
    if (el('total-sqft')) el('total-sqft').textContent = estimate.totalSqFt.toLocaleString();
    if (el('low-estimate')) el('low-estimate').textContent = estimate.lowEstimate.toLocaleString();
    if (el('high-estimate')) el('high-estimate').textContent = estimate.highEstimate.toLocaleString();

    // Update cost breakdown revenue
    updateCostBreakdown();
  }

  // ===== COST BREAKDOWN CALCULATOR =====
  function updateCostBreakdown() {
    const el = (id) => document.getElementById(id);
    const val = (id) => parseFloat(document.getElementById(id)?.value) || 0;

    // Materials
    const baseCoat = val('cost-base-coat');
    const finishPlaster = val('cost-finish-plaster');
    const primerSealer = val('cost-primer-sealer');
    const pigments = val('cost-pigments');
    const materialsTotal = baseCoat + finishPlaster + primerSealer + pigments;

    if (el('cost-materials-total')) {
      el('cost-materials-total').textContent = materialsTotal.toFixed(2);
    }

    // Travel & Mileage
    const miles = val('cost-miles');
    const mileRate = val('cost-mile-rate');
    const trips = val('cost-trips');
    const mileageTotal = miles * mileRate * trips;

    if (el('cost-mileage-total')) {
      el('cost-mileage-total').textContent = mileageTotal.toFixed(2);
    }

    const lodging = val('cost-lodging');
    const meals = val('cost-meals');
    const equipment = val('cost-equipment');
    const other = val('cost-other');
    const travelTotal = mileageTotal + lodging + meals + equipment + other;

    if (el('cost-travel-total')) {
      el('cost-travel-total').textContent = travelTotal.toFixed(2);
    }

    // Labor
    const days = val('cost-days');
    const dayRate = val('cost-day-rate');
    const helperDays = val('cost-helper-days');
    const helperRate = val('cost-helper-rate');
    const laborTotal = (days * dayRate) + (helperDays * helperRate);

    if (el('cost-labor-total')) {
      el('cost-labor-total').textContent = laborTotal.toFixed(2);
    }

    // Summary
    const totalCosts = materialsTotal + travelTotal + laborTotal;
    const estimate = calculateEstimate();
    const revenueMid = Math.round((estimate.lowEstimate + estimate.highEstimate) / 2);
    const profit = revenueMid - totalCosts;
    const margin = revenueMid > 0 ? Math.round((profit / revenueMid) * 100) : 0;

    if (el('cost-total-costs')) {
      el('cost-total-costs').textContent = totalCosts.toFixed(2);
    }
    if (el('cost-revenue-mid')) {
      el('cost-revenue-mid').textContent = revenueMid.toLocaleString();
    }
    if (el('cost-profit')) {
      el('cost-profit').textContent = profit.toLocaleString();
      // Color code profit - green if positive, red if negative
      el('cost-profit').parentElement.classList.toggle('text-red-400', profit < 0);
      el('cost-profit').parentElement.classList.toggle('text-bronze', profit >= 0);
    }
    if (el('cost-margin')) {
      el('cost-margin').textContent = margin;
      el('cost-margin').parentElement.classList.toggle('text-red-400', margin < 20);
      el('cost-margin').parentElement.classList.toggle('text-amber-400', margin >= 20 && margin < 40);
      el('cost-margin').parentElement.classList.toggle('text-bronze', margin >= 40);
    }
  }

  function initCostBreakdown() {
    // Add event listeners to all cost inputs
    const costInputs = [
      'cost-base-coat', 'cost-finish-plaster', 'cost-primer-sealer', 'cost-pigments',
      'cost-miles', 'cost-mile-rate', 'cost-trips', 'cost-lodging', 'cost-meals', 'cost-equipment', 'cost-other',
      'cost-days', 'cost-day-rate', 'cost-helper-days', 'cost-helper-rate'
    ];

    costInputs.forEach(id => {
      const input = document.getElementById(id);
      if (input) {
        input.addEventListener('input', updateCostBreakdown);
      }
    });

    // Initial calculation
    updateCostBreakdown();
  }

  function initEstimator() {
    // Tier selection
    document.querySelectorAll('input[name="tier"]').forEach(input => {
      input.addEventListener('change', (e) => {
        state.tier = e.target.value;
        state.tierMin = parseInt(e.target.dataset.min);
        state.tierMax = parseInt(e.target.dataset.max);
        updateSummary();
      });
    });

    // Factors
    document.querySelectorAll('[data-factor]').forEach(select => {
      select.addEventListener('change', (e) => {
        const opt = e.target.options[e.target.selectedIndex];
        state.factors[e.target.dataset.factor] = {
          low: parseFloat(opt.dataset.lowMult) || 0,
          high: parseFloat(opt.dataset.highMult) || 0
        };
        updateSummary();
      });
    });

    // Rush
    const rushCheckbox = document.getElementById('rush-timeline');
    if (rushCheckbox) {
      rushCheckbox.addEventListener('change', (e) => {
        state.rushTimeline = e.target.checked;
        updateSummary();
      });
    }

    // Add room
    const addBtn = document.getElementById('add-room-btn');
    if (addBtn) {
      addBtn.addEventListener('click', () => {
        state.rooms.push({
          id: crypto.randomUUID(),
          name: `Room ${state.rooms.length + 1}`,
          length: 12, width: 10, height: 9,
          includeWalls: true, includeCeiling: false
        });
        renderRooms();
        updateSummary();
      });
    }

    // Save/Generate buttons
    const saveBtn = document.getElementById('save-estimate-btn');
    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        const data = {
          client: document.getElementById('client-name')?.value || '',
          location: document.getElementById('project-location')?.value || '',
          finishType: document.getElementById('finish-type')?.value || '',
          tier: state.tier,
          rooms: state.rooms,
          factors: state.factors,
          estimate: calculateEstimate(),
          savedAt: new Date().toISOString()
        };
        localStorage.setItem('ohp-draft-estimate', JSON.stringify(data));
        alert('Draft saved!');
      });
    }

    const generateBtn = document.getElementById('generate-quote-btn');
    if (generateBtn) {
      generateBtn.addEventListener('click', openQuoteModal);
    }
  }

  // ===== QUOTE MODAL =====
  const tierNames = { foundation: 'Foundation', signature: 'Signature', bespoke: 'Bespoke' };
  const tierRates = { foundation: '$35–55', signature: '$55–85', bespoke: '$85–150+' };

  function openQuoteModal() {
    const modal = document.getElementById('quote-modal');
    if (!modal) return;

    const estimate = calculateEstimate();
    const client = document.getElementById('client-name')?.value || 'Client';
    const location = document.getElementById('project-location')?.value || '';
    const finishType = document.getElementById('finish-type')?.value || 'Venetian Plaster';

    // Populate quote data
    const el = (id) => document.getElementById(id);

    // Date & Quote Number
    const now = new Date();
    el('quote-date').textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    el('quote-number').textContent = `Quote #OHP-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${Math.random().toString(36).substr(2,4).toUpperCase()}`;

    // Client info
    el('quote-client').textContent = client;
    el('quote-location').textContent = location || 'Location TBD';
    el('quote-finish').textContent = finishType;
    el('quote-tier').textContent = `${tierNames[state.tier] || 'Signature'} Tier`;

    // Rooms
    const roomsContainer = el('quote-rooms');
    roomsContainer.innerHTML = state.rooms.map(room => {
      const area = calculateRoomArea(room);
      const surfaces = [];
      if (room.includeWalls) surfaces.push('Walls');
      if (room.includeCeiling) surfaces.push('Ceiling');
      return `
        <div class="flex justify-between items-center py-2 border-b border-stone/20 last:border-0">
          <div>
            <span class="text-charcoal font-medium">${room.name}</span>
            <span class="text-charcoal/50 text-sm ml-2">${room.length}' × ${room.width}' × ${room.height}'h</span>
            <span class="text-charcoal/40 text-xs ml-2">(${surfaces.join(' + ')})</span>
          </div>
          <span class="text-charcoal">${area.toLocaleString()} sq ft</span>
        </div>
      `;
    }).join('');

    // Total sqft
    el('quote-total-sqft').textContent = estimate.totalSqFt.toLocaleString();

    // Factors
    const factorsContainer = el('quote-factors');
    const factorLabels = {
      substrateCondition: 'Substrate Condition',
      ceilingAccess: 'Ceiling Access',
      finishComplexity: 'Finish Complexity',
      colorCustomization: 'Color Selection'
    };
    const factorSelects = document.querySelectorAll('[data-factor]');
    let factorsHtml = '';
    factorSelects.forEach(select => {
      const key = select.dataset.factor;
      const selectedOption = select.options[select.selectedIndex];
      factorsHtml += `
        <div class="flex justify-between">
          <span class="text-charcoal/60">${factorLabels[key] || key}</span>
          <span class="text-charcoal">${selectedOption?.textContent || 'Standard'}</span>
        </div>
      `;
    });
    if (state.rushTimeline) {
      factorsHtml += `
        <div class="flex justify-between">
          <span class="text-charcoal/60">Timeline</span>
          <span class="text-bronze font-medium">Rush (+10-20%)</span>
        </div>
      `;
    }
    factorsContainer.innerHTML = factorsHtml;

    // Estimate
    el('quote-low').textContent = estimate.lowEstimate.toLocaleString();
    el('quote-high').textContent = estimate.highEstimate.toLocaleString();
    el('quote-rate').textContent = `${tierRates[state.tier] || '$55–85'} /sq ft`;

    // Show modal
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeQuoteModal() {
    const modal = document.getElementById('quote-modal');
    if (modal) {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }
  }

  function downloadQuotePDF() {
    const element = document.getElementById('quote-document');
    const client = document.getElementById('quote-client')?.textContent || 'Client';
    const date = new Date().toISOString().split('T')[0];

    const opt = {
      margin: 0,
      filename: `OldHeadPlaster_Quote_${client.replace(/\s+/g, '_')}_${date}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    // Show loading state
    const btn = document.getElementById('quote-download-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating...';
    btn.disabled = true;

    html2pdf().set(opt).from(element).save().then(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    });
  }

  function emailQuote() {
    const client = document.getElementById('quote-client')?.textContent || 'Client';
    const estimate = calculateEstimate();
    const finishType = document.getElementById('quote-finish')?.textContent || '';

    const subject = encodeURIComponent(`Old Head Plaster - Project Estimate for ${client}`);
    const body = encodeURIComponent(`Dear ${client},

Thank you for your interest in Old Head Plaster. Please find below a summary of your project estimate.

PROJECT DETAILS
---------------
Finish Type: ${finishType}
Total Area: ${estimate.totalSqFt.toLocaleString()} sq ft
Estimate Range: $${estimate.lowEstimate.toLocaleString()} – $${estimate.highEstimate.toLocaleString()}

This estimate includes:
• On-site consultation & measurements
• Custom sample creation (up to 3)
• All materials & specialized tools
• Surface preparation & priming
• Multi-coat plaster application
• Protective sealer application
• Final walkthrough & care guide

NEXT STEPS
----------
1. Schedule a consultation to review your space
2. We'll create custom samples for your approval
3. Once approved, we'll schedule your project

Please reply to this email or call (203) 555-0147 to schedule your consultation.

Best regards,
Daragh
Old Head Plaster
oldheadplaster.com`);

    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  }

  function smsQuote() {
    const client = document.getElementById('quote-client')?.textContent || '';
    const estimate = calculateEstimate();

    const message = encodeURIComponent(`Hi${client ? ' ' + client : ''}! Here's your Old Head Plaster estimate: ${estimate.totalSqFt.toLocaleString()} sq ft, $${estimate.lowEstimate.toLocaleString()}–$${estimate.highEstimate.toLocaleString()}. Ready to schedule a consultation? Reply or call (203) 555-0147. - Daragh`);

    window.location.href = `sms:?body=${message}`;
  }

  function initQuoteModal() {
    document.getElementById('close-quote-modal')?.addEventListener('click', closeQuoteModal);
    document.getElementById('quote-download-btn')?.addEventListener('click', downloadQuotePDF);
    document.getElementById('quote-email-btn')?.addEventListener('click', emailQuote);
    document.getElementById('quote-sms-btn')?.addEventListener('click', smsQuote);
    document.getElementById('quote-contract-btn')?.addEventListener('click', openContractModal);

    // Contract modal
    document.getElementById('close-contract-modal')?.addEventListener('click', closeContractModal);
    document.getElementById('contract-download-btn')?.addEventListener('click', downloadContractPDF);
    document.getElementById('contract-send-btn')?.addEventListener('click', sendContract);

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeContractModal();
        closeQuoteModal();
      }
    });
  }

  // ===== CONTRACT MODAL =====

  // Calculate 3 business days from a date (CT law: Saturday counts as business day)
  function addBusinessDays(date, days) {
    const result = new Date(date);
    let added = 0;
    while (added < days) {
      result.setDate(result.getDate() + 1);
      // Sunday = 0, skip only Sundays (Saturday = 6 counts as business day in CT)
      if (result.getDay() !== 0) {
        added++;
      }
    }
    return result;
  }

  function openContractModal() {
    const modal = document.getElementById('contract-modal');
    if (!modal) return;

    const estimate = calculateEstimate();
    const client = document.getElementById('quote-client')?.textContent || 'Client';
    const location = document.getElementById('quote-location')?.textContent || '';
    const finishType = document.getElementById('quote-finish')?.textContent || 'Venetian Plaster';

    const el = (id) => document.getElementById(id);
    const now = new Date();

    // Contract number & dates
    el('contract-number').textContent = `Contract #OHP-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${Math.random().toString(36).substr(2,4).toUpperCase()}`;
    el('contract-date-inline').textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    el('contract-date-contractor').textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

    // CT Required: Calculate 3-day cancellation deadline
    const cancelDeadline = addBusinessDays(now, 3);
    el('contract-cancel-deadline')?.textContent && (el('contract-cancel-deadline').textContent =
      cancelDeadline.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + ' at midnight'
    );

    // Set date input defaults
    const formatDate = (d) => d.toISOString().split('T')[0];
    const signDateEl = el('contract-sign-date');
    if (signDateEl) signDateEl.value = formatDate(now);

    // Estimate start date: 2 weeks from now
    const startDate = new Date(now);
    startDate.setDate(startDate.getDate() + 14);
    const startDateEl = el('contract-start-date');
    if (startDateEl) startDateEl.value = formatDate(startDate);

    // Estimate end date: start + 1 week (adjust based on project size)
    const endDate = new Date(startDate);
    endDate.setDate(endDate.getDate() + 7);
    const endDateEl = el('contract-end-date');
    if (endDateEl) endDateEl.value = formatDate(endDate);

    // Client info
    el('contract-client').textContent = client;
    el('contract-location').textContent = location;
    el('contract-client-sig').textContent = client;

    // Scope
    el('contract-sqft').textContent = `${estimate.totalSqFt.toLocaleString()} sq ft`;
    el('contract-finish').textContent = finishType;
    el('contract-tier').textContent = tierNames[state.tier] || 'Signature';

    // Rooms
    const roomsContainer = el('contract-rooms');
    roomsContainer.innerHTML = state.rooms.map(room => {
      const area = calculateRoomArea(room);
      const surfaces = [];
      if (room.includeWalls) surfaces.push('Walls');
      if (room.includeCeiling) surfaces.push('Ceiling');
      return `
        <div class="flex justify-between text-sm py-1">
          <span class="text-charcoal">${room.name} <span class="text-charcoal/50">(${surfaces.join(', ')})</span></span>
          <span class="text-charcoal">${area.toLocaleString()} sq ft</span>
        </div>
      `;
    }).join('');

    // Pricing
    el('contract-low').textContent = estimate.lowEstimate.toLocaleString();
    el('contract-high').textContent = estimate.highEstimate.toLocaleString();

    // Calculate payment amounts based on midpoint (CT law: max 1/3 deposit)
    const midEstimate = Math.round((estimate.lowEstimate + estimate.highEstimate) / 2);
    const deposit = Math.round(midEstimate * 0.33);
    const progress = Math.round(midEstimate * 0.33);
    const final = midEstimate - deposit - progress;

    el('contract-deposit-amt')?.textContent && (el('contract-deposit-amt').textContent = `$${deposit.toLocaleString()}`);
    el('contract-progress-amt')?.textContent && (el('contract-progress-amt').textContent = `$${progress.toLocaleString()}`);
    el('contract-final-amt')?.textContent && (el('contract-final-amt').textContent = `$${final.toLocaleString()}`);

    modal.classList.remove('hidden');
  }

  function closeContractModal() {
    const modal = document.getElementById('contract-modal');
    if (modal) modal.classList.add('hidden');
  }

  function downloadContractPDF() {
    const element = document.getElementById('contract-document');
    const client = document.getElementById('contract-client')?.textContent || 'Client';
    const date = new Date().toISOString().split('T')[0];

    const opt = {
      margin: 0,
      filename: `OldHeadPlaster_Contract_${client.replace(/\s+/g, '_')}_${date}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    const btn = document.getElementById('contract-download-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
    btn.disabled = true;

    html2pdf().set(opt).from(element).save().then(() => {
      btn.innerHTML = originalText;
      btn.disabled = false;
    });
  }

  function sendContract() {
    const clientEmail = document.getElementById('contract-client-email')?.value;
    const client = document.getElementById('contract-client')?.textContent || 'Client';
    const estimate = calculateEstimate();

    if (!clientEmail) {
      alert('Please enter the client\'s email address.');
      document.getElementById('contract-client-email')?.focus();
      return;
    }

    const subject = encodeURIComponent(`Old Head Plaster - Service Agreement for ${client}`);
    const body = encodeURIComponent(`Dear ${client},

Please find attached the Service Agreement for your decorative plaster project.

PROJECT SUMMARY
---------------
Total Area: ${estimate.totalSqFt.toLocaleString()} sq ft
Estimate Range: $${estimate.lowEstimate.toLocaleString()} – $${estimate.highEstimate.toLocaleString()}

NEXT STEPS
----------
1. Review the attached Service Agreement
2. Sign and return the agreement
3. Submit 50% deposit to secure your spot

Please let me know if you have any questions.

Best regards,
Daragh McLoughlin
Old Head Plaster
(203) 555-0147
oldheadplaster.com`);

    window.location.href = `mailto:${clientEmail}?subject=${subject}&body=${body}`;
  }

  // ===== PROJECTS TAB =====
  function renderProjects() {
    const container = document.getElementById('projects-list');
    if (!container) return;

    container.innerHTML = state.projects.map(project => `
      <div class="p-4 hover:bg-stone/20 transition-colors flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-2 h-2 rounded-full ${project.status === 'active' ? 'bg-green-500' : project.status === 'pending' ? 'bg-bronze' : 'bg-charcoal/30'}"></div>
          <div>
            <p class="text-charcoal font-medium">${project.name}</p>
            <p class="text-charcoal/50 text-sm">${project.client} · ${project.finish}</p>
          </div>
        </div>
        <div class="flex items-center gap-8">
          <div class="text-right">
            <p class="text-charcoal">${project.sqft.toLocaleString()} sf</p>
            <p class="text-bronze font-medium">$${project.value.toLocaleString()}</p>
          </div>
          <span class="text-xs uppercase tracking-wide px-2 py-1 rounded ${
            project.status === 'active' ? 'bg-green-100 text-green-700' :
            project.status === 'pending' ? 'bg-bronze/20 text-bronze' : 'bg-stone text-charcoal/50'
          }">${project.status}</span>
        </div>
      </div>
    `).join('');
  }

  // ===== URL PARAMS FOR SCANNER =====
  function parseURLParams() {
    const params = new URLSearchParams(window.location.search);

    const tier = params.get('tier');
    if (tier && ['foundation', 'signature', 'bespoke'].includes(tier)) {
      state.tier = tier;
      const tierInput = document.querySelector(`input[name="tier"][value="${tier}"]`);
      if (tierInput) {
        tierInput.checked = true;
        state.tierMin = parseInt(tierInput.dataset.min);
        state.tierMax = parseInt(tierInput.dataset.max);
      }
    }

    const roomsData = params.get('rooms');
    if (roomsData) {
      try {
        const decoded = atob(roomsData);
        const rooms = JSON.parse(decoded);
        if (Array.isArray(rooms) && rooms.length > 0) {
          state.rooms = rooms.map((r, i) => ({
            id: crypto.randomUUID(),
            name: r.name || `Room ${i + 1}`,
            length: parseFloat(r.length) || 12,
            width: parseFloat(r.width) || 10,
            height: parseFloat(r.height) || 9,
            includeWalls: r.walls === '1' || r.walls === true,
            includeCeiling: r.ceiling === '1' || r.ceiling === true
          }));
          const banner = document.getElementById('app-data-banner');
          if (banner) banner.classList.remove('hidden');
        }
      } catch (e) {
        console.error('Failed to parse room data:', e);
      }
    }
  }

  // ===== IMAGE MANAGER =====
  const imagePages = {
    homepage: [
      { id: 'hero-texture', name: 'Hero Background', desc: 'Main hero section background texture' },
      { id: 'carousel-1', name: 'Carousel 1', desc: 'First image in scrolling carousel' },
      { id: 'carousel-2', name: 'Carousel 2', desc: 'Second image in scrolling carousel' },
      { id: 'carousel-3', name: 'Carousel 3', desc: 'Third image in scrolling carousel' },
      { id: 'carousel-4', name: 'Carousel 4', desc: 'Fourth image in scrolling carousel' },
      { id: 'featured-1', name: 'Featured Work 1', desc: 'First featured project image' },
      { id: 'featured-2', name: 'Featured Work 2', desc: 'Second featured project image' },
      { id: 'featured-3', name: 'Featured Work 3', desc: 'Third featured project image' },
      { id: 'featured-4', name: 'Featured Work 4', desc: 'Fourth featured project image' }
    ],
    preparation: [
      { id: 'prep-hero', name: 'Hero Image', desc: 'Main hero section image' },
      { id: 'substrate-1', name: 'Substrate Before', desc: 'Substrate condition before prep' },
      { id: 'substrate-2', name: 'Substrate After', desc: 'Substrate condition after prep' },
      { id: 'process-1', name: 'Process Step 1', desc: 'First preparation step' },
      { id: 'process-2', name: 'Process Step 2', desc: 'Second preparation step' },
      { id: 'process-3', name: 'Process Step 3', desc: 'Third preparation step' }
    ],
    finishes: [
      { id: 'finish-venetian', name: 'Venetian Plaster', desc: 'Venetian plaster sample' },
      { id: 'finish-limewash', name: 'Lime Wash', desc: 'Lime wash sample' },
      { id: 'finish-tadelakt', name: 'Tadelakt', desc: 'Tadelakt sample' },
      { id: 'finish-microcement', name: 'Microcement', desc: 'Microcement sample' },
      { id: 'finish-marmorino', name: 'Marmorino', desc: 'Marmorino sample' },
      { id: 'finish-metallic', name: 'Metallic', desc: 'Metallic finish sample' }
    ],
    work: [
      { id: 'portfolio-1', name: 'Project 1', desc: 'Portfolio project image' },
      { id: 'portfolio-2', name: 'Project 2', desc: 'Portfolio project image' },
      { id: 'portfolio-3', name: 'Project 3', desc: 'Portfolio project image' },
      { id: 'portfolio-4', name: 'Project 4', desc: 'Portfolio project image' },
      { id: 'portfolio-5', name: 'Project 5', desc: 'Portfolio project image' },
      { id: 'portfolio-6', name: 'Project 6', desc: 'Portfolio project image' }
    ],
    showroom: [
      { id: 'showroom-hero', name: 'Hero Image', desc: 'Material library hero' },
      { id: 'showroom-interior', name: 'Interior Shot', desc: 'Inside the material library' },
      { id: 'showroom-samples', name: 'Sample Display', desc: 'Sample boards on display' },
      { id: 'showroom-detail', name: 'Detail Shot', desc: 'Close-up of materials' }
    ],
    about: [
      { id: 'daragh-portrait', name: 'Daragh Portrait', desc: 'Main portrait photo' },
      { id: 'daragh-working', name: 'Working Shot', desc: 'Daragh at work' },
      { id: 'team-shot', name: 'Team Photo', desc: 'Team working together' }
    ],
    professionals: [
      { id: 'pro-hero', name: 'Hero Image', desc: 'Professional page hero' },
      { id: 'pro-architect', name: 'Architect Work', desc: 'Architect collaboration example' },
      { id: 'pro-designer', name: 'Designer Work', desc: 'Designer collaboration example' }
    ],
    contact: [
      { id: 'contact-map', name: 'Map Image', desc: 'Location map or area photo' },
      { id: 'contact-showroom', name: 'Showroom Exterior', desc: 'Outside the showroom' }
    ],
    care: [
      { id: 'care-cleaning', name: 'Cleaning Demo', desc: 'Cleaning demonstration' },
      { id: 'care-maintenance', name: 'Maintenance', desc: 'Maintenance example' }
    ]
  };

  let imageState = JSON.parse(localStorage.getItem('ohp-image-mapping') || '{}');
  let currentImagePage = 'homepage';
  let currentSlot = null;

  function saveImageState() {
    localStorage.setItem('ohp-image-mapping', JSON.stringify(imageState));
  }

  function renderImageSlots() {
    const container = document.getElementById('image-slots-container');
    if (!container) return;

    const slots = imagePages[currentImagePage] || [];
    const assigned = Object.keys(imageState[currentImagePage] || {}).length;

    // Update progress
    const progressText = document.getElementById('img-progress-text');
    const progressBar = document.getElementById('img-progress-bar');
    if (progressText) progressText.textContent = `${assigned} / ${slots.length} images`;
    if (progressBar) progressBar.style.width = `${slots.length ? (assigned / slots.length * 100) : 0}%`;

    container.innerHTML = `
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        ${slots.map(slot => {
          const imgPath = imageState[currentImagePage]?.[slot.id];
          return `
            <div class="group relative">
              <div class="aspect-[4/3] bg-stone/50 border-2 border-dashed border-charcoal/20 flex items-center justify-center overflow-hidden cursor-pointer hover:border-bronze transition-colors img-slot" data-slot="${slot.id}" data-name="${slot.name}" data-desc="${slot.desc}">
                ${imgPath ? `
                  <img src="/images/${imgPath}" alt="${slot.name}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<span class=\\'text-red-500 text-xs\\'>Image not found</span>'" />
                  <button class="absolute top-2 right-2 w-6 h-6 bg-charcoal/80 text-cream rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center remove-img" data-slot="${slot.id}">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                  </button>
                ` : `
                  <div class="text-center p-4">
                    <svg class="w-8 h-8 text-charcoal/30 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span class="text-charcoal/50 text-xs">Click to add</span>
                  </div>
                `}
              </div>
              <p class="text-charcoal text-sm font-medium mt-2">${slot.name}</p>
              <p class="text-charcoal/50 text-xs">${slot.desc}</p>
              ${imgPath ? `<p class="text-bronze text-xs truncate mt-1" title="${imgPath}">${imgPath}</p>` : ''}
            </div>
          `;
        }).join('')}
      </div>
    `;

    // Click to open modal
    container.querySelectorAll('.img-slot').forEach(slot => {
      slot.addEventListener('click', (e) => {
        if (e.target.closest('.remove-img')) return;
        currentSlot = {
          id: slot.dataset.slot,
          name: slot.dataset.name,
          desc: slot.dataset.desc
        };
        openImageModal();
      });
    });

    // Remove buttons
    container.querySelectorAll('.remove-img').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const slotId = btn.dataset.slot;
        if (imageState[currentImagePage]) {
          delete imageState[currentImagePage][slotId];
          saveImageState();
          renderImageSlots();
        }
      });
    });
  }

  function openImageModal() {
    const modal = document.getElementById('img-modal');
    const title = document.getElementById('img-modal-title');
    const desc = document.getElementById('img-modal-desc');
    const pathInput = document.getElementById('img-path-input');

    if (modal && currentSlot) {
      title.textContent = currentSlot.name;
      desc.textContent = currentSlot.desc;
      pathInput.value = imageState[currentImagePage]?.[currentSlot.id] || '';
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
  }

  function closeImageModal() {
    const modal = document.getElementById('img-modal');
    if (modal) {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    currentSlot = null;
  }

  function assignImage(path) {
    if (!currentSlot || !path) return;
    if (!imageState[currentImagePage]) imageState[currentImagePage] = {};
    imageState[currentImagePage][currentSlot.id] = path;
    saveImageState();
    closeImageModal();
    renderImageSlots();
  }

  function initImageManager() {
    // Page tabs
    document.querySelectorAll('.img-page-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.img-page-tab').forEach(t => {
          t.classList.remove('active', 'bg-bronze', 'text-charcoal');
          t.classList.add('bg-stone', 'text-charcoal/70');
        });
        tab.classList.add('active', 'bg-bronze', 'text-charcoal');
        tab.classList.remove('bg-stone', 'text-charcoal/70');
        currentImagePage = tab.dataset.imgpage;
        renderImageSlots();
      });
    });

    // Modal close
    document.getElementById('close-img-modal')?.addEventListener('click', closeImageModal);
    document.getElementById('img-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'img-modal') closeImageModal();
    });

    // Path submit
    document.getElementById('img-path-submit')?.addEventListener('click', () => {
      const path = document.getElementById('img-path-input')?.value.trim();
      if (path) assignImage(path);
    });

    document.getElementById('img-path-input')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const path = e.target.value.trim();
        if (path) assignImage(path);
      }
    });

    // Drop zone
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('img-file-input');

    if (dropZone && fileInput) {
      dropZone.addEventListener('click', () => fileInput.click());

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-bronze', 'bg-bronze/10');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-bronze', 'bg-bronze/10');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-bronze', 'bg-bronze/10');
        const file = e.dataTransfer?.files[0];
        if (file && file.type.startsWith('image/')) {
          // For now, prompt for path since we can't upload
          const suggestedName = file.name;
          const path = prompt(`Enter the path where you'll save this image:\n\nSuggested: Website/${suggestedName}`, `Website/${suggestedName}`);
          if (path) assignImage(path);
        }
      });

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (file) {
          const suggestedName = file.name;
          const path = prompt(`Enter the path where you'll save this image:\n\nSuggested: Website/${suggestedName}`, `Website/${suggestedName}`);
          if (path) assignImage(path);
        }
        fileInput.value = '';
      });
    }

    // Export
    document.getElementById('export-images-btn')?.addEventListener('click', () => {
      const json = JSON.stringify(imageState, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ohp-image-mapping.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Clear all
    document.getElementById('clear-images-btn')?.addEventListener('click', () => {
      if (confirm('Clear all image assignments? This cannot be undone.')) {
        imageState = {};
        saveImageState();
        renderImageSlots();
      }
    });

    // Initial render
    renderImageSlots();
  }

  // ===== ACCOUNTING =====
  const acctState = {
    income: [],
    grossRevenue: 0
  };

  // 2024/2025 Tax Brackets (Single/Self-Employed)
  const taxBrackets = [
    { min: 0, max: 11600, rate: 0.10 },
    { min: 11600, max: 47150, rate: 0.12 },
    { min: 47150, max: 100525, rate: 0.22 },
    { min: 100525, max: 191950, rate: 0.24 },
    { min: 191950, max: 243725, rate: 0.32 },
    { min: 243725, max: 609350, rate: 0.35 },
    { min: 609350, max: Infinity, rate: 0.37 }
  ];

  const IRS_MILEAGE_RATE = 0.67; // 2024 rate
  const SE_TAX_RATE = 0.153; // 15.3% (12.4% SS + 2.9% Medicare)
  const SS_WAGE_BASE = 168600; // 2024 Social Security wage base

  function calculateIncomeTax(taxableIncome) {
    let tax = 0;
    let remaining = taxableIncome;

    for (const bracket of taxBrackets) {
      if (remaining <= 0) break;
      const taxableInBracket = Math.min(remaining, bracket.max - bracket.min);
      tax += taxableInBracket * bracket.rate;
      remaining -= taxableInBracket;
    }

    return Math.round(tax);
  }

  function updateAccounting() {
    const el = (id) => document.getElementById(id);
    const val = (id) => parseFloat(document.getElementById(id)?.value) || 0;
    const set = (id, value) => {
      const elem = document.getElementById(id);
      if (elem) elem.textContent = typeof value === 'number' ? value.toLocaleString() : value;
    };

    // Income - for now use a simple total input (can expand to line items later)
    const grossRevenue = acctState.grossRevenue || 0;
    set('acct-gross-revenue', grossRevenue);
    set('acct-income-total', grossRevenue);

    // Expenses (100% deductible)
    const materials = val('acct-exp-materials');
    const tools = val('acct-exp-tools');
    const vehicle = val('acct-exp-vehicle');
    const insurance = val('acct-exp-insurance');
    const professional = val('acct-exp-professional');
    const marketing = val('acct-exp-marketing');
    const travel = val('acct-exp-travel');
    const phone = val('acct-exp-phone');
    const other = val('acct-exp-other');

    // Meals only 50% deductible
    const meals = val('acct-exp-meals');
    const mealsDeductible = meals * 0.5;

    // Mileage deduction
    const mileageTotal = val('acct-mileage-total');
    const mileageDeduction = Math.round(mileageTotal * IRS_MILEAGE_RATE);
    set('acct-mileage-deduction', mileageDeduction);

    // Home office deduction
    const officeSqft = val('acct-office-sqft');
    const homeSqft = val('acct-home-sqft');
    const homeCosts = val('acct-home-costs');

    let homeOfficeDeduction = 0;
    if (homeSqft > 0 && officeSqft > 0) {
      const percentage = officeSqft / homeSqft;
      homeOfficeDeduction = Math.round(homeCosts * percentage);
    }
    set('acct-home-office-deduction', homeOfficeDeduction);

    // Simplified home office (max 300 sq ft @ $5/sqft)
    const simplifiedHome = Math.min(officeSqft, 300) * 5;
    set('acct-simplified-home', simplifiedHome);

    // Studio Overhead (monthly amounts * 12 for annual)
    const studioRent = val('acct-studio-rent') * 12;
    const studioElectric = val('acct-studio-electric') * 12;
    const studioGas = val('acct-studio-gas') * 12;
    const studioWater = val('acct-studio-water') * 12;
    const studioMaintenance = val('acct-studio-maintenance') * 12;
    const studioPropIns = val('acct-studio-propins') * 12;
    const studioSecurity = val('acct-studio-security') * 12;
    const studioImprovements = val('acct-studio-improvements'); // Not multiplied - entered as annual
    const studioCleaning = val('acct-studio-cleaning') * 12;
    const studioOther = val('acct-studio-other') * 12;

    const studioTotal = studioRent + studioElectric + studioGas + studioWater +
      studioMaintenance + studioPropIns + studioSecurity + studioImprovements +
      studioCleaning + studioOther;

    set('acct-studio-total', Math.round(studioTotal));

    // Total deductions (including studio overhead)
    const totalExpenses = materials + tools + vehicle + insurance + professional +
      marketing + travel + mealsDeductible + phone + other + mileageDeduction +
      Math.max(homeOfficeDeduction, simplifiedHome) + studioTotal;

    set('acct-total-expenses', Math.round(totalExpenses));
    set('acct-deductions-total', Math.round(totalExpenses));

    // Net profit (before SE tax deduction)
    const netProfit = grossRevenue - totalExpenses;
    set('acct-net-profit', Math.round(netProfit));

    // Self-Employment Tax Calculation
    const seEarnings = Math.max(0, netProfit);
    set('acct-se-earnings', Math.round(seEarnings));

    const seBase = Math.round(seEarnings * 0.9235); // 92.35% of net earnings
    set('acct-se-base', seBase);

    // Social Security portion (12.4% up to wage base)
    const ssSocialSecurity = Math.round(Math.min(seBase, SS_WAGE_BASE) * 0.124);
    set('acct-se-ss', ssSocialSecurity);

    // Medicare (2.9% on all earnings)
    const seMedicare = Math.round(seBase * 0.029);
    set('acct-se-medicare', seMedicare);

    const seTaxTotal = ssSocialSecurity + seMedicare;
    set('acct-se-total', seTaxTotal);

    // Deductible portion of SE tax (50%)
    const seDeduction = Math.round(seTaxTotal / 2);
    set('acct-se-deduction', seDeduction);

    // Taxable income for income tax (after SE deduction)
    const taxableIncome = Math.max(0, netProfit - seDeduction);

    // Federal Income Tax
    const incomeTax = calculateIncomeTax(taxableIncome);

    // Total tax liability
    const totalTaxLiability = seTaxTotal + incomeTax;
    set('acct-tax-liability', totalTaxLiability);

    // Effective tax rate
    const effectiveRate = grossRevenue > 0 ? Math.round((totalTaxLiability / grossRevenue) * 100) : 0;
    set('acct-effective-rate', effectiveRate);

    // Quarterly estimates (divide annual by 4)
    const quarterlyTax = Math.round(totalTaxLiability / 4);
    set('acct-q1-tax', quarterlyTax);
    set('acct-q2-tax', quarterlyTax);
    set('acct-q3-tax', quarterlyTax);
    set('acct-q4-tax', quarterlyTax);

    // Monthly set-aside
    const monthlySetaside = Math.round(totalTaxLiability / 12);
    set('acct-monthly-setaside', monthlySetaside);

    // Retirement calculations
    // SEP-IRA: 25% of net SE income (after SE deduction)
    const sepMax = Math.min(Math.round((netProfit - seDeduction) * 0.25), 69000);
    set('acct-sep-max', Math.max(0, sepMax));

    // Solo 401(k): $23,000 employee + 25% employer (max $69,000 total)
    const solo401kEmployer = Math.round((netProfit - seDeduction) * 0.25);
    const solo401kMax = Math.min(23000 + solo401kEmployer, 69000);
    set('acct-solo401k-max', Math.max(0, solo401kMax));

    // Tax savings from max retirement contribution
    const maxRetirement = Math.max(sepMax, solo401kMax);
    set('acct-retirement-contrib', Math.max(0, maxRetirement));

    // Estimate tax savings (use marginal rate ~24% for mid-income)
    const estimatedMarginalRate = taxableIncome > 100525 ? 0.24 : (taxableIncome > 47150 ? 0.22 : 0.12);
    const retirementSavings = Math.round(maxRetirement * estimatedMarginalRate);
    set('acct-retirement-savings', retirementSavings);
  }

  function addIncome(amount, description = '') {
    acctState.income.push({ amount, description, date: new Date().toISOString() });
    acctState.grossRevenue = acctState.income.reduce((sum, i) => sum + i.amount, 0);
    renderIncomeList();
    updateAccounting();
    saveAcctState();
  }

  function renderIncomeList() {
    const container = document.getElementById('income-list');
    if (!container) return;

    if (acctState.income.length === 0) {
      container.innerHTML = `
        <div class="text-center py-4 text-charcoal/40 text-sm">
          No income recorded yet. Click "+ Add Income" to start tracking.
        </div>
      `;
      return;
    }

    container.innerHTML = acctState.income.map((item, index) => `
      <div class="flex items-center justify-between py-2 border-b border-stone/20">
        <div>
          <span class="text-charcoal font-medium">$${item.amount.toLocaleString()}</span>
          <span class="text-charcoal/50 text-sm ml-2">${item.description || 'Project income'}</span>
        </div>
        <button onclick="removeIncome(${index})" class="text-charcoal/30 hover:text-red-500 text-sm">×</button>
      </div>
    `).join('');
  }

  function removeIncome(index) {
    acctState.income.splice(index, 1);
    acctState.grossRevenue = acctState.income.reduce((sum, i) => sum + i.amount, 0);
    renderIncomeList();
    updateAccounting();
    saveAcctState();
  }

  function saveAcctState() {
    localStorage.setItem('ohp-accounting', JSON.stringify(acctState));
  }

  function loadAcctState() {
    const saved = localStorage.getItem('ohp-accounting');
    if (saved) {
      const parsed = JSON.parse(saved);
      acctState.income = parsed.income || [];
      acctState.grossRevenue = parsed.grossRevenue || 0;
    }

    // Also load expense values
    const expenses = localStorage.getItem('ohp-accounting-expenses');
    if (expenses) {
      const exp = JSON.parse(expenses);
      Object.entries(exp).forEach(([id, value]) => {
        const input = document.getElementById(id);
        if (input) input.value = value;
      });
    }
  }

  function saveExpenses() {
    const expenseInputs = document.querySelectorAll('.acct-input');
    const expenses = {};
    expenseInputs.forEach(input => {
      if (input.id) expenses[input.id] = input.value;
    });
    localStorage.setItem('ohp-accounting-expenses', JSON.stringify(expenses));
  }

  function initAccounting() {
    // Load saved state
    loadAcctState();

    // Add income button
    document.getElementById('add-income-btn')?.addEventListener('click', () => {
      const amount = prompt('Enter income amount:');
      if (amount && !isNaN(parseFloat(amount))) {
        const desc = prompt('Description (e.g., "Smith Kitchen Project"):') || '';
        addIncome(parseFloat(amount), desc);
      }
    });

    // Add event listeners to all accounting inputs
    document.querySelectorAll('.acct-input').forEach(input => {
      input.addEventListener('input', () => {
        updateAccounting();
        saveExpenses();
      });
    });

    // Initial render
    renderIncomeList();
    updateAccounting();
  }

  // Make removeIncome available globally
  window.removeIncome = removeIncome;

  // ===== VIRTUAL ACCOUNTANT =====
  const accountantMessages = [];

  // Gather all financial data from accounting tab for context
  function gatherFinancialData() {
    const getValue = (id) => {
      const el = document.getElementById(id);
      if (!el) return 0;
      return parseFloat(el.value || el.textContent) || 0;
    };

    const getText = (id) => {
      const el = document.getElementById(id);
      return el ? (el.textContent || el.value || '0') : '0';
    };

    // Get completed projects from localStorage for income detail
    const projects = JSON.parse(localStorage.getItem('ohp-projects') || '[]');
    const completedProjects = projects.filter(p => p.status === 'completed');
    const activeProjects = projects.filter(p => p.status === 'active');
    const pendingProjects = projects.filter(p => p.status === 'pending');

    // Calculate income from completed projects
    const grossIncome = completedProjects.reduce((sum, p) => sum + (p.value || 0), 0);
    const pipelineValue = [...activeProjects, ...pendingProjects].reduce((sum, p) => sum + (p.value || 0), 0);

    return {
      taxYear: document.getElementById('acct-tax-year')?.value || '2024',

      // Income Summary
      income: {
        grossRevenue: getText('acct-gross-revenue'),
        completedJobs: completedProjects.length,
        activeJobs: activeProjects.length,
        pendingJobs: pendingProjects.length,
        pipelineValue: pipelineValue.toLocaleString(),
        // Detail recent completed projects
        recentCompletedProjects: completedProjects.slice(-5).map(p => ({
          name: p.name,
          client: p.client,
          value: p.value,
          sqft: p.sqft,
          finish: p.finish
        }))
      },

      // Deductible Expenses
      expenses: {
        materials: getValue('acct-exp-materials'),
        toolsEquipment: getValue('acct-exp-tools'),
        vehicleExpenses: getValue('acct-exp-vehicle'),
        insurance: getValue('acct-exp-insurance'),
        professionalServices: getValue('acct-exp-professional'),
        marketing: getValue('acct-exp-marketing'),
        travel: getValue('acct-exp-travel'),
        mealsBusiness: getValue('acct-exp-meals'),
        phoneInternet: getValue('acct-exp-phone'),
        otherExpenses: getValue('acct-exp-other'),
        totalExpenses: getText('acct-deductions-total')
      },

      // Mileage
      mileage: {
        totalMiles: getValue('acct-mileage-total'),
        deductionAmount: getText('acct-mileage-deduction'),
        ratePerMile: 0.67
      },

      // Home Office
      homeOffice: {
        officeSqft: getValue('acct-office-sqft'),
        homeSqft: getValue('acct-home-sqft'),
        homeCosts: getValue('acct-home-costs'),
        regularMethodDeduction: getText('acct-home-office-deduction'),
        simplifiedMethodDeduction: getText('acct-simplified-home')
      },

      // Studio Overhead (Madison, CT location)
      studioOverhead: {
        monthlyRent: getValue('acct-studio-rent'),
        electricity: getValue('acct-studio-electric'),
        gas: getValue('acct-studio-gas'),
        water: getValue('acct-studio-water'),
        maintenance: getValue('acct-studio-maintenance'),
        propertyInsurance: getValue('acct-studio-propins'),
        security: getValue('acct-studio-security'),
        improvements: getValue('acct-studio-improvements'),
        cleaning: getValue('acct-studio-cleaning'),
        other: getValue('acct-studio-other'),
        annualTotal: getText('acct-studio-total'),
        customerVisits: getText('acct-visit-count'),
        consultations: getText('acct-consult-count'),
        conversionRate: getText('acct-conversion-rate')
      },

      // Tax Calculations
      taxSummary: {
        netProfit: getText('acct-net-profit'),
        totalTaxLiability: getText('acct-tax-liability'),
        effectiveRate: getText('acct-effective-rate'),
        quarterlyEstimate: getText('acct-q1-tax'),
        monthlySetAside: getText('acct-monthly-setaside')
      },

      // Self-Employment Tax Breakdown
      selfEmploymentTax: {
        netEarnings: getText('acct-se-earnings'),
        taxableBase: getText('acct-se-base'),
        socialSecurityTax: getText('acct-se-ss'),
        medicareTax: getText('acct-se-medicare'),
        totalSETax: getText('acct-se-total'),
        deductibleHalf: getText('acct-se-deduction')
      },

      // Retirement Opportunities
      retirement: {
        sepIraMax: getText('acct-sep-max'),
        solo401kMax: getText('acct-solo401k-max'),
        potentialTaxSavings: getText('acct-retirement-savings')
      }
    };
  }

  // Build dynamic context string from financial data
  function buildFinancialContext() {
    const data = gatherFinancialData();

    return `

=== CURRENT FINANCIAL DATA (Tax Year ${data.taxYear}) ===

INCOME:
- Gross Revenue YTD: $${data.income.grossRevenue}
- Completed Jobs: ${data.income.completedJobs}
- Active Jobs: ${data.income.activeJobs}
- Pending/Pipeline: ${data.income.pendingJobs} jobs worth $${data.income.pipelineValue}
${data.income.recentCompletedProjects.length > 0 ? `
Recent Completed Projects:
${data.income.recentCompletedProjects.map(p => `  - ${p.name} (${p.client}): $${p.value?.toLocaleString() || 0}, ${p.sqft || 0} sqft, ${p.finish || 'N/A'}`).join('\n')}
` : ''}

DEDUCTIBLE EXPENSES:
- Materials & Supplies: $${data.expenses.materials.toLocaleString()}
- Tools & Equipment: $${data.expenses.toolsEquipment.toLocaleString()}
- Vehicle Expenses: $${data.expenses.vehicleExpenses.toLocaleString()}
- Insurance (Liability/Workers Comp): $${data.expenses.insurance.toLocaleString()}
- Professional Services (CPA, Legal): $${data.expenses.professionalServices.toLocaleString()}
- Marketing & Advertising: $${data.expenses.marketing.toLocaleString()}
- Travel (Non-local): $${data.expenses.travel.toLocaleString()}
- Business Meals (50%): $${data.expenses.mealsBusiness.toLocaleString()}
- Phone & Internet: $${data.expenses.phoneInternet.toLocaleString()}
- Other Expenses: $${data.expenses.otherExpenses.toLocaleString()}
- TOTAL EXPENSES: $${data.expenses.totalExpenses}

MILEAGE LOG:
- Total Business Miles: ${data.mileage.totalMiles.toLocaleString()}
- Mileage Deduction (@ $${data.mileage.ratePerMile}/mi): $${data.mileage.deductionAmount}

HOME OFFICE DEDUCTION:
- Office Space: ${data.homeOffice.officeSqft} sqft of ${data.homeOffice.homeSqft} sqft home
- Annual Home Costs: $${data.homeOffice.homeCosts.toLocaleString()}
- Regular Method Deduction: $${data.homeOffice.regularMethodDeduction}
- Simplified Method Deduction: $${data.homeOffice.simplifiedMethodDeduction}

STUDIO/SHOP OVERHEAD (Madison, CT):
- Monthly Rent/Lease: $${data.studioOverhead.monthlyRent.toLocaleString()}
- Electricity: $${data.studioOverhead.electricity.toLocaleString()}/mo
- Gas: $${data.studioOverhead.gas.toLocaleString()}/mo
- Water: $${data.studioOverhead.water.toLocaleString()}/mo
- Maintenance & Repairs: $${data.studioOverhead.maintenance.toLocaleString()}/mo
- Property Insurance: $${data.studioOverhead.propertyInsurance.toLocaleString()}/mo
- Security: $${data.studioOverhead.security.toLocaleString()}/mo
- Improvements/Build-out: $${data.studioOverhead.improvements.toLocaleString()}/mo
- Cleaning Services: $${data.studioOverhead.cleaning.toLocaleString()}/mo
- Other: $${data.studioOverhead.other.toLocaleString()}/mo
- ANNUAL STUDIO TOTAL: $${data.studioOverhead.annualTotal}
- Customer Visits: ${data.studioOverhead.customerVisits} | Consultations: ${data.studioOverhead.consultations} | Conversion: ${data.studioOverhead.conversionRate}%

TAX SUMMARY:
- Net Profit (Schedule C): $${data.taxSummary.netProfit}
- Estimated Total Tax Liability: $${data.taxSummary.totalTaxLiability}
- Effective Tax Rate: ${data.taxSummary.effectiveRate}%
- Quarterly Estimated Payment: $${data.taxSummary.quarterlyEstimate}
- Monthly Tax Set-Aside: $${data.taxSummary.monthlySetAside}

SELF-EMPLOYMENT TAX:
- Net SE Earnings: $${data.selfEmploymentTax.netEarnings}
- Taxable Base (92.35%): $${data.selfEmploymentTax.taxableBase}
- Social Security Tax (12.4%): $${data.selfEmploymentTax.socialSecurityTax}
- Medicare Tax (2.9%): $${data.selfEmploymentTax.medicareTax}
- Total SE Tax: $${data.selfEmploymentTax.totalSETax}
- Deductible Half of SE Tax: $${data.selfEmploymentTax.deductibleHalf}

RETIREMENT CONTRIBUTION OPPORTUNITIES:
- SEP-IRA Maximum: $${data.retirement.sepIraMax}
- Solo 401(k) Maximum: $${data.retirement.solo401kMax}
- Potential Tax Savings from Max Contribution: $${data.retirement.potentialTaxSavings}

=== END FINANCIAL DATA ===

Use this real-time financial data to provide specific, personalized advice. Reference actual numbers when making recommendations.`;
  }

  const ACCOUNTANT_SYSTEM_PROMPT = `You are a Virtual CPA & Tax Attorney specializing in small business finances for artisan contractors, specifically decorative plaster contractors in Connecticut.

CREDENTIALS:
- Certified Public Accountant (CPA), Connecticut License
- Juris Doctor (J.D.) with focus on Business & Tax Law
- Master of Laws (LL.M.) in Taxation
- 15+ years advising small business owners, contractors, and tradespeople
- Specializations: Business entity structuring, tax planning, contractor compliance, growth strategies

YOUR EXPERTISE SPANS:

TAX PLANNING & COMPLIANCE:
- Self-employment tax optimization and reduction strategies
- Quarterly estimated tax planning and safe harbor calculations
- Federal and Connecticut state tax compliance
- IRS audit defense and representation strategies
- Tax credit identification (R&D, energy efficiency, hiring credits)
- Depreciation strategies (Section 179, bonus depreciation, MACRS)

BUSINESS ENTITY & LEGAL STRUCTURE:
- Business entity selection (Sole Prop vs LLC vs S-Corp vs C-Corp)
- S-Corp election timing and reasonable salary determination
- LLC operating agreements and liability protection
- Multi-member LLC taxation and partnership considerations
- Registered agent and CT Secretary of State compliance
- Contract law fundamentals for independent contractors

GROWTH & WEALTH BUILDING:
- Retirement account optimization (SEP-IRA, Solo 401(k), Defined Benefit Plans)
- Business valuation and exit planning strategies
- Scaling from sole operator to employer (1099 vs W-2 analysis)
- Cash flow management for seasonal/cyclical businesses
- Capital expenditure timing and financing strategies
- Building business credit and financing options

CONTRACTOR-SPECIFIC KNOWLEDGE:
- Deduction strategies (materials, mileage, home office, tools, studio overhead)
- Connecticut Home Improvement Contractor (HIC) compliance
- Worker classification (employee vs subcontractor) and Form 1099 requirements
- Job costing and profitability analysis
- Insurance requirements and deductibility
- Lien law and mechanic's lien rights in Connecticut

Key facts about the client:
- Daragh McLoughlin, owner of Old Head Plaster LLC
- Based in Madison, CT 06443 (New Haven County)
- Decorative plaster artisan contractor (specialty finish work)
- Has a physical studio with overhead costs in Madison
- Serves Connecticut, New York, and tri-state area
- Currently self-employed, files Schedule C
- CT Home Improvement Contractor registration holder

Guidelines:
- Provide specific, actionable advice with concrete numbers and calculations
- Cite relevant IRS publications, tax code sections, and CT statutes when applicable
- Explain the legal and tax "why" behind every recommendation
- Compare options with detailed pros/cons including legal risk assessment
- Flag any areas requiring formal legal counsel or complex tax return preparation
- Be thorough but accessible - explain complex concepts clearly
- Proactively identify opportunities the client may not have considered
- Consider both immediate tax savings AND long-term wealth building

Current tax info (2024/2025):
- Self-employment tax: 15.3% (12.4% Social Security on first $168,600 + 2.9% Medicare on all income)
- Additional Medicare tax: 0.9% on SE income over $200K (single)
- Social Security wage base: $168,600 (2024), $176,100 (2025)
- IRS standard mileage rate: $0.67/mile (2024)
- SEP-IRA max: 25% of net SE income, up to $69,000 (2024), $70,000 (2025)
- Solo 401(k): $23,000 employee + 25% employer contribution, total max $69,000 (2024)
- S-Corp reasonable salary: Generally advisable when net profit exceeds $50-60K consistently
- CT state income tax: 3% to 6.99% (graduated, 7 brackets)
- CT business entity tax: $250 minimum for LLCs
- QBI deduction (199A): 20% of qualified business income, subject to limitations
- Section 179 limit: $1,160,000 (2024)
- Bonus depreciation: 60% (2024), phasing down 20% per year`;

  function addAccountantMessage(role, content) {
    const container = document.getElementById('accountant-chat-messages');
    if (!container) return;

    const isUser = role === 'user';

    const messageHtml = `
      <div class="flex gap-3 ${isUser ? 'flex-row-reverse' : ''}">
        <div class="w-8 h-8 ${isUser ? 'bg-bronze' : 'bg-bronze/20'} rounded-full flex items-center justify-center flex-shrink-0">
          ${isUser ? `
            <svg class="w-4 h-4 text-charcoal" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
          ` : `
            <svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
          `}
        </div>
        <div class="flex-1 ${isUser ? 'text-right' : ''}">
          <p class="${isUser ? 'bg-bronze/20 text-cream inline-block px-3 py-2 rounded-lg' : 'text-cream/90'} text-sm">
            ${content.replace(/\n/g, '<br>')}
          </p>
        </div>
      </div>
    `;

    container.insertAdjacentHTML('beforeend', messageHtml);
    container.scrollTop = container.scrollHeight;
  }

  function showAccountantTyping() {
    const container = document.getElementById('accountant-chat-messages');
    if (!container) return;

    const typingHtml = `
      <div id="accountant-typing" class="flex gap-3">
        <div class="w-8 h-8 bg-bronze/20 rounded-full flex items-center justify-center flex-shrink-0">
          <svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
        </div>
        <div class="flex-1">
          <div class="flex gap-1 py-2">
            <span class="w-2 h-2 bg-bronze/50 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
            <span class="w-2 h-2 bg-bronze/50 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
            <span class="w-2 h-2 bg-bronze/50 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
          </div>
        </div>
      </div>
    `;

    container.insertAdjacentHTML('beforeend', typingHtml);
    container.scrollTop = container.scrollHeight;
  }

  function removeAccountantTyping() {
    document.getElementById('accountant-typing')?.remove();
  }

  async function sendAccountantMessage(userMessage) {
    if (!userMessage.trim()) return;

    // Add user message to UI
    addAccountantMessage('user', userMessage);

    // Add to conversation history
    accountantMessages.push({ role: 'user', content: userMessage });

    // Show typing indicator
    showAccountantTyping();

    // Disable input while processing
    const input = document.getElementById('accountant-chat-input');
    const sendBtn = document.getElementById('accountant-chat-send');
    if (input) input.disabled = true;
    if (sendBtn) sendBtn.disabled = true;

    try {
      // Build full system prompt with real-time financial data
      const fullSystemPrompt = ACCOUNTANT_SYSTEM_PROMPT + buildFinancialContext();

      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: accountantMessages,
          systemPrompt: fullSystemPrompt
        })
      });

      if (!response.ok) throw new Error('API request failed');

      const data = await response.json();
      const assistantMessage = data.message || 'I apologize, I encountered an issue. Please try again.';

      // Add to conversation history
      accountantMessages.push({ role: 'assistant', content: assistantMessage });

      // Remove typing and show response
      removeAccountantTyping();
      addAccountantMessage('assistant', assistantMessage);

    } catch (error) {
      console.error('Accountant chat error:', error);
      removeAccountantTyping();
      addAccountantMessage('assistant', 'I apologize, I\'m having trouble connecting right now. Please check that the API is configured and try again.');
    } finally {
      // Re-enable input
      if (input) {
        input.disabled = false;
        input.value = '';
        input.focus();
      }
      if (sendBtn) sendBtn.disabled = false;
    }
  }

  function initAccountantChat() {
    const input = document.getElementById('accountant-chat-input');
    const sendBtn = document.getElementById('accountant-chat-send');

    // Send on button click
    sendBtn?.addEventListener('click', () => {
      sendAccountantMessage(input?.value || '');
    });

    // Send on Enter key
    input?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendAccountantMessage(input.value);
      }
    });

    // Quick question buttons
    document.querySelectorAll('.accountant-quick-q').forEach(btn => {
      btn.addEventListener('click', () => {
        const question = btn.dataset.q;
        if (question) {
          sendAccountantMessage(question);
        }
      });
    });
  }

  // ===== DASHBOARD =====
  function initDashboard() {
    // Set greeting based on time
    const hour = new Date().getHours();
    const greeting = hour < 12 ? 'morning' : hour < 17 ? 'afternoon' : 'evening';
    const greetingEl = document.getElementById('dash-greeting');
    if (greetingEl) greetingEl.textContent = greeting;

    // Set date
    const dateEl = document.getElementById('dash-date');
    if (dateEl) {
      const today = new Date();
      dateEl.textContent = today.toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
    }

    updateDashboard();
    renderSubcontractors();
    updateCashFlowForecast();
  }

  function updateDashboard() {
    const projects = JSON.parse(localStorage.getItem('ohp-projects') || '[]');
    const leads = JSON.parse(localStorage.getItem('ohp-leads') || '[]');
    const invoices = JSON.parse(localStorage.getItem('ohp-invoices') || '[]');
    const tasks = JSON.parse(localStorage.getItem('ohp-tasks') || '[]');

    // Revenue YTD (from completed projects)
    const completedProjects = projects.filter(p => p.status === 'completed');
    const revenue = completedProjects.reduce((sum, p) => sum + (p.value || 0), 0);
    const revenueEl = document.getElementById('dash-revenue');
    if (revenueEl) revenueEl.textContent = revenue.toLocaleString();

    // Pipeline value (active + pending)
    const pipeline = [...projects.filter(p => p.status === 'active' || p.status === 'pending'),
                       ...leads.filter(l => l.stage !== 'won' && l.stage !== 'lost')];
    const pipelineValue = pipeline.reduce((sum, p) => sum + (p.value || 0), 0);
    const pipelineEl = document.getElementById('dash-pipeline');
    if (pipelineEl) pipelineEl.textContent = pipelineValue.toLocaleString();
    const pipelineCountEl = document.getElementById('dash-pipeline-count');
    if (pipelineCountEl) pipelineCountEl.textContent = pipeline.length;

    // Outstanding invoices
    const unpaidInvoices = invoices.filter(i => i.status !== 'paid');
    const outstanding = unpaidInvoices.reduce((sum, i) => sum + (i.total || 0), 0);
    const outstandingEl = document.getElementById('dash-outstanding');
    if (outstandingEl) outstandingEl.textContent = outstanding.toLocaleString();

    // Overdue count
    const today = new Date().toISOString().split('T')[0];
    const overdue = unpaidInvoices.filter(i => i.dueDate < today);
    const overdueCountEl = document.getElementById('dash-overdue-count');
    if (overdueCountEl) overdueCountEl.textContent = overdue.length;

    // Active jobs
    const activeJobs = projects.filter(p => p.status === 'active');
    const activeJobsEl = document.getElementById('dash-active-jobs');
    if (activeJobsEl) activeJobsEl.textContent = activeJobs.length;

    // Close rate (won / (won + lost) from leads in last 90 days)
    const ninetyDaysAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString();
    const recentLeads = leads.filter(l => (l.createdAt || '') >= ninetyDaysAgo);
    const won = recentLeads.filter(l => l.stage === 'won').length;
    const lost = recentLeads.filter(l => l.stage === 'lost').length;
    const closeRate = (won + lost) > 0 ? Math.round((won / (won + lost)) * 100) : 0;
    const closeRateEl = document.getElementById('dash-close-rate');
    if (closeRateEl) closeRateEl.textContent = closeRate;

    // Priority Actions
    const priorityEl = document.getElementById('dash-priority-actions');
    if (priorityEl) {
      const actions = [];

      // Overdue invoices
      overdue.forEach(inv => {
        const daysOverdue = Math.floor((new Date() - new Date(inv.dueDate)) / (1000 * 60 * 60 * 24));
        actions.push({
          type: 'invoice',
          priority: 'high',
          text: `Invoice #${inv.number} to ${inv.client} is ${daysOverdue} days overdue ($${inv.total?.toLocaleString()})`,
          action: `<button onclick="sendInvoiceReminder('${inv.id}')" class="text-xs text-bronze hover:underline">Send Reminder</button>`
        });
      });

      // Leads needing follow-up
      const followupLeads = leads.filter(l => l.followupDate && l.followupDate <= today && l.stage !== 'won' && l.stage !== 'lost');
      followupLeads.forEach(lead => {
        actions.push({
          type: 'lead',
          priority: 'medium',
          text: `Follow up with ${lead.firstName} ${lead.lastName} (${lead.phone})`,
          action: `<button onclick="markFollowupDone('${lead.id}')" class="text-xs text-bronze hover:underline">Mark Done</button>`
        });
      });

      // Quarterly tax reminder (Q1: Apr 15, Q2: Jun 15, Q3: Sep 15, Q4: Jan 15)
      const quarterlyDates = [
        { month: 0, day: 15, label: 'Q4' },
        { month: 3, day: 15, label: 'Q1' },
        { month: 5, day: 15, label: 'Q2' },
        { month: 8, day: 15, label: 'Q3' }
      ];
      const now = new Date();
      quarterlyDates.forEach(qd => {
        const dueDate = new Date(now.getFullYear(), qd.month, qd.day);
        if (dueDate < now) dueDate.setFullYear(dueDate.getFullYear() + 1);
        const daysUntil = Math.floor((dueDate - now) / (1000 * 60 * 60 * 24));
        if (daysUntil <= 14) {
          actions.push({
            type: 'tax',
            priority: daysUntil <= 3 ? 'high' : 'medium',
            text: `${qd.label} estimated taxes due in ${daysUntil} days (${dueDate.toLocaleDateString()})`,
            action: `<button onclick="switchTab('accounting')" class="text-xs text-bronze hover:underline">View Accounting</button>`
          });
        }
      });

      if (actions.length === 0) {
        priorityEl.innerHTML = '<p class="text-green-600 text-sm flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> All caught up! No urgent items.</p>';
      } else {
        priorityEl.innerHTML = actions.map(a => `
          <div class="flex items-center justify-between py-2 ${a.priority === 'high' ? 'bg-red-50 -mx-4 px-4' : ''}">
            <span class="text-sm text-charcoal">${a.text}</span>
            ${a.action}
          </div>
        `).join('');
      }
    }

    // Today's Tasks
    const todayTasks = tasks.filter(t => t.dueDate === today && !t.completed);
    const tasksEl = document.getElementById('dash-tasks');
    if (tasksEl) {
      if (todayTasks.length === 0) {
        tasksEl.innerHTML = '<p class="text-charcoal/50 text-sm">No tasks for today. <button onclick="openAddTaskModal()" class="text-bronze hover:underline">Add one?</button></p>';
      } else {
        tasksEl.innerHTML = todayTasks.map(t => `
          <div class="flex items-center gap-3 py-2">
            <input type="checkbox" onchange="toggleTask('${t.id}')" class="w-4 h-4 text-bronze focus:ring-bronze border-stone/50" />
            <span class="text-sm text-charcoal ${t.priority === 'urgent' ? 'font-medium text-red-600' : ''}">${t.title}</span>
            ${t.priority === 'urgent' ? '<span class="text-xs bg-red-100 text-red-600 px-1 rounded">URGENT</span>' : ''}
          </div>
        `).join('');
      }
    }

    // Upcoming Deadlines
    const deadlinesEl = document.getElementById('dash-deadlines');
    if (deadlinesEl) {
      const deadlines = [];

      // Invoice due dates
      unpaidInvoices.filter(i => !overdue.includes(i)).slice(0, 3).forEach(inv => {
        const daysUntil = Math.floor((new Date(inv.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
        deadlines.push({ date: inv.dueDate, text: `Invoice #${inv.number} due`, days: daysUntil });
      });

      // Scheduled site visits from leads
      leads.filter(l => l.stage === 'visit' && l.visitDate).forEach(lead => {
        deadlines.push({ date: lead.visitDate, text: `Site visit: ${lead.firstName} ${lead.lastName}`, days: 0 });
      });

      deadlines.sort((a, b) => a.date.localeCompare(b.date));

      if (deadlines.length === 0) {
        deadlinesEl.innerHTML = '<p class="text-charcoal/50 text-sm">No upcoming deadlines</p>';
      } else {
        deadlinesEl.innerHTML = deadlines.slice(0, 5).map(d => `
          <div class="flex justify-between items-center text-sm">
            <span class="text-charcoal">${d.text}</span>
            <span class="text-charcoal/50 text-xs">${new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
          </div>
        `).join('');
      }
    }
  }

  function switchTab(tabId) {
    // Trigger tab switch
    const tabBtn = document.querySelector(`[data-tab="${tabId}"]`);
    if (tabBtn) tabBtn.click();
  }

  // ===== LEADS / CRM =====
  let leadsData = JSON.parse(localStorage.getItem('ohp-leads') || '[]');

  function saveLeadsData() {
    localStorage.setItem('ohp-leads', JSON.stringify(leadsData));
    renderLeadsPipeline();
    updateDashboard();
  }

  function openNewLeadModal() {
    document.getElementById('lead-modal').classList.remove('hidden');
    // Set default follow-up to 3 days from now
    const followupDate = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    document.getElementById('lead-followup').value = followupDate;
  }

  function closeLeadModal() {
    document.getElementById('lead-modal').classList.add('hidden');
    // Clear form
    ['lead-firstname', 'lead-lastname', 'lead-email', 'lead-phone', 'lead-address',
     'lead-project-type', 'lead-value', 'lead-source', 'lead-notes', 'lead-followup'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = el.tagName === 'SELECT' ? '' : '';
    });
  }

  function saveLead() {
    const lead = {
      id: crypto.randomUUID(),
      firstName: document.getElementById('lead-firstname').value,
      lastName: document.getElementById('lead-lastname').value,
      email: document.getElementById('lead-email').value,
      phone: document.getElementById('lead-phone').value,
      address: document.getElementById('lead-address').value,
      projectType: document.getElementById('lead-project-type').value,
      value: parseFloat(document.getElementById('lead-value').value) || 0,
      source: document.getElementById('lead-source').value,
      notes: document.getElementById('lead-notes').value,
      followupDate: document.getElementById('lead-followup').value,
      stage: 'new',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    if (!lead.firstName || !lead.phone) {
      alert('Please enter at least a first name and phone number.');
      return;
    }

    leadsData.push(lead);
    saveLeadsData();
    closeLeadModal();
    logActivity('lead', `New lead added: ${lead.firstName} ${lead.lastName}`);
  }

  function updateLeadStage(leadId, newStage) {
    const lead = leadsData.find(l => l.id === leadId);
    if (lead) {
      lead.stage = newStage;
      lead.updatedAt = new Date().toISOString();
      saveLeadsData();
      logActivity('lead', `${lead.firstName} ${lead.lastName} moved to ${newStage}`);
    }
  }

  function renderLeadsPipeline() {
    const stages = ['new', 'contacted', 'visit', 'quoted'];
    const stageContainers = {
      new: document.getElementById('pipeline-new'),
      contacted: document.getElementById('pipeline-contacted'),
      visit: document.getElementById('pipeline-visit'),
      quoted: document.getElementById('pipeline-quoted')
    };

    // Clear and render
    Object.values(stageContainers).forEach(c => { if (c) c.innerHTML = ''; });

    const stageCounts = { new: 0, contacted: 0, visit: 0, quoted: 0, won: 0, lost: 0 };
    let pipelineValue = 0;
    let weightedValue = 0;
    const stageWeights = { new: 0.1, contacted: 0.25, visit: 0.5, quoted: 0.75 };

    leadsData.forEach(lead => {
      stageCounts[lead.stage] = (stageCounts[lead.stage] || 0) + 1;

      if (lead.stage !== 'won' && lead.stage !== 'lost') {
        pipelineValue += lead.value || 0;
        weightedValue += (lead.value || 0) * (stageWeights[lead.stage] || 0);
      }

      const container = stageContainers[lead.stage];
      if (container) {
        const card = document.createElement('div');
        card.className = 'bg-cream p-3 shadow-sm cursor-pointer hover:shadow-md transition-shadow';
        card.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <p class="font-medium text-charcoal text-sm">${lead.firstName} ${lead.lastName}</p>
            ${lead.value ? `<span class="text-xs text-bronze">$${lead.value.toLocaleString()}</span>` : ''}
          </div>
          <p class="text-xs text-charcoal/50 mb-2">${lead.projectType || 'TBD'} · ${lead.source || 'Website'}</p>
          <div class="flex gap-1">
            ${stages.indexOf(lead.stage) > 0 ? `<button onclick="event.stopPropagation(); updateLeadStage('${lead.id}', '${stages[stages.indexOf(lead.stage) - 1]}')" class="text-xs px-2 py-1 bg-stone/30 hover:bg-stone/50 rounded">←</button>` : ''}
            ${stages.indexOf(lead.stage) < stages.length - 1 ? `<button onclick="event.stopPropagation(); updateLeadStage('${lead.id}', '${stages[stages.indexOf(lead.stage) + 1]}')" class="text-xs px-2 py-1 bg-bronze/20 hover:bg-bronze/30 rounded">→</button>` : ''}
            <button onclick="event.stopPropagation(); updateLeadStage('${lead.id}', 'won')" class="text-xs px-2 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded ml-auto">Won</button>
            <button onclick="event.stopPropagation(); updateLeadStage('${lead.id}', 'lost')" class="text-xs px-2 py-1 bg-red-100 hover:bg-red-200 text-red-700 rounded">Lost</button>
          </div>
        `;
        container.appendChild(card);
      }
    });

    // Update counts
    Object.keys(stageCounts).forEach(stage => {
      const el = document.getElementById(`lead-count-${stage}`);
      if (el) el.textContent = stageCounts[stage];
    });

    // Update values
    const pipelineEl = document.getElementById('lead-pipeline-value');
    if (pipelineEl) pipelineEl.textContent = pipelineValue.toLocaleString();
    const weightedEl = document.getElementById('lead-weighted-value');
    if (weightedEl) weightedEl.textContent = Math.round(weightedValue).toLocaleString();
  }

  function initLeads() {
    renderLeadsPipeline();
  }

  // ===== INVOICING =====
  let invoicesData = JSON.parse(localStorage.getItem('ohp-invoices') || '[]');

  function saveInvoicesData() {
    localStorage.setItem('ohp-invoices', JSON.stringify(invoicesData));
    renderInvoices();
    updateDashboard();
  }

  function openNewInvoiceModal() {
    document.getElementById('invoice-modal').classList.remove('hidden');
    // Set defaults
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('inv-date').value = today;
    document.getElementById('inv-number').value = `INV-${Date.now().toString().slice(-6)}`;
    // Due date 30 days out
    const dueDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    document.getElementById('inv-due-date').value = dueDate;

    // Populate client list from projects
    const projects = JSON.parse(localStorage.getItem('ohp-projects') || '[]');
    const clientList = document.getElementById('client-list');
    if (clientList) {
      clientList.innerHTML = [...new Set(projects.map(p => p.client))].map(c => `<option value="${c}">`).join('');
    }
  }

  function closeInvoiceModal() {
    document.getElementById('invoice-modal').classList.add('hidden');
  }

  function addLineItem() {
    const container = document.getElementById('inv-line-items');
    const row = document.createElement('div');
    row.className = 'grid grid-cols-12 gap-2 items-center';
    row.innerHTML = `
      <input type="text" class="col-span-6 px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="Description" />
      <input type="number" class="col-span-2 px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="Qty" value="1" />
      <input type="number" class="col-span-3 px-3 py-2 border border-stone/50 focus:border-bronze focus:outline-none text-sm" placeholder="Amount" />
      <button onclick="removeLineItem(this)" class="col-span-1 text-red-500 hover:text-red-700">×</button>
    `;
    container.appendChild(row);
  }

  function removeLineItem(btn) {
    btn.closest('.grid').remove();
    updateInvoiceTotal();
  }

  function updateInvoiceTotal() {
    const rows = document.querySelectorAll('#inv-line-items .grid');
    let subtotal = 0;
    rows.forEach(row => {
      const qty = parseFloat(row.querySelector('input:nth-child(2)')?.value) || 1;
      const amount = parseFloat(row.querySelector('input:nth-child(3)')?.value) || 0;
      subtotal += qty * amount;
    });
    document.getElementById('inv-subtotal').value = subtotal.toFixed(2);
    const taxRate = parseFloat(document.getElementById('inv-tax-rate').value) || 0;
    const total = subtotal * (1 + taxRate / 100);
    document.getElementById('inv-total').value = total.toFixed(2);
  }

  function saveInvoiceDraft() {
    saveInvoice('draft');
  }

  function saveAndSendInvoice() {
    saveInvoice('sent');
  }

  function saveInvoice(status) {
    // Collect line items
    const lineItems = [];
    document.querySelectorAll('#inv-line-items .grid').forEach(row => {
      const desc = row.querySelector('input:nth-child(1)')?.value || '';
      const qty = parseFloat(row.querySelector('input:nth-child(2)')?.value) || 1;
      const amount = parseFloat(row.querySelector('input:nth-child(3)')?.value) || 0;
      if (desc || amount > 0) {
        lineItems.push({ description: desc, qty, amount, lineTotal: qty * amount });
      }
    });

    const invoice = {
      id: crypto.randomUUID(),
      number: document.getElementById('inv-number').value,
      date: document.getElementById('inv-date').value,
      client: document.getElementById('inv-client').value,
      clientPhone: document.getElementById('inv-client-phone')?.value || '',
      clientEmail: document.getElementById('inv-client-email')?.value || '',
      clientAddress: document.getElementById('inv-client-address')?.value || '',
      jobAddress: document.getElementById('inv-job-address')?.value || '',
      project: document.getElementById('inv-project').value,
      lineItems: lineItems,
      subtotal: parseFloat(document.getElementById('inv-subtotal').value) || 0,
      taxRate: parseFloat(document.getElementById('inv-tax-rate').value) || 0,
      total: parseFloat(document.getElementById('inv-total').value) || 0,
      dueDate: document.getElementById('inv-due-date').value,
      terms: document.getElementById('inv-terms').value,
      notes: document.getElementById('inv-notes').value,
      status: status,
      createdAt: new Date().toISOString()
    };

    if (!invoice.client) {
      alert('Please enter a client name.');
      return;
    }

    invoicesData.push(invoice);
    saveInvoicesData();
    closeInvoiceModal();
    logActivity('invoice', `Invoice #${invoice.number} created for ${invoice.client} ($${invoice.total.toLocaleString()})`);

    // If sending, offer to email/SMS
    if (status === 'sent' && (invoice.clientEmail || invoice.clientPhone)) {
      const sendMethod = invoice.clientEmail ? 'email' : 'SMS';
      if (confirm(`Send invoice to ${invoice.client} via ${sendMethod}?`)) {
        if (invoice.clientEmail) {
          emailInvoice(invoice);
        } else {
          smsInvoiceReminder(invoice);
        }
      }
    }
  }

  // ===== SMS & EMAIL NOTIFICATIONS =====
  const DARAGH_PHONE = '1-860-574-7004';

  async function sendSMSNotification(to, message) {
    try {
      const response = await fetch('/api/sms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to, message })
      });
      const result = await response.json();
      if (result.success) {
        logActivity('sms', `SMS sent to ${to}`);
        return true;
      } else {
        console.error('SMS failed:', result.error);
        return false;
      }
    } catch (err) {
      console.error('SMS error:', err);
      // Fallback to native SMS app
      window.location.href = `sms:${to}?body=${encodeURIComponent(message)}`;
      return false;
    }
  }

  function smsInvoiceReminder(invoice) {
    const message = `Hi ${invoice.client}! This is a reminder from Old Head Plaster. Invoice #${invoice.number} for $${invoice.total.toLocaleString()} is due ${new Date(invoice.dueDate).toLocaleDateString()}. Questions? Reply or call (860) 574-7004. - Daragh`;
    if (invoice.clientPhone) {
      sendSMSNotification(invoice.clientPhone, message);
    } else {
      alert('No phone number on file for this client.');
    }
  }

  function emailInvoice(invoice) {
    const subject = encodeURIComponent(`Invoice #${invoice.number} from Old Head Plaster`);
    const body = encodeURIComponent(`Hi ${invoice.client},

Please find attached Invoice #${invoice.number} for $${invoice.total.toLocaleString()}.

Project: ${invoice.project || 'Decorative Plaster Work'}
Due Date: ${new Date(invoice.dueDate).toLocaleDateString()}

Payment Terms: ${invoice.terms}

${invoice.notes || 'Thank you for your business!'}

Best regards,
Daragh McLoughlin
Old Head Plaster
(860) 574-7004`);

    window.location.href = `mailto:${invoice.clientEmail}?subject=${subject}&body=${body}`;
  }

  function sendInvoiceReminder(invId) {
    const inv = invoicesData.find(i => i.id === invId);
    if (!inv) return;

    if (inv.clientPhone) {
      smsInvoiceReminder(inv);
    } else if (inv.clientEmail) {
      emailInvoice(inv);
    } else {
      alert(`No contact info on file for ${inv.client}. Add phone or email to send reminder.`);
    }
  }

  function sendBulkReminders() {
    const today = new Date().toISOString().split('T')[0];
    const overdue = invoicesData.filter(i => i.status !== 'paid' && i.dueDate < today);

    if (overdue.length === 0) {
      alert('No overdue invoices to send reminders for.');
      return;
    }

    if (!confirm(`Send reminders for ${overdue.length} overdue invoice(s)?`)) return;

    let sent = 0;
    overdue.forEach(inv => {
      if (inv.clientPhone || inv.clientEmail) {
        sendInvoiceReminder(inv.id);
        sent++;
      }
    });

    alert(`Reminders initiated for ${sent} of ${overdue.length} overdue invoices.`);
  }

  // Send daily summary to Daragh
  async function sendDailySummaryToOwner() {
    const tasks = JSON.parse(localStorage.getItem('ohp-tasks') || '[]');
    const invoices = JSON.parse(localStorage.getItem('ohp-invoices') || '[]');
    const leads = JSON.parse(localStorage.getItem('ohp-leads') || '[]');
    const today = new Date().toISOString().split('T')[0];

    const todayTasks = tasks.filter(t => t.dueDate === today && !t.completed);
    const overdueInvoices = invoices.filter(i => i.status !== 'paid' && i.dueDate < today);
    const followups = leads.filter(l => l.followupDate && l.followupDate <= today && l.stage !== 'won' && l.stage !== 'lost');

    let message = `Good morning Daragh! Here's your daily summary:\n\n`;

    if (todayTasks.length > 0) {
      message += `📋 TASKS TODAY (${todayTasks.length}):\n`;
      todayTasks.slice(0, 3).forEach(t => {
        message += `• ${t.title}\n`;
      });
      if (todayTasks.length > 3) message += `...and ${todayTasks.length - 3} more\n`;
      message += '\n';
    }

    if (overdueInvoices.length > 0) {
      const overdueTotal = overdueInvoices.reduce((sum, i) => sum + i.total, 0);
      message += `💰 OVERDUE INVOICES: ${overdueInvoices.length} ($${overdueTotal.toLocaleString()})\n\n`;
    }

    if (followups.length > 0) {
      message += `📞 FOLLOW-UPS NEEDED: ${followups.length}\n`;
      followups.slice(0, 2).forEach(l => {
        message += `• ${l.firstName} ${l.lastName}\n`;
      });
    }

    if (todayTasks.length === 0 && overdueInvoices.length === 0 && followups.length === 0) {
      message = `Good morning Daragh! All clear today - no urgent tasks, no overdue invoices, no pending follow-ups. Have a great day!`;
    }

    await sendSMSNotification(DARAGH_PHONE, message);
  }

  function renderInvoices() {
    const container = document.getElementById('invoice-list');
    if (!container) return;

    const filter = document.getElementById('inv-filter')?.value || 'all';
    const today = new Date().toISOString().split('T')[0];

    let filtered = invoicesData;
    if (filter === 'overdue') {
      filtered = invoicesData.filter(i => i.status !== 'paid' && i.dueDate < today);
    } else if (filter !== 'all') {
      filtered = invoicesData.filter(i => i.status === filter);
    }

    // Sort by date descending
    filtered.sort((a, b) => b.date.localeCompare(a.date));

    // Calculate AR aging and average days to pay
    let arCurrent = 0, ar30 = 0, ar60 = 0, ar90 = 0, ar90plus = 0;
    let totalYtd = 0, totalPaid = 0, totalOutstanding = 0, totalOverdue = 0;
    let totalDaysToPay = 0, paidCount = 0;

    invoicesData.forEach(inv => {
      totalYtd += inv.total;
      if (inv.status === 'paid') {
        totalPaid += inv.total;
        // Calculate days to pay for paid invoices
        if (inv.paidDate && inv.date) {
          const daysToPay = Math.floor((new Date(inv.paidDate) - new Date(inv.date)) / (1000 * 60 * 60 * 24));
          if (daysToPay >= 0) {
            totalDaysToPay += daysToPay;
            paidCount++;
          }
        }
      } else {
        totalOutstanding += inv.total;
        const daysOverdue = Math.floor((new Date() - new Date(inv.dueDate)) / (1000 * 60 * 60 * 24));
        if (daysOverdue <= 0) arCurrent += inv.total;
        else if (daysOverdue <= 30) { ar30 += inv.total; totalOverdue += inv.total; }
        else if (daysOverdue <= 60) { ar60 += inv.total; totalOverdue += inv.total; }
        else if (daysOverdue <= 90) { ar90 += inv.total; totalOverdue += inv.total; }
        else { ar90plus += inv.total; totalOverdue += inv.total; }
      }
    });

    const avgDaysToPay = paidCount > 0 ? Math.round(totalDaysToPay / paidCount) : 0;

    // Update summary
    document.getElementById('inv-total-ytd').textContent = totalYtd.toLocaleString();
    document.getElementById('inv-total-paid').textContent = totalPaid.toLocaleString();
    document.getElementById('inv-outstanding').textContent = totalOutstanding.toLocaleString();
    document.getElementById('inv-overdue').textContent = totalOverdue.toLocaleString();
    const avgDaysEl = document.getElementById('inv-avg-days');
    if (avgDaysEl) avgDaysEl.textContent = avgDaysToPay;
    document.getElementById('ar-current').textContent = arCurrent.toLocaleString();
    document.getElementById('ar-30').textContent = ar30.toLocaleString();
    document.getElementById('ar-60').textContent = ar60.toLocaleString();
    document.getElementById('ar-90').textContent = ar90.toLocaleString();
    document.getElementById('ar-90plus').textContent = ar90plus.toLocaleString();

    // Show/hide overdue actions section
    const overdueActionsEl = document.getElementById('overdue-actions');
    if (overdueActionsEl) {
      overdueActionsEl.style.display = totalOverdue > 0 ? 'block' : 'none';
    }

    if (filtered.length === 0) {
      container.innerHTML = '<div class="p-4 text-charcoal/50 text-sm">No invoices match the filter.</div>';
      return;
    }

    container.innerHTML = filtered.map(inv => {
      const isOverdue = inv.status !== 'paid' && inv.dueDate < today;
      const daysOverdue = isOverdue ? Math.floor((new Date() - new Date(inv.dueDate)) / (1000 * 60 * 60 * 24)) : 0;
      const statusColors = {
        draft: 'bg-stone text-charcoal/70',
        sent: 'bg-blue-100 text-blue-700',
        paid: 'bg-green-100 text-green-700',
        overdue: 'bg-red-100 text-red-700'
      };
      const displayStatus = isOverdue ? 'overdue' : inv.status;
      const hasContact = inv.clientPhone || inv.clientEmail;

      return `
        <div class="p-4 hover:bg-stone/30 transition-colors ${isOverdue ? 'border-l-4 border-red-500' : ''}">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div>
                <p class="font-medium text-charcoal">#${inv.number}</p>
                <p class="text-xs text-charcoal/50">${inv.date}</p>
              </div>
              <div>
                <p class="text-charcoal">${inv.client}</p>
                <p class="text-xs text-charcoal/50">${inv.project || 'General'}</p>
                ${hasContact ? `<p class="text-xs text-charcoal/40 flex items-center gap-1">
                  ${inv.clientPhone ? '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>' : ''}
                  ${inv.clientEmail ? '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>' : ''}
                </p>` : ''}
              </div>
            </div>
            <div class="flex items-center gap-4">
              <div class="text-right">
                <p class="font-heading text-charcoal">$${inv.total.toLocaleString()}</p>
                ${isOverdue ?
                  `<p class="text-xs text-red-600 font-medium">${daysOverdue} days overdue</p>` :
                  `<p class="text-xs text-charcoal/50">Due ${new Date(inv.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>`
                }
              </div>
              <span class="text-xs uppercase px-2 py-1 rounded ${statusColors[displayStatus] || statusColors.draft}">${displayStatus}</span>
              ${inv.status !== 'paid' ? `
                <div class="flex items-center gap-2">
                  ${isOverdue && hasContact ? `
                    <button onclick="sendInvoiceReminder('${inv.id}')" class="text-xs bg-bronze text-charcoal px-2 py-1 hover:bg-bronze/80 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                      </svg>
                      Send Reminder
                    </button>
                  ` : ''}
                  <button onclick="markInvoicePaid('${inv.id}')" class="text-xs text-green-600 hover:text-green-800 px-2 py-1 border border-green-200 hover:bg-green-50">Mark Paid</button>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function markInvoicePaid(invId) {
    const inv = invoicesData.find(i => i.id === invId);
    if (inv) {
      inv.status = 'paid';
      inv.paidDate = new Date().toISOString();
      saveInvoicesData();
      logActivity('invoice', `Invoice #${inv.number} marked as paid`);
    }
  }

  function initInvoices() {
    renderInvoices();
    // Add event listeners
    document.getElementById('inv-filter')?.addEventListener('change', renderInvoices);
    document.getElementById('inv-tax-rate')?.addEventListener('input', updateInvoiceTotal);
    document.getElementById('inv-line-items')?.addEventListener('input', updateInvoiceTotal);
  }

  // ===== TASKS =====
  let tasksData = JSON.parse(localStorage.getItem('ohp-tasks') || '[]');

  function saveTasksData() {
    localStorage.setItem('ohp-tasks', JSON.stringify(tasksData));
    updateDashboard();
  }

  function openAddTaskModal() {
    document.getElementById('task-modal').classList.remove('hidden');
    document.getElementById('task-due').value = new Date().toISOString().split('T')[0];
  }

  function closeTaskModal() {
    document.getElementById('task-modal').classList.add('hidden');
  }

  function saveTask() {
    const task = {
      id: crypto.randomUUID(),
      title: document.getElementById('task-title').value,
      dueDate: document.getElementById('task-due').value,
      priority: document.getElementById('task-priority').value,
      related: document.getElementById('task-related').value,
      completed: false,
      createdAt: new Date().toISOString()
    };

    if (!task.title) {
      alert('Please enter a task.');
      return;
    }

    tasksData.push(task);
    saveTasksData();
    closeTaskModal();
    document.getElementById('task-title').value = '';
  }

  function toggleTask(taskId) {
    const task = tasksData.find(t => t.id === taskId);
    if (task) {
      task.completed = !task.completed;
      task.completedAt = task.completed ? new Date().toISOString() : null;
      saveTasksData();
    }
  }

  // ===== EXPENSES =====
  function openQuickExpenseModal() {
    document.getElementById('expense-modal').classList.remove('hidden');
    document.getElementById('exp-date').value = new Date().toISOString().split('T')[0];

    // Populate projects dropdown
    const projects = JSON.parse(localStorage.getItem('ohp-projects') || '[]');
    const projectSelect = document.getElementById('exp-project');
    if (projectSelect) {
      projectSelect.innerHTML = '<option value="">General / Overhead</option>' +
        projects.map(p => `<option value="${p.id}">${p.name} - ${p.client}</option>`).join('');
    }
  }

  function closeExpenseModal() {
    document.getElementById('expense-modal').classList.add('hidden');
  }

  function saveExpense() {
    const category = document.getElementById('exp-category').value;
    const isMileage = category === 'mileage';
    const miles = parseFloat(document.getElementById('exp-miles')?.value) || 0;
    const amount = isMileage ? miles * 0.67 : parseFloat(document.getElementById('exp-amount').value) || 0;

    const expense = {
      id: crypto.randomUUID(),
      category: category,
      amount: amount,
      miles: isMileage ? miles : null,
      date: document.getElementById('exp-date').value,
      description: document.getElementById('exp-description').value,
      project: document.getElementById('exp-project').value,
      createdAt: new Date().toISOString()
    };

    // Save to expenses list
    let expenses = JSON.parse(localStorage.getItem('ohp-expenses') || '[]');
    expenses.push(expense);
    localStorage.setItem('ohp-expenses', JSON.stringify(expenses));

    // Update accounting fields based on category
    const categoryToField = {
      materials: 'acct-exp-materials',
      tools: 'acct-exp-tools',
      vehicle: 'acct-exp-vehicle',
      insurance: 'acct-exp-insurance',
      professional: 'acct-exp-professional',
      marketing: 'acct-exp-marketing',
      travel: 'acct-exp-travel',
      meals: 'acct-exp-meals',
      phone: 'acct-exp-phone',
      other: 'acct-exp-other'
    };

    if (isMileage) {
      const mileageEl = document.getElementById('acct-mileage-total');
      if (mileageEl) mileageEl.value = (parseFloat(mileageEl.value) || 0) + miles;
    } else if (categoryToField[category]) {
      const fieldEl = document.getElementById(categoryToField[category]);
      if (fieldEl) fieldEl.value = (parseFloat(fieldEl.value) || 0) + amount;
    }

    closeExpenseModal();
    logActivity('expense', `Logged $${amount.toFixed(2)} expense (${category})`);

    // Trigger accounting update if function exists
    if (typeof updateAccounting === 'function') updateAccounting();
  }

  // Handle mileage category toggle
  document.getElementById('exp-category')?.addEventListener('change', function() {
    const isMileage = this.value === 'mileage';
    document.getElementById('exp-mileage-fields').style.display = isMileage ? 'block' : 'none';
    document.getElementById('exp-amount-field').style.display = isMileage ? 'none' : 'block';
  });

  document.getElementById('exp-miles')?.addEventListener('input', function() {
    const miles = parseFloat(this.value) || 0;
    document.getElementById('exp-mileage-calc').textContent = (miles * 0.67).toFixed(2);
  });

  // ===== ACTIVITY LOG =====
  function logActivity(type, message) {
    let activity = JSON.parse(localStorage.getItem('ohp-activity') || '[]');
    activity.unshift({
      type: type,
      message: message,
      timestamp: new Date().toISOString()
    });
    // Keep last 50 items
    activity = activity.slice(0, 50);
    localStorage.setItem('ohp-activity', JSON.stringify(activity));
    renderActivity();
  }

  function renderActivity() {
    const container = document.getElementById('dash-activity');
    if (!container) return;

    const activity = JSON.parse(localStorage.getItem('ohp-activity') || '[]');
    if (activity.length === 0) {
      container.innerHTML = '<p class="text-charcoal/50 text-sm">No recent activity</p>';
      return;
    }

    container.innerHTML = activity.slice(0, 5).map(a => {
      const timeAgo = getTimeAgo(new Date(a.timestamp));
      const icons = {
        lead: '<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>',
        invoice: '<svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>',
        expense: '<svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2z" /></svg>',
        project: '<svg class="w-4 h-4 text-bronze" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>'
      };
      return `
        <div class="flex items-start gap-3 py-2 border-b border-stone/20 last:border-0">
          ${icons[a.type] || icons.project}
          <div class="flex-1">
            <p class="text-sm text-charcoal">${a.message}</p>
            <p class="text-xs text-charcoal/50">${timeAgo}</p>
          </div>
        </div>
      `;
    }).join('');
  }

  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'Just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
  }

  // ===== REMINDERS =====
  function openRemindersPanel() {
    document.getElementById('reminders-panel').classList.remove('translate-x-full');
    loadReminders();
  }

  function closeRemindersPanel() {
    document.getElementById('reminders-panel').classList.add('translate-x-full');
  }

  function loadReminders() {
    const container = document.getElementById('reminders-list');
    if (!container) return;

    const reminders = generateSmartReminders();

    if (reminders.length === 0) {
      container.innerHTML = '<p class="text-charcoal/50 text-sm text-center py-8">No reminders at this time.</p>';
      return;
    }

    container.innerHTML = reminders.map(r => `
      <div class="p-3 bg-${r.color}-50 border-l-4 border-${r.color}-500">
        <div class="flex items-start gap-3">
          <span class="text-${r.color}-500">${r.icon}</span>
          <div class="flex-1">
            <p class="text-sm font-medium text-charcoal">${r.title}</p>
            <p class="text-xs text-charcoal/70 mt-1">${r.message}</p>
            ${r.action ? `<button onclick="${r.action}" class="mt-2 text-xs text-${r.color}-600 hover:underline">${r.actionText}</button>` : ''}
          </div>
        </div>
      </div>
    `).join('');
  }

  function generateSmartReminders() {
    const reminders = [];
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];

    // Quarterly tax reminders
    const quarterlyDates = [
      { month: 0, day: 15, quarter: 'Q4' },
      { month: 3, day: 15, quarter: 'Q1' },
      { month: 5, day: 15, quarter: 'Q2' },
      { month: 8, day: 15, quarter: 'Q3' }
    ];

    quarterlyDates.forEach(qd => {
      const dueDate = new Date(today.getFullYear(), qd.month, qd.day);
      if (dueDate < today) dueDate.setFullYear(dueDate.getFullYear() + 1);
      const daysUntil = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));

      if (daysUntil <= 30) {
        reminders.push({
          color: daysUntil <= 7 ? 'red' : 'yellow',
          icon: '📅',
          title: `${qd.quarter} Estimated Taxes Due`,
          message: `Due in ${daysUntil} days (${dueDate.toLocaleDateString()})`,
          action: "switchTab('accounting')",
          actionText: 'View Tax Summary'
        });
      }
    });

    // Overdue invoices
    const invoices = JSON.parse(localStorage.getItem('ohp-invoices') || '[]');
    invoices.filter(i => i.status !== 'paid' && i.dueDate < todayStr).forEach(inv => {
      reminders.push({
        color: 'red',
        icon: '💰',
        title: `Invoice #${inv.number} Overdue`,
        message: `${inv.client} owes $${inv.total.toLocaleString()}`,
        action: `sendInvoiceReminder('${inv.id}')`,
        actionText: 'Send Reminder'
      });
    });

    // Lead follow-ups
    const leads = JSON.parse(localStorage.getItem('ohp-leads') || '[]');
    leads.filter(l => l.followupDate && l.followupDate <= todayStr && l.stage !== 'won' && l.stage !== 'lost').forEach(lead => {
      reminders.push({
        color: 'blue',
        icon: '📞',
        title: `Follow up: ${lead.firstName} ${lead.lastName}`,
        message: lead.phone,
        action: "switchTab('leads')",
        actionText: 'View Lead'
      });
    });

    return reminders;
  }

  // ===== HIRING CALCULATOR =====
  function openHiringCalculator() {
    document.getElementById('hiring-modal').classList.remove('hidden');
    // Pre-populate from accounting data if available
    const projects = JSON.parse(localStorage.getItem('ohp-projects') || '[]');
    const completedThisYear = projects.filter(p => {
      const completed = p.completedAt || p.createdAt || '';
      return p.status === 'completed' && completed.startsWith(new Date().getFullYear().toString());
    });
    const totalRevenue = completedThisYear.reduce((sum, p) => sum + (p.value || 0), 0);
    const monthsElapsed = new Date().getMonth() + 1;
    const avgMonthlyRevenue = Math.round(totalRevenue / monthsElapsed);
    if (avgMonthlyRevenue > 0) {
      document.getElementById('hire-revenue').value = avgMonthlyRevenue;
    }
  }

  function closeHiringCalculator() {
    document.getElementById('hiring-modal').classList.add('hidden');
  }

  function calculateHiring() {
    const revenue = parseFloat(document.getElementById('hire-revenue').value) || 0;
    const hours = parseFloat(document.getElementById('hire-hours').value) || 40;
    const declined = parseFloat(document.getElementById('hire-declined').value) || 0;
    const waitDays = parseFloat(document.getElementById('hire-wait').value) || 0;

    const monthlyHours = hours * 4.33;
    const revenuePerHour = revenue / monthlyHours;
    const avgJobValue = revenue / 4; // Assume ~4 jobs/month
    const opportunityCost = declined * avgJobValue;

    document.getElementById('hire-per-hour').textContent = `$${revenuePerHour.toFixed(0)}`;
    document.getElementById('hire-opportunity').textContent = `$${opportunityCost.toLocaleString()}/mo`;

    // Scoring
    let score = 0;
    let reasons = [];

    if (hours >= 50) { score += 3; reasons.push('Working 50+ hours/week'); }
    else if (hours >= 45) { score += 2; reasons.push('Working 45+ hours/week'); }

    if (declined >= 3) { score += 3; reasons.push('Turning away 3+ jobs/month'); }
    else if (declined >= 1) { score += 1; reasons.push('Turning away some jobs'); }

    if (waitDays >= 21) { score += 3; reasons.push('Lead wait time 3+ weeks'); }
    else if (waitDays >= 14) { score += 1; reasons.push('Lead wait time 2+ weeks'); }

    if (revenue >= 20000) { score += 2; reasons.push('Strong revenue base'); }
    else if (revenue >= 15000) { score += 1; reasons.push('Solid revenue base'); }

    // Verdict
    const verdictEl = document.getElementById('hiring-verdict');
    let verdict, verdictClass;

    if (score >= 7) {
      verdict = "READY TO HIRE NOW";
      verdictClass = "bg-green-100 text-green-700";
    } else if (score >= 4) {
      verdict = "CONSIDER HIRING SOON";
      verdictClass = "bg-yellow-100 text-yellow-700";
    } else {
      verdict = "NOT YET - KEEP GROWING";
      verdictClass = "bg-stone text-charcoal";
    }

    verdictEl.className = `p-4 rounded ${verdictClass}`;
    verdictEl.innerHTML = `<p class="text-lg font-heading">${verdict}</p><p class="text-sm mt-1">${reasons.join(' • ')}</p>`;

    // Recommendation
    let recommendation, reasoning;
    if (hours >= 50 && declined >= 2) {
      recommendation = "Part-time Prep Assistant (15-20 hrs/week)";
      reasoning = "Offload surface prep, taping, and cleanup to focus your skills on the actual plaster application. Start with day-rate helpers on specific jobs.";
    } else if (revenue >= 20000) {
      recommendation = "Administrative Support (Part-time)";
      reasoning = "With strong revenue, your time is better spent on client work. Consider virtual assistant for quotes, scheduling, and follow-ups.";
    } else {
      recommendation = "Project-Based Subcontractor";
      reasoning = "Bring in help for specific larger jobs rather than ongoing employment. Keeps overhead low while building capacity.";
    }

    document.getElementById('hire-recommendation').textContent = recommendation;
    document.getElementById('hire-reasoning').textContent = reasoning;

    document.getElementById('hiring-results').classList.remove('hidden');
  }

  // ===== SUBCONTRACTOR MANAGEMENT =====
  let subcontractorsData = JSON.parse(localStorage.getItem('ohp-subcontractors') || '[]');

  function saveSubcontractorsData() {
    localStorage.setItem('ohp-subcontractors', JSON.stringify(subcontractorsData));
    renderSubcontractors();
  }

  function openSubcontractorModal() {
    document.getElementById('subcontractor-modal').classList.remove('hidden');
    // Clear form
    ['sub-name', 'sub-phone', 'sub-email', 'sub-rate', 'sub-taxid', 'sub-notes'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
  }

  function closeSubcontractorModal() {
    document.getElementById('subcontractor-modal').classList.add('hidden');
  }

  function saveSubcontractor() {
    const name = document.getElementById('sub-name').value;
    if (!name) {
      alert('Please enter a name.');
      return;
    }

    const sub = {
      id: crypto.randomUUID(),
      name: name,
      phone: document.getElementById('sub-phone').value,
      email: document.getElementById('sub-email').value,
      trade: document.getElementById('sub-trade').value,
      rate: document.getElementById('sub-rate').value,
      taxId: document.getElementById('sub-taxid').value,
      notes: document.getElementById('sub-notes').value,
      payments: [],
      ytdTotal: 0,
      createdAt: new Date().toISOString()
    };

    subcontractorsData.push(sub);
    saveSubcontractorsData();
    closeSubcontractorModal();
    logActivity('subcontractor', `Added subcontractor: ${sub.name}`);
  }

  function recordSubPayment(subId, amount, date, description) {
    const sub = subcontractorsData.find(s => s.id === subId);
    if (sub) {
      sub.payments.push({ amount, date, description, createdAt: new Date().toISOString() });
      sub.ytdTotal = sub.payments
        .filter(p => p.date.startsWith(new Date().getFullYear().toString()))
        .reduce((sum, p) => sum + p.amount, 0);
      saveSubcontractorsData();
    }
  }

  function renderSubcontractors() {
    const container = document.getElementById('dash-subcontractors');
    if (!container) return;

    if (subcontractorsData.length === 0) {
      container.innerHTML = '<p class="text-charcoal/50 text-sm">No subcontractors tracked yet</p>';
      return;
    }

    container.innerHTML = subcontractorsData.slice(0, 3).map(sub => {
      const needs1099 = sub.ytdTotal >= 600;
      return `
        <div class="flex items-center justify-between py-1">
          <div>
            <p class="text-sm text-charcoal">${sub.name}</p>
            <p class="text-xs text-charcoal/50">${sub.trade}</p>
          </div>
          <div class="text-right">
            <p class="text-sm ${needs1099 ? 'text-red-600 font-medium' : 'text-charcoal/70'}">$${sub.ytdTotal.toLocaleString()}</p>
            ${needs1099 ? '<p class="text-xs text-red-600">1099 required</p>' : ''}
          </div>
        </div>
      `;
    }).join('');

    if (subcontractorsData.length > 3) {
      container.innerHTML += `<p class="text-xs text-bronze hover:underline cursor-pointer mt-2" onclick="switchTab('accounting')">+${subcontractorsData.length - 3} more...</p>`;
    }
  }

  // ===== CASH FLOW FORECAST =====
  function updateCashFlowForecast() {
    const invoices = JSON.parse(localStorage.getItem('ohp-invoices') || '[]');
    const today = new Date();

    // Expected income from unpaid invoices due in next 90 days
    const ninetyDaysOut = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
    const expectedIncome = invoices
      .filter(i => i.status !== 'paid' && new Date(i.dueDate) <= ninetyDaysOut)
      .reduce((sum, i) => sum + i.total, 0);

    // Estimate expenses based on historical data or % of revenue
    // Using typical contractor expense ratio of 40-50% of revenue
    const estimatedExpenses = Math.round(expectedIncome * 0.45);

    const net = expectedIncome - estimatedExpenses;

    document.getElementById('forecast-income').textContent = expectedIncome.toLocaleString();
    document.getElementById('forecast-expenses').textContent = estimatedExpenses.toLocaleString();

    const netEl = document.getElementById('forecast-net');
    netEl.textContent = (net >= 0 ? '+' : '') + '$' + net.toLocaleString();
    netEl.className = `text-2xl font-heading ${net >= 0 ? 'text-green-600' : 'text-red-600'}`;

    // Monthly breakdown for visual
    const month1Income = invoices
      .filter(i => i.status !== 'paid' && new Date(i.dueDate) <= new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000))
      .reduce((sum, i) => sum + i.total, 0);
    const month2Income = invoices
      .filter(i => {
        const due = new Date(i.dueDate);
        return i.status !== 'paid' &&
          due > new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000) &&
          due <= new Date(today.getTime() + 60 * 24 * 60 * 60 * 1000);
      })
      .reduce((sum, i) => sum + i.total, 0);
    const month3Income = invoices
      .filter(i => {
        const due = new Date(i.dueDate);
        return i.status !== 'paid' &&
          due > new Date(today.getTime() + 60 * 24 * 60 * 60 * 1000) &&
          due <= ninetyDaysOut;
      })
      .reduce((sum, i) => sum + i.total, 0);

    const maxAmount = Math.max(expectedIncome, estimatedExpenses, 1);

    // Update bars (income as % of max)
    const m1In = (month1Income / maxAmount) * 50;
    const m1Out = ((month1Income * 0.45) / maxAmount) * 50;
    document.getElementById('forecast-m1-in').style.width = `${m1In}%`;
    document.getElementById('forecast-m1-out').style.width = `${m1Out}%`;

    const m2In = (month2Income / maxAmount) * 50;
    const m2Out = ((month2Income * 0.45) / maxAmount) * 50;
    document.getElementById('forecast-m2-in').style.width = `${m2In}%`;
    document.getElementById('forecast-m2-out').style.width = `${m2Out}%`;

    const m3In = (month3Income / maxAmount) * 50;
    const m3Out = ((month3Income * 0.45) / maxAmount) * 50;
    document.getElementById('forecast-m3-in').style.width = `${m3In}%`;
    document.getElementById('forecast-m3-out').style.width = `${m3Out}%`;

    // Also update the simple cash flow in sidebar
    document.getElementById('dash-cash-in').textContent = expectedIncome.toLocaleString();
    document.getElementById('dash-cash-out').textContent = estimatedExpenses.toLocaleString();
    const cashNetEl = document.getElementById('dash-cash-net');
    cashNetEl.textContent = (net >= 0 ? '+' : '') + '$' + net.toLocaleString();
    cashNetEl.className = `text-sm font-heading ${net >= 0 ? 'text-green-600' : 'text-red-600'}`;
  }

  function askAccountantScaling() {
    sendAccountantMessage("Based on my current revenue and profit margins, am I ready to hire help? What would the financial impact be of bringing on a part-time assistant or subcontractor?");
  }

  // ===== INIT =====
  document.addEventListener('DOMContentLoaded', () => {
    initAuth();
    initTabs();
    initDashboard();
    parseURLParams();
    initEstimator();
    initCostBreakdown();
    renderRooms();
    updateSummary();
    renderProjects();
    initLeads();
    initInvoices();
    initImageManager();
    initQuoteModal();
    initAccounting();
    initAccountantChat();
    renderActivity();
  });
</script>
